<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLBB Editor - Âä®ÊÄÅÈÖçÁΩÆÁÆ°ÁêÜÁ≥ªÁªü</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --sidebar-bg: #1a1d29;
            --sidebar-hover: #252936;
            --sidebar-active: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: #ffffff;
            --text-primary: #1a202c;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
            --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 0;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            margin-top: 20px;
            margin-bottom: 20px;
            min-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }

        header {
            background: var(--primary-gradient);
            color: white;
            padding: 32px 40px;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 400px;
            height: 400px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            pointer-events: none;
        }

        header::after {
            content: '';
            position: absolute;
            bottom: -30%;
            left: -5%;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 50%;
            pointer-events: none;
        }

        .header-content {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            flex: 1;
        }

        .header-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 40px;
        }

        .nav-item {
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            color: white;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            font-weight: 600;
        }

        .nav-item:active {
            transform: translateY(0);
        }

        .header-right {
            display: flex !important;
            align-items: center;
            gap: 16px;
            position: relative;
            z-index: 10;
            visibility: visible !important;
        }

        .user-info {
            display: flex !important;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            visibility: visible !important;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
        }

        .username {
            font-size: 14px;
            font-weight: 500;
            color: white;
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.25) !important;
            color: white !important;
            border: 2px solid rgba(255, 255, 255, 0.4) !important;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: inline-flex !important;
            align-items: center;
            gap: 6px;
            visibility: visible !important;
            opacity: 1 !important;
            min-width: 80px;
            text-align: center;
        }

        .btn-logout::before {
            content: 'üö™';
            font-size: 14px;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.35) !important;
            border-color: rgba(255, 255, 255, 0.6) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn-logout:active {
            transform: translateY(0);
        }

        h1 {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .subtitle {
            font-size: 16px;
            opacity: 0.95;
            font-weight: 400;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .subtitle::before {
            content: '‚ö°';
            font-size: 18px;
        }

        .main-content {
            display: flex;
            flex: 1;
            min-height: 0;
        }

        .sidebar {
            width: 320px;
            background: var(--sidebar-bg);
            color: white;
            padding: 24px;
            overflow-y: auto;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-actions {
            display: flex;
            gap: 8px;
        }

        .btn-sidebar {
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .btn-sidebar:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        /* Ê∑ªÂä†Ë∑ØÂæÑÊåâÈíÆÁâπÊÆäÊ†∑Âºè - ÊöóÈªëÁ≥ªÈ´òÁ∫ßÈ£éÊ†º */
        .btn-add-context {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 5px 12px;
            font-size: 11px;
            font-weight: 600;
            background: linear-gradient(145deg, rgba(20, 22, 28, 0.95) 0%, rgba(30, 32, 40, 0.95) 100%);
            border: 1px solid rgba(100, 108, 255, 0.3);
            border-top: 1px solid rgba(120, 130, 255, 0.4);
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.05),
                inset 0 -1px 0 rgba(0, 0, 0, 0.3),
                0 0 0 0 rgba(100, 108, 255, 0);
            color: rgba(180, 190, 255, 0.9);
            border-radius: 6px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            text-shadow: 0 0 8px rgba(100, 108, 255, 0.3);
            letter-spacing: 0.3px;
        }

        .btn-add-context::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(100, 108, 255, 0.15), 
                rgba(120, 130, 255, 0.25), 
                rgba(100, 108, 255, 0.15), 
                transparent
            );
            transition: left 0.6s ease;
        }

        .btn-add-context::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, rgba(100, 108, 255, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .btn-add-context:hover::before {
            left: 100%;
        }

        .btn-add-context:hover::after {
            opacity: 1;
        }

        .btn-add-context:hover {
            background: linear-gradient(145deg, rgba(25, 28, 35, 0.98) 0%, rgba(35, 38, 48, 0.98) 100%);
            border-color: rgba(120, 130, 255, 0.5);
            border-top-color: rgba(140, 150, 255, 0.6);
            color: rgba(200, 210, 255, 1);
            transform: translateY(-1px);
            box-shadow: 
                0 4px 16px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.08),
                inset 0 -1px 0 rgba(0, 0, 0, 0.4),
                0 0 20px rgba(100, 108, 255, 0.4),
                0 0 40px rgba(100, 108, 255, 0.2);
            text-shadow: 0 0 12px rgba(100, 108, 255, 0.6), 0 0 24px rgba(100, 108, 255, 0.3);
        }

        .btn-add-context:active {
            transform: translateY(0);
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.03),
                inset 0 -1px 0 rgba(0, 0, 0, 0.3),
                0 0 10px rgba(100, 108, 255, 0.3);
        }

        .btn-add-context .btn-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            font-size: 14px;
            font-weight: 700;
            line-height: 1;
            background: linear-gradient(135deg, rgba(100, 108, 255, 0.3) 0%, rgba(80, 90, 220, 0.3) 100%);
            border: 1px solid rgba(120, 130, 255, 0.4);
            border-radius: 50%;
            color: rgba(180, 190, 255, 0.95);
            box-shadow: 
                inset 0 1px 2px rgba(255, 255, 255, 0.1),
                0 0 8px rgba(100, 108, 255, 0.3);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1;
        }

        .btn-add-context:hover .btn-icon {
            background: linear-gradient(135deg, rgba(120, 130, 255, 0.5) 0%, rgba(100, 110, 240, 0.5) 100%);
            border-color: rgba(140, 150, 255, 0.6);
            color: rgba(220, 230, 255, 1);
            transform: rotate(90deg) scale(1.15);
            box-shadow: 
                inset 0 1px 2px rgba(255, 255, 255, 0.15),
                0 0 16px rgba(100, 108, 255, 0.6),
                0 0 24px rgba(100, 108, 255, 0.3);
        }

        .btn-add-context .btn-text {
            letter-spacing: 0.3px;
            position: relative;
            z-index: 1;
        }

        .btn-sidebar.delete {
            background: rgba(231, 76, 60, 0.3);
        }

        .btn-sidebar.delete:hover {
            background: rgba(231, 76, 60, 0.5);
        }

        .sidebar h2 {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar h2::before {
            content: 'üìÅ';
            font-size: 20px;
        }

        .search-box {
            margin-bottom: 16px;
            position: relative;
        }

        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            opacity: 0.5;
            z-index: 1;
        }

        .search-box input {
            width: 100%;
            padding: 12px 12px 12px 36px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 14px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .search-box input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .search-box input:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.6);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .context-list {
            list-style: none;
            margin-top: 8px;
        }

        .context-list ul {
            list-style: none;
            padding-left: 0;
            margin: 0;
        }

        .context-list li {
            position: relative;
        }

        .context-item {
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 400;
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ÊäòÂè†/Â±ïÂºÄÂõæÊ†áÊ†∑Âºè */
        .context-toggle {
            width: 16px;
            height: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-right: 4px;
            flex-shrink: 0;
            font-size: 12px;
            transition: transform 0.2s ease;
            color: rgba(255, 255, 255, 0.7);
            user-select: none;
        }

        .context-toggle:hover {
            color: rgba(255, 255, 255, 1);
        }

        .context-toggle.collapsed {
            transform: rotate(-90deg);
        }

        /* Â≠êËäÇÁÇπÂàóË°®ÁöÑÂÆπÂô®Ê†∑Âºè - ‰øùÊåÅÂéüÊúâÂ∞∫ÂØ∏ÔºåÂè™Ê∑ªÂä†ËøáÊ∏°ÊïàÊûú */
        .context-list li > ul {
            /* ‰øùÊåÅÂéüÊúâÁöÑ margin Âíå paddingÔºàÁªßÊâøËá™ .context-list ulÔºâ */
            transition: opacity 0.2s ease;
        }


        /* Â±ÇÁ∫ß 0 - Ê†πËäÇÁÇπÔºàËìùËâ≤Ôºâ */
        .context-level-0 {
            padding-left: 16px;
            font-size: 15px;
        }
        .context-level-0::before {
            content: 'üìÇ';
            font-size: 18px;
            text-shadow: 0 0 4px rgba(74, 144, 226, 0.8);
        }
        .context-level-0.has-config::before {
            content: 'üìã';
            text-shadow: 0 0 4px rgba(74, 144, 226, 0.8);
        }

        /* Â±ÇÁ∫ß 1 - Á¨¨‰∫åÂ±ÇÔºàÁªøËâ≤Ôºâ */
        .context-level-1 {
            padding-left: 32px;
            font-size: 14px;
        }
        .context-level-1::before {
            content: 'üìÇ';
            font-size: 16px;
            text-shadow: 0 0 4px rgba(82, 196, 26, 0.8);
        }
        .context-level-1.has-config::before {
            content: 'üìã';
            text-shadow: 0 0 4px rgba(82, 196, 26, 0.8);
        }

        /* Â±ÇÁ∫ß 2 - Á¨¨‰∏âÂ±ÇÔºàÊ©ôËâ≤Ôºâ */
        .context-level-2 {
            padding-left: 48px;
            font-size: 13px;
        }
        .context-level-2::before {
            content: 'üìÇ';
            font-size: 15px;
            text-shadow: 0 0 4px rgba(250, 140, 22, 0.8);
        }
        .context-level-2.has-config::before {
            content: 'üìã';
            text-shadow: 0 0 4px rgba(250, 140, 22, 0.8);
        }

        /* Â±ÇÁ∫ß 3 - Á¨¨ÂõõÂ±ÇÔºàÁ¥´Ëâ≤Ôºâ */
        .context-level-3 {
            padding-left: 64px;
            font-size: 12px;
        }
        .context-level-3::before {
            content: 'üìÇ';
            font-size: 14px;
            text-shadow: 0 0 4px rgba(114, 46, 209, 0.8);
        }
        .context-level-3.has-config::before {
            content: 'üìã';
            text-shadow: 0 0 4px rgba(114, 46, 209, 0.8);
        }

        /* Â±ÇÁ∫ß 4Âèä‰ª•‰∏äÔºàÁÅ∞Ëâ≤Ôºâ */
        .context-item[class*="context-level-"]:not(.context-level-0):not(.context-level-1):not(.context-level-2):not(.context-level-3) {
            padding-left: 80px;
            font-size: 12px;
        }
        .context-item[class*="context-level-"]:not(.context-level-0):not(.context-level-1):not(.context-level-2):not(.context-level-3)::before {
            content: 'üìÇ';
            font-size: 13px;
            opacity: 0.7;
        }
        .context-item[class*="context-level-"]:not(.context-level-0):not(.context-level-1):not(.context-level-2):not(.context-level-3).has-config::before {
            content: 'üìã';
            opacity: 0.7;
        }

        .context-item:hover {
            background: var(--sidebar-hover);
            transform: translateX(4px);
        }

        .context-item.active {
            background: var(--sidebar-active);
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Âè≥ÈîÆËèúÂçïÊ†∑Âºè */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            padding: 4px 0;
            min-width: 120px;
            z-index: 10000;
            display: none;
            animation: menuSlideIn 0.2s ease;
        }

        @keyframes menuSlideIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-menu-item:hover {
            background: #f0f4f8;
            color: #667eea;
        }

        .context-menu-item:active {
            background: #e2e8f0;
        }

        .context-menu-item.delete {
            color: #e53e3e;
        }

        .context-menu-item.delete:hover {
            background: #fee;
            color: #c53030;
        }

        .content-area {
            flex: 1;
            padding: 32px 40px;
            display: flex;
            flex-direction: column;
            background: #f8f9fb;
            overflow-y: auto;
            min-height: 70vh;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 28px;
            box-shadow: var(--shadow-md);
            margin-bottom: 24px;
            min-height: 65vh;
            display: flex;
            flex-direction: column;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        #btnAddTitle {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        #btnAddTitle::before {
            content: '+';
            font-size: 18px;
            font-weight: 300;
            line-height: 1;
        }

        #btnAddTitle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        #btnAddTitle:active {
            transform: translateY(0);
        }

        .section h2 {
            font-size: 22px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.3px;
        }

        .section h2::before {
            content: 'üìã';
            font-size: 24px;
        }

        /* Ê¨¢ËøéÂå∫ÂüüÊ†∑Âºè */
        #welcomeSection {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 200px);
        }

        .welcome-content {
            text-align: center;
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
            padding: 60px 40px;
            box-sizing: border-box;
        }

        .welcome-icon {
            font-size: 72px;
            margin: 0 auto 32px;
            display: block;
            width: 100px;
            height: 100px;
            line-height: 100px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-12px);
            }
        }

        .welcome-content h2 {
            font-size: 36px;
            color: var(--text-primary);
            margin: 0 0 0 25%;
            font-weight: 700;
            letter-spacing: -0.5px;
            line-height: 1.3;
            text-align: center;
            width: 100%;
        }

        .welcome-content h2::before {
            content: none;
        }

        .welcome-description {
            font-size: 17px;
            color: #666;
            margin: 0 auto 56px;
            line-height: 1.7;
            max-width: 600px;
        }

        .welcome-features {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 28px;
            margin: 0 auto 56px;
            max-width: 960px;
        }

        @media (max-width: 1024px) {
            .welcome-features {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .welcome-content {
                padding: 40px 24px;
            }

            .welcome-icon {
                font-size: 56px;
                width: 80px;
                height: 80px;
                line-height: 80px;
                margin-bottom: 24px;
            }

            .welcome-content h2 {
                font-size: 28px;
                margin-bottom: 16px;
            }

            .welcome-description {
                font-size: 16px;
                margin-bottom: 40px;
            }

            .welcome-features {
                grid-template-columns: 1fr;
                gap: 20px;
                margin-bottom: 40px;
            }

            .feature-item {
                padding: 28px 20px;
            }

            .welcome-tips {
                padding: 24px 28px;
            }

            .welcome-tips p {
                font-size: 16px;
            }

            .welcome-tips li {
                font-size: 14px;
                padding: 8px 0;
                padding-left: 24px;
            }
        }

        @media (max-width: 480px) {
            .welcome-content {
                padding: 32px 16px;
            }

            .feature-item {
                padding: 24px 16px;
            }

            .feature-icon {
                width: 64px;
                height: 64px;
                font-size: 36px;
            }

            .welcome-tips {
                padding: 20px 20px;
            }
        }

        .feature-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 32px 24px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fb 100%);
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .feature-item:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 24px rgba(102, 126, 234, 0.15);
            border-color: var(--primary-color);
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fb 100%);
        }

        .feature-icon {
            font-size: 40px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 72px;
            height: 72px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 18px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
        }

        .feature-item:hover .feature-icon {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
            border-color: rgba(102, 126, 234, 0.4);
            transform: scale(1.1);
        }

        .feature-text {
            flex: 1;
            width: 100%;
        }

        .feature-text h3 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 12px;
            line-height: 1.4;
        }

        .feature-text p {
            font-size: 14px;
            color: #666;
            line-height: 1.7;
            margin: 0;
            text-align: center;
        }

        .welcome-tips {
            background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
            border-radius: 16px;
            padding: 32px 40px;
            text-align: left;
            border-left: 5px solid var(--primary-color);
            max-width: 960px;
            margin: 0 auto;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .welcome-tips p {
            font-size: 17px;
            color: var(--text-primary);
            margin: 0 0 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .welcome-tips ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .welcome-tips li {
            font-size: 15px;
            color: #555;
            padding: 10px 0;
            padding-left: 28px;
            position: relative;
            line-height: 1.8;
        }

        .welcome-tips li::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: var(--primary-color);
            font-weight: bold;
            font-size: 16px;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 50%;
        }

        .title-list {
            display: grid;
            gap: 12px;
        }

        .title-item {
            padding: 18px 20px;
            border-radius: 10px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fb 100%);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .title-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--primary-gradient);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .title-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .title-item:hover::before {
            transform: scaleY(1);
        }

        .title-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .key {
            color: var(--text-secondary);
            font-size: 12px;
            background: linear-gradient(135deg, #f0f4f8 0%, #e8eff5 100%);
            padding: 4px 10px;
            border-radius: 6px;
            display: inline-block;
            font-weight: 500;
            letter-spacing: 0.3px;
            border: 1px solid var(--border-color);
        }

        .title-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .title-empty::before {
            content: 'üì≠';
            display: block;
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .title-info {
            margin-bottom: 12px;
        }

        .template-info {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            font-size: 13px;
            color: var(--text-secondary);
        }

        .template-name {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .template-type {
            display: inline-block;
            background: linear-gradient(135deg, #e8f4f8 0%, #d4edf5 100%);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            color: #2c5282;
            border: 1px solid rgba(44, 82, 130, 0.2);
        }

        .template-loading {
            color: var(--text-secondary);
            font-style: italic;
        }

        .template-none {
            color: var(--text-secondary);
            font-style: italic;
        }

        .template-error {
            color: #e74c3c;
            font-size: 12px;
        }

        /* ÈÄâÈ°πÂç°Ê†∑Âºè */
        .tabs-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .tabs-header {
            display: flex;
            gap: 8px;
            border-bottom: 2px solid var(--border-color);
            padding: 0;
            margin-bottom: 24px;
            overflow-x: auto;
            scrollbar-width: thin;
        }

        .tab-item-wrapper {
            display: flex;
            align-items: center;
            gap: 4px;
            position: relative;
        }

        .tab-item {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            white-space: nowrap;
            position: relative;
        }

        .tab-item:hover {
            color: var(--text-primary);
            background: rgba(102, 126, 234, 0.05);
        }

        .tab-item.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .tab-item-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s ease;
            margin-left: -8px;
        }

        .tab-item-wrapper:hover .tab-item-actions {
            opacity: 1;
        }

        .tab-action-btn {
            padding: 4px 8px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }

        .tab-action-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .tab-action-btn.delete:hover {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        .data-table-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow-md);
            overflow-x: auto;
            min-height: 60vh;
            max-height: 65vh;
            display: flex;
            flex-direction: column;
        }

        .data-table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        .data-table-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .btn-add-row {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-add-row:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .btn-add-row.editing-disabled {
            display: none;
        }

        .btn-enable-edit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-enable-edit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .btn-disable-edit {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(251, 87, 108, 0.3);
        }

        .btn-disable-edit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(251, 87, 108, 0.4);
        }

        .editing-disabled {
            display: none !important;
        }

        .data-table-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            margin-top: 16px;
            /* ÊîØÊåÅÈº†Ê†áÊªëËΩÆÊ®™ÂêëÊªöÂä® */
            scroll-behavior: smooth;
        }

        /* Èº†Ê†áÊªëËΩÆÊ®™ÂêëÊªöÂä®Ê†∑Âºè */
        .data-table-wrapper::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        .data-table-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .data-table-wrapper::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .data-table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .data-table {
            width: 100%;
            min-width: max-content; /* Á°Æ‰øùË°®Ê†º‰∏ç‰ºöË¢´Êå§Âéã */
            border-collapse: collapse;
            font-size: 14px;
            table-layout: auto; /* Ëá™Âä®Ë°®Ê†ºÂ∏ÉÂ±ÄÔºåÊ†πÊçÆÂÜÖÂÆπÂàÜÈÖçÂÆΩÂ∫¶ */
        }

        .data-table thead {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .data-table th {
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
            white-space: nowrap;
            min-width: 120px; /* ËÆæÁΩÆÊúÄÂ∞èÂàóÂÆΩÔºåÁ°Æ‰øùÂàóÈó¥Ë∑ù‰∏ÄËá¥ */
            width: auto; /* Ëá™Âä®ÂÆΩÂ∫¶Ôºå‰ΩÜÂèóÊúÄÂ∞èÂÆΩÂ∫¶ÈôêÂà∂ */
        }

        .data-table th.action-column {
            width: 180px !important; /* Êìç‰ΩúÂàóÂõ∫ÂÆöÂÆΩÂ∫¶ */
            min-width: 180px !important;
        }

        /* ÂéÜÂè≤ÁâàÊú¨Êï∞ÊçÆÂ±ïÁ§∫Âå∫ÂüüÊ†∑Âºè */
        .version-history-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow-md);
            margin-top: 24px;
            max-height: 50vh;
            display: flex;
            flex-direction: column;
        }

        .version-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        .version-history-header h4 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .version-history-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
        }

        .version-history-loading,
        .version-history-empty,
        .version-history-error {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .version-history-error {
            color: #e74c3c;
        }

        .version-history-table {
            width: 100%;
            min-width: max-content;
            border-collapse: collapse;
            font-size: 13px;
        }

        .version-history-table thead {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .version-history-table th {
            padding: 12px 14px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
            white-space: nowrap;
            min-width: 100px;
        }

        .version-history-table td {
            padding: 12px 14px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
            word-break: break-word;
        }

        .version-history-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .change-type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        .change-type-create {
            background-color: #d4edda;
            color: #155724;
        }

        .change-type-update {
            background-color: #fff3cd;
            color: #856404;
        }

        .change-type-delete {
            background-color: #f8d7da;
            color: #721c24;
        }

        .change-data-cell {
            max-width: 300px;
            padding: 8px;
        }

        .change-data-cell > div {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .change-data-cell span {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: help;
        }

        .btn-view-detail {
            padding: 4px 12px;
            font-size: 12px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
            flex-shrink: 0;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .btn-view-detail:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-view-detail:active {
            transform: translateY(0);
        }

        .version-history-pagination {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .pagination-info {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .pagination-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .pagination-page-size {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-select {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: white;
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
            outline: none;
        }

        .pagination-select:hover {
            border-color: var(--primary-color);
        }

        .pagination-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .pagination-btn {
            padding: 8px 14px;
            border: 1px solid var(--border-color);
            background: white;
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .pagination-btn:hover:not(.disabled):not(.active) {
            background: #f8f9fa;
            border-color: #667eea;
            color: #667eea;
        }

        .pagination-btn.active {
            background: var(--primary-gradient);
            color: white;
            border-color: transparent;
            font-weight: 600;
        }

        .pagination-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            cursor: help;
            white-space: nowrap; /* Èò≤Ê≠¢ÂÜÖÂÆπÊç¢Ë°å */
            overflow: hidden;
            text-overflow: ellipsis; /* ÂÜÖÂÆπËøáÈïøÊòæÁ§∫ÁúÅÁï•Âè∑ */
            min-width: 120px; /* ‰∏éth‰øùÊåÅ‰∏ÄËá¥ */
        }

        .data-table td.action-buttons {
            width: 180px !important;
            min-width: 180px !important;
            white-space: normal; /* Êìç‰ΩúÂàóÂÖÅËÆ∏Êç¢Ë°å */
        }

        .data-table td[title]:hover {
            position: relative;
        }

        .data-table th[title] {
            cursor: help;
        }

        .data-table tbody tr {
            transition: background 0.2s ease;
        }

        .data-table tbody tr:hover {
            background: rgba(102, 126, 234, 0.03);
        }

        .data-table tbody tr.editing {
            background: rgba(102, 126, 234, 0.08);
        }

        .data-table input,
        .data-table select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .data-table input:focus,
        .data-table select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .data-table .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-action {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-save {
            background: #48bb78;
            color: white;
        }

        .btn-save:hover {
            background: #38a169;
        }

        .btn-cancel {
            background: #a0aec0;
            color: white;
        }

        .btn-cancel:hover {
            background: #718096;
        }

        .btn-edit {
            background: #4299e1;
            color: white;
        }

        .btn-edit:hover {
            background: #3182ce;
        }

        .btn-delete {
            background: #f56565;
            color: white;
        }

        .btn-delete:hover {
            background: #e53e3e;
        }

        .empty-data {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-data::before {
            content: 'üì≠';
            display: block;
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .tab-loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        /* ÂÖ®Â±ÄÂä†ËΩΩÈÅÆÁΩ©Â±Ç */
        .global-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            border-radius: 12px;
        }

        .global-loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .global-loading-text {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 8px;
        }

        /* Ê∑ªÂä†Ë°®ÂçïÊ†∑Âºè */
        .add-form-container {
            padding: 24px;
        }

        .form-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
        }

        .form-section h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
            font-family: monospace;
        }

        .form-group small {
            display: block;
            margin-top: 6px;
            color: var(--text-secondary);
            font-size: 12px;
        }

        .btn-submit {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-submit:active {
            transform: translateY(0);
        }

        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-new {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .btn-new::before {
            content: 'üîÑ';
            font-size: 16px;
        }

        .btn-new:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-new:active {
            transform: translateY(0);
        }

        /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-header h3 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .modal-body {
            margin-bottom: 24px;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn-modal {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .btn-modal-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-modal-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-modal-secondary {
            background: #e2e8f0;
            color: var(--text-primary);
        }

        .btn-modal-secondary:hover {
            background: #cbd5e0;
        }

        footer {
            background: #f8f9fb;
            padding: 20px 40px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 13px;
            border-top: 1px solid var(--border-color);
        }

        footer p {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* ÊªöÂä®Êù°Ê†∑Âºè */
        .sidebar::-webkit-scrollbar,
        .content-area::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar::-webkit-scrollbar-track,
        .content-area::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .content-area::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .content-area::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        /* Âä†ËΩΩÂä®Áîª */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 1024px) {
            .sidebar {
                width: 280px;
            }

            .content-area {
                padding: 24px;
            }

            header {
                padding: 24px 28px;
            }

            h1 {
                font-size: 28px;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .header-right {
                width: 100%;
                justify-content: flex-end;
            }
        }

        @media (max-width: 768px) {
            .header-nav {
                margin: 0 20px;
                gap: 6px;
            }

            .nav-item {
                padding: 6px 16px;
                font-size: 13px;
            }

            .user-info {
                padding: 6px 12px;
                gap: 8px;
            }

            .username {
                font-size: 13px;
            }

            .btn-logout {
                padding: 6px 16px;
                font-size: 13px;
            }
        }

        @media (max-width: 1024px) {
            .header-nav {
                margin: 0 20px;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
    <script src="/js/global-error-handler.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-left">
                    <h1>BLBB Editor</h1>
                    <div class="subtitle">Âä®ÊÄÅÈÖçÁΩÆÁÆ°ÁêÜÁ≥ªÁªü</div>
                </div>
                <div class="header-nav">
                    <a href="/blbb/editor" class="nav-item active" id="navEditor">ÈÖçÁΩÆÁÆ°ÁêÜ</a>
                    <a href="/blbb/dict" class="nav-item" id="navDict">Êï∞ÊçÆÂ≠óÂÖ∏</a>
                    <a href="/blbb/template" class="nav-item" id="navTemplate">Ê®°ÁâàÁÆ°ÁêÜ</a>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <div class="user-avatar" th:text="${username != null and !#strings.isEmpty(username) ? #strings.toUpperCase(#strings.substring(username, 0, 1)) : 'U'}">
                            U
                        </div>
                        <span class="username" th:text="${username != null and !#strings.isEmpty(username) ? username : 'Êú™ÁôªÂΩï'}">Êú™ÁôªÂΩï</span>
                    </div>
                    <button th:if="${username != null and !#strings.isEmpty(username)}"
                            class="btn-logout"
                            id="logoutBtn">ÁôªÂá∫</button>
                    <button th:unless="${username != null and !#strings.isEmpty(username)}"
                            class="btn-logout"
                            id="logoutBtn"
                            onclick="window.location.href='/blbb/login'">ÁôªÂΩï</button>
                </div>
            </div>
        </header>

        <div class="main-content">
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2>ÈÖçÁΩÆË∑ØÂæÑÁõÆÂΩï</h2>
                    <div class="sidebar-actions">
                        <button class="btn-sidebar btn-add-context" id="btnAddContext">
                            <span class="btn-icon">+</span>
                            <span class="btn-text">Ê∑ªÂä†Ë∑ØÂæÑ</span>
                        </button>
                    </div>
                </div>
                <div class="search-box">
                    <input type="text" id="filter" placeholder="ÊêúÁ¥¢Ë∑ØÂæÑ..." />
                </div>
                <button class="btn-new" id="reloadTree">Âà∑Êñ∞</button>
                <div id="contextTree" class="context-list"></div>
            </div>

            <!-- Âè≥ÈîÆËèúÂçï -->
            <div class="context-menu" id="contextMenu">
                <div class="context-menu-item" id="contextMenuEdit">‚úé ÁºñËæë</div>
                <div class="context-menu-item delete" id="contextMenuDelete">üóë Âà†Èô§</div>
            </div>

            <div class="content-area">
                <!-- Ê¨¢Ëøé‰ø°ÊÅØÂå∫Âüü -->
                <div class="section" id="welcomeSection">
                    <div class="welcome-content">
                        <div class="welcome-icon">üìã</div>
                        <h2>Ê¨¢Ëøé‰ΩøÁî®Âä®ÊÄÅÈÖçÁΩÆÁÆ°ÁêÜÁ≥ªÁªü</h2>
                        <p class="welcome-description">
                            ËøôÊòØ‰∏Ä‰∏™‰∏ì‰∏öÁöÑ‰ºÅ‰∏öÁ∫ßÈÖçÁΩÆÁÆ°ÁêÜÂπ≥Âè∞ÔºåÂ∏ÆÂä©ÊÇ®È´òÊïàÁÆ°ÁêÜ‰∏öÂä°ÈÖçÁΩÆÊï∞ÊçÆ„ÄÇ
                        </p>
                        <div class="welcome-features">
                            <div class="feature-item">
                                <div class="feature-icon">üå≥</div>
                                <div class="feature-text">
                                    <h3>ÈÖçÁΩÆË∑ØÂæÑÁõÆÂΩï</h3>
                                    <p>ÈÄöËøáÊ†ëÂΩ¢ÁªìÊûÑÁªÑÁªáÈÖçÁΩÆË∑ØÂæÑÔºåÊîØÊåÅÂ±ÇÁ∫ßÁÆ°ÁêÜÔºåÂè≥ÈîÆÂèØÁºñËæëÂíåÂà†Èô§ËäÇÁÇπ</p>
                                </div>
                            </div>
                            <div class="feature-item">
                                <div class="feature-icon">üìù</div>
                                <div class="feature-text">
                                    <h3>Ê®°ÊùøÂåñÈÖçÁΩÆ</h3>
                                    <p>‰ΩøÁî®Ê®°ÊùøÂÆö‰πâÈÖçÁΩÆÁªìÊûÑÔºåÊîØÊåÅÂ§öÁßçÊï∞ÊçÆÁ±ªÂûãÔºåÊèêÈ´òÈÖçÁΩÆÁöÑËßÑËåÉÊÄßÂíåÂèØÁª¥Êä§ÊÄß</p>
                                </div>
                            </div>
                            <div class="feature-item">
                                <div class="feature-icon">‚öôÔ∏è</div>
                                <div class="feature-text">
                                    <h3>Âä®ÊÄÅÊï∞ÊçÆÁÆ°ÁêÜ</h3>
                                    <p>ÁÅµÊ¥ªÁöÑË°®Ê†ºÁºñËæëÂäüËÉΩÔºåÊîØÊåÅÂÆûÊó∂È¢ÑËßàÂíåÊâπÈáèÊìç‰ΩúÔºåÊèêÂçáÈÖçÁΩÆÁÆ°ÁêÜÊïàÁéá</p>
                                </div>
                            </div>
                        </div>
                        <div class="welcome-tips">
                            <p><strong>üí° ‰ΩøÁî®ÊèêÁ§∫Ôºö</strong></p>
                            <ul>
                                <li>Âú®Â∑¶‰æßÈÖçÁΩÆË∑ØÂæÑÁõÆÂΩï‰∏≠ÈÄâÊã©‰∏Ä‰∏™ËäÇÁÇπÂºÄÂßãÈÖçÁΩÆ</li>
                                <li>Âè≥ÈîÆÁÇπÂáªËäÇÁÇπÂèØ‰ª•ÁºñËæëÊàñÂà†Èô§ËØ•ËäÇÁÇπ</li>
                                <li>Â∑≤ÈÖçÁΩÆÁöÑËäÇÁÇπ‰ºöÊòæÁ§∫ÈÖçÁΩÆÊï∞ÊçÆÔºåÊú™ÈÖçÁΩÆÁöÑËäÇÁÇπÂèØ‰ª•Ê∑ªÂä†Êñ∞Ê†áÈ¢ò</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="section" id="titleSection" style="display: none;">
                    <div class="section-header">
                        <h2>ÈÖçÁΩÆÊï∞ÊçÆ</h2>
                        <button id="btnAddTitle" style="display: none;">Ê∑ªÂä†Ê†áÈ¢ò</button>
                    </div>
                    <div id="titleList" class="tabs-container">
                        <div class="title-empty">ËØ∑ÂÖàÈÄâÊã©‰∏ä‰∏ãÊñá</div>
                    </div>
                </div>
                <div class="section" id="addTitleSection" style="display: none;">
                    <div class="section-header">
                        <h2 id="titleFormTitle">Ê∑ªÂä†Ê†áÈ¢ò</h2>
                    </div>
                    <div class="add-form-container">
                        <form id="addTitleForm">
                            <input type="hidden" id="titleId" name="id" />
                            <div class="form-group">
                                <label for="titleName">Ê†áÈ¢òÂêçÁß∞ <span style="color: red;">*</span></label>
                                <input type="text" id="titleName" name="titleName" required placeholder="‰æãÂ¶ÇÔºöBooking Classes" />
                            </div>
                            <div class="form-group">
                                <label for="titleKey">Ê†áÈ¢òÈîÆÂêç <span style="color: red;">*</span></label>
                                <input type="text" id="titleKey" name="titleKey" required placeholder="‰æãÂ¶ÇÔºöbooking_classes" />
                                <small>Áî®‰∫éÈÖçÁΩÆÊï∞ÊçÆ‰∏≠ÁöÑÈîÆÂêçÂºïÁî®</small>
                            </div>
                            <div class="form-group">
                                <label for="templateId">ÈÄâÊã©Ê®°Êùø <span style="color: red;">*</span></label>
                                <select id="templateId" name="templateId" required>
                                    <option value="">ËØ∑ÈÄâÊã©Ê®°Êùø...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="displayOrder">ÊòæÁ§∫È°∫Â∫è</label>
                                <input type="number" id="displayOrder" name="displayOrder" value="1" min="1" />
                            </div>
                            <button type="submit" class="btn-submit" id="submitTitleBtn">Ê∑ªÂä†Ê†áÈ¢ò</button>
                            <button type="button" class="btn-secondary" id="cancelEditTitleBtn" style="display: none; margin-left: 10px;" onclick="cancelEditTitle()">ÂèñÊ∂à</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>BLBB Editor ¬© 2024 - ‰ºÅ‰∏öÈÖçÁΩÆÁÆ°ÁêÜÁ≥ªÁªü</p>
        </footer>
    </div>

    <!-- Ê∑ªÂä†‰∏ä‰∏ãÊñáÊ®°ÊÄÅÊ°Ü -->
    <div class="modal-overlay" id="addContextModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="contextModalTitle">Ê∑ªÂä†‰∏ä‰∏ãÊñá</h3>
                <button class="modal-close" onclick="closeAddContextModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addContextForm">
                    <div class="form-group">
                        <label for="contextParentId">Áà∂Á∫ß‰∏ä‰∏ãÊñá <span style="color: red;">*</span></label>
                        <select id="contextParentId" name="parentId" required>
                            <option value="">ËØ∑ÈÄâÊã©Áà∂Á∫ß‰∏ä‰∏ãÊñá</option>
                        </select>
                        <small>ÂøÖÈ°ªÈÄâÊã©Áà∂Á∫ß‰∏ä‰∏ãÊñá</small>
                    </div>
                    <div class="form-group">
                        <label for="nodeName">ËäÇÁÇπÂêçÁß∞ <span style="color: red;">*</span></label>
                        <input type="text" id="nodeName" name="nodeName" required placeholder="‰æãÂ¶ÇÔºöairÔºàÂè™ËÉΩËæìÂÖ•Ëã±Êñá„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫øÔºâ" pattern="[A-Za-z0-9_]+" />
                        <small>Âè™ËÉΩËæìÂÖ•Ëã±ÊñáÂ≠óÊØç„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫ø</small>
                    </div>
                    <div class="form-group" style="display: none;">
                        <input type="text" id="contextPath" name="contextPath" />
                        <input type="number" id="nodeLevel" name="nodeLevel" />
                    </div>
                    <div class="form-group">
                        <label>Ë∑ØÂæÑÈ¢ÑËßà</label>
                        <div id="pathPreview" style="padding: 10px; background: #f5f5f5; border-radius: 4px; color: #666; font-family: monospace;">
                            ËØ∑ÈÄâÊã©Áà∂Á∫ß‰∏ä‰∏ãÊñáÂπ∂ËæìÂÖ•ËäÇÁÇπÂêçÁß∞
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description">ÊèèËø∞‰ø°ÊÅØ</label>
                        <textarea id="description" name="description" rows="3" placeholder="ÂèØÈÄâÊèèËø∞‰ø°ÊÅØ"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-secondary" onclick="closeAddContextModal()">ÂèñÊ∂à</button>
                <button class="btn-modal btn-modal-primary" id="submitContextBtn" onclick="submitAddContext()">Á°ÆÂÆö</button>
            </div>
        </div>
    </div>

    <!-- ÁºñËæë‰∏ä‰∏ãÊñáÊ®°ÊÄÅÊ°Ü -->
    <div class="modal-overlay" id="editContextModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="editContextModalTitle">ÁºñËæë‰∏ä‰∏ãÊñá</h3>
                <button class="modal-close" onclick="closeEditContextModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editContextForm">
                    <div class="form-group">
                        <label for="editNodeName">ËäÇÁÇπÂêçÁß∞ <span style="color: red;">*</span></label>
                        <input type="text" id="editNodeName" name="nodeName" required placeholder="‰æãÂ¶ÇÔºöairÔºàÂè™ËÉΩËæìÂÖ•Ëã±Êñá„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫øÔºâ" pattern="[A-Za-z0-9_]+" />
                        <small>Âè™ËÉΩËæìÂÖ•Ëã±ÊñáÂ≠óÊØç„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫øÔºå‰øÆÊîπÂêçÁß∞ÂêéË∑ØÂæÑ‰ºöËá™Âä®Êõ¥Êñ∞</small>
                    </div>
                    <div class="form-group" style="display: none;">
                        <input type="text" id="editContextId" name="contextId" />
                        <input type="text" id="editParentId" name="parentId" />
                        <input type="text" id="editContextPath" name="contextPath" />
                        <input type="number" id="editNodeLevel" name="nodeLevel" />
                        <textarea id="editDescription" name="description"></textarea>
                        <input type="hidden" id="editHasConfig" name="hasConfig" />
                    </div>
                    <div class="form-group">
                        <label>Ë∑ØÂæÑÈ¢ÑËßà</label>
                        <div id="editPathPreview" style="padding: 10px; background: #f5f5f5; border-radius: 4px; color: #666; font-family: monospace;">
                            Ê≠£Âú®Âä†ËΩΩ...
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-secondary" onclick="closeEditContextModal()">ÂèñÊ∂à</button>
                <button class="btn-modal btn-modal-primary" id="submitEditContextBtn" onclick="submitEditContext()">Á°ÆÂÆö</button>
            </div>
        </div>
    </div>

    <!-- ÂèòÊõ¥Êï∞ÊçÆËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
    <div class="modal-overlay" id="changeDataDetailModal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="changeDataDetailModalTitle">ÂèòÊõ¥Êï∞ÊçÆËØ¶ÊÉÖ</h3>
                <button class="modal-close" onclick="closeChangeDataDetailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="changeDataDetailContent" style="max-height: 70vh; overflow-y: auto;">
                    <!-- ÂèòÊõ¥Êï∞ÊçÆÂ∞ÜÈÄöËøáÊ®°ÊùøÊ∏≤ÊüìÊòæÁ§∫Âú®ËøôÈáå -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-secondary" onclick="closeChangeDataDetailModal()">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

<script>
    const api = {
        tree: '/system/context/getContextTree',
        titleByContextId: '/system/title/listByContextId',
        titleInsert: '/system/title/insertData',
        titleUpdate: '/system/title/updateData',
        titleDelete: '/system/title/deleteData',
        titleGetInfo: '/system/title/getInfoById',
        templateList: '/system/template/getAllTemplates',
        contextInsert: '/system/context/insertData',
        contextUpdate: '/system/context/updateData',
        contextDelete: '/system/context/deleteData',
        contextGetInfo: '/system/context/getInfoById'
    };

    // Â≠òÂÇ®ÂΩìÂâçÈÄâÊã©ÁöÑ‰∏ä‰∏ãÊñá‰ø°ÊÅØ
    let currentContext = {
        id: null,
        hasConfig: false
    };

    // ÁºñËæëÊ®°ÂºèÊ†áÂøó
    let isEditMode = false;

    function buildTree(data) {
        function render(nodes, level = 0) {
            let ul = $('<ul></ul>');
            nodes.forEach(n => {
                let li = $('<li></li>');
                const hasChildren = n.children && n.children.length > 0;

                // ‰ΩøÁî® nodeLevel Â≠óÊÆµÊù•Á°ÆÂÆöÂ±ÇÁ∫ßÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®‰º†ÂÖ•ÁöÑ level
                const nodeLevel = n.nodeLevel !== undefined && n.nodeLevel !== null ? n.nodeLevel : level;

                // Ê†πÊçÆÂ±ÇÁ∫ßÊ∑ªÂä†‰∏çÂêåÁöÑ class
                let label = $('<div></div>').addClass('context-item').addClass('context-level-' + nodeLevel);

                // Â¶ÇÊûúÊúâÂ≠êËäÇÁÇπÔºåÊ∑ªÂä† has-children Á±ª
                if (hasChildren) {
                    label.addClass('has-children');
                }

                // Ê†πÊçÆ hasConfig Â≠óÊÆµÊ∑ªÂä†Á±ªÂêç
                if (n.hasConfig === true || n.hasConfig === 1 || n.hasConfig === '1') {
                    label.addClass('has-config');
                }

                // Â¶ÇÊûúÊúâÂ≠êËäÇÁÇπÔºåÊ∑ªÂä†ÊäòÂè†/Â±ïÂºÄÂõæÊ†á
                if (hasChildren) {
                    const $toggle = $('<span class="context-toggle">‚ñ∂</span>');
                    $toggle.on('click', function(e) {
                        e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°ÔºåÈÅøÂÖçËß¶ÂèëËäÇÁÇπÈÄâÊã©
                        const $item = $(this).closest('.context-item');
                        const $parentLi = $item.closest('li');
                        const $childUl = $parentLi.children('ul');

                        $(this).toggleClass('collapsed');
                        $item.toggleClass('collapsed');

                        // ÂàáÊç¢Â≠êËäÇÁÇπÁöÑÊòæÁ§∫/ÈöêËóè
                        if ($item.hasClass('collapsed')) {
                            $childUl.slideUp(200);
                        } else {
                            $childUl.slideDown(200);
                        }
                    });
                    label.append($toggle);
                } else {
                    // Ê≤°ÊúâÂ≠êËäÇÁÇπÊó∂ÔºåÊ∑ªÂä†‰∏Ä‰∏™Á©∫ÁôΩÂç†‰ΩçÁ¨¶‰ª•‰øùÊåÅÂØπÈΩê
                    const $spacer = $('<span class="context-toggle" style="visibility: hidden;">‚ñ∂</span>');
                    label.append($spacer);
                }

                // Ê∑ªÂä†ËäÇÁÇπÂêçÁß∞
                const labelContent = $('<span></span>').text(n.nodeName || n.contextPath);
                label.append(labelContent);

                // Ê∑ªÂä†Â±ÇÁ∫ßÈ¢úËâ≤ÊåáÁ§∫ÁÇπÔºàÊîæÂú®ÊñáÊú¨ÂêéÈù¢Ôºå‰Ωú‰∏∫ËßÜËßâËæÖÂä©Ôºâ
                const levelColors = ['#4a90e2', '#52c41a', '#fa8c16', '#722ed1', '#8c8c8c'];
                const color = levelColors[Math.min(nodeLevel, levelColors.length - 1)];
                const colorDot = $('<span></span>').css({
                    'width': '8px',
                    'height': '8px',
                    'border-radius': '50%',
                    'background-color': color,
                    'display': 'inline-block',
                    'margin-left': '8px',
                    'flex-shrink': '0',
                    'box-shadow': '0 0 3px ' + color
                });
                label.append(colorDot);

                // Â¶ÇÊûúÊúâÊèèËø∞‰ø°ÊÅØÔºåÊ∑ªÂä†titleÂ±ûÊÄßÁî®‰∫éÊÇ¨ÊµÆÊòæÁ§∫
                if (n.description) {
                    label.attr('title', n.description);
                }

                // Â≠òÂÇ®‰∏ä‰∏ãÊñáIDÂíåhasConfigÁä∂ÊÄÅ
                label.data('ctxId', n.id);
                label.data('ctx-id', n.id); // Ê∑ªÂä†Âè¶‰∏ÄÁßçÊñπÂºè‰ª•‰æøÊü•Êâæ
                // Â≠òÂÇ®ÂéüÂßãÁöÑ hasConfig ÂÄºÔºå‰∏çÂÅöËΩ¨Êç¢ÔºåÂú®ÁÇπÂáªÊó∂ÂÜçÂà§Êñ≠
                label.data('hasConfig', n.hasConfig);
                // Â≠òÂÇ®ËäÇÁÇπÂêçÁß∞ÔºåÁî®‰∫éÂà†Èô§Êó∂ÊòæÁ§∫
                label.data('nodeName', n.nodeName || n.contextPath);

                console.log('[Build Tree] ËÆæÁΩÆËäÇÁÇπÊï∞ÊçÆ:', {
                    contextId: n.id,
                    contextPath: n.contextPath || n.nodeName,
                    hasConfig: n.hasConfig,
                    hasConfigType: typeof n.hasConfig
                });

                label.on('click', function(e){
                    console.log('[Context Click] ÁÇπÂáª‰∫ã‰ª∂Ëß¶Âèë');

                    // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÊäòÂè†ÂõæÊ†áÔºå‰∏çÂ§ÑÁêÜËäÇÁÇπÈÄâÊã©
                    if ($(e.target).hasClass('context-toggle')) {
                        console.log('[Context Click] ÁÇπÂáªÁöÑÊòØÊäòÂè†ÂõæÊ†áÔºåÂøΩÁï•');
                        return;
                    }

                    console.log('[Context Click] Â§ÑÁêÜËäÇÁÇπÈÄâÊã©');

                    // È´ò‰∫ÆÂΩìÂâçÈÄâÊã©
                    $('#contextTree .context-item').removeClass('active');
                    $(this).addClass('active');

                    const cid = $(this).data('ctxId');
                    const hasConfig = $(this).data('hasConfig');

                    console.log('[Context Click] Ëé∑Âèñ‰∏ä‰∏ãÊñá‰ø°ÊÅØ:', {
                        contextId: cid,
                        hasConfig: hasConfig,
                        hasConfigType: typeof hasConfig,
                        hasConfigValue: hasConfig
                    });

                    // Êõ¥Êñ∞ÂΩìÂâç‰∏ä‰∏ãÊñá‰ø°ÊÅØ
                    currentContext.id = cid;
                    currentContext.hasConfig = hasConfig;

                    // Âà§Êñ≠ÊòØÂê¶‰∏∫Â∑≤ÈÖçÁΩÆÁöÑcontextÔºàÂÖºÂÆπÂ§öÁßçÊ†ºÂºèÔºâ
                    const isConfigured = hasConfig === true ||
                                        hasConfig === 1 ||
                                        hasConfig === '1' ||
                                        hasConfig === 'true' ||
                                        String(hasConfig).toLowerCase() === 'true';

                    console.log('[Context Click] Âà§Êñ≠ÈÖçÁΩÆÁä∂ÊÄÅ:', {
                        hasConfig: hasConfig,
                        isConfigured: isConfigured
                    });

                    // Ê†πÊçÆhasConfigÂÜ≥ÂÆöÊòæÁ§∫Âì™‰∏™section
                    if (isConfigured) {
                        // Â∑≤ÊúâtitleÁöÑcontextÔºöÂè™ÊòæÁ§∫Ê†áÈ¢òÂàóË°®ÂíåÊ®°ÊùøÔºå‰∏çÊòæÁ§∫Ê∑ªÂä†Ë°®Âçï
                        console.log('[Context Click] Â∑≤ÈÖçÁΩÆÁöÑcontextÔºåË∞ÉÁî®loadTitles');
                        $('#welcomeSection').hide();
                        $('#titleSection').show();
                        $('#btnAddTitle').show();
                        $('#addTitleSection').hide();
                        loadTitles(cid);
                    } else {
                        // Ê≤°ÊúâtitleÁöÑcontextÔºöÊòæÁ§∫Ê∑ªÂä†Ê†áÈ¢òË°®ÂçïÔºåÈöêËóèÊ†áÈ¢òÂàóË°®
                        console.log('[Context Click] Êú™ÈÖçÁΩÆÁöÑcontextÔºåÊòæÁ§∫Ê∑ªÂä†Ë°®Âçï');
                        $('#welcomeSection').hide();
                        $('#addTitleSection').show();
                        $('#titleSection').hide();
                        $('#btnAddTitle').hide();
                        loadTemplates();
                        resetTitleForm();
                    }
                });

                // Ê∑ªÂä†Âè≥ÈîÆËèúÂçï‰∫ã‰ª∂
                label.on('contextmenu', function(e) {
                    e.preventDefault(); // ÈòªÊ≠¢ÊµèËßàÂô®ÈªòËÆ§Âè≥ÈîÆËèúÂçï
                    e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°

                    // ÂÖàÈÄâ‰∏≠ÂΩìÂâçËäÇÁÇπÔºàÂíåÂ∑¶ÈîÆÁÇπÂáª‰∏ÄÊ†∑ÁöÑÈÄªËæëÔºâ
                    $('#contextTree .context-item').removeClass('active');
                    $(this).addClass('active');

                    const cid = $(this).data('ctxId');
                    const hasConfig = $(this).data('hasConfig');

                    // Êõ¥Êñ∞ÂΩìÂâç‰∏ä‰∏ãÊñá‰ø°ÊÅØ
                    currentContext.id = cid;
                    currentContext.hasConfig = hasConfig;

                    // ÊòæÁ§∫Âè≥ÈîÆËèúÂçï - ‰∏éÁõÆÂΩïÈ°πÂØπÈΩê
                    const $menu = $('#contextMenu');
                    const $contextItem = $(this);

                    // ‰ΩøÁî® getBoundingClientRect() Ëé∑ÂèñÁõ∏ÂØπ‰∫éËßÜÁ™óÁöÑ‰ΩçÁΩÆÔºàËÄÉËôëÊªöÂä®Ôºâ
                    const itemRect = $contextItem[0].getBoundingClientRect();
                    const itemHeight = itemRect.height;
                    const itemWidth = itemRect.width;

                    // ÂÖàËÆæÁΩÆ‰∏∫block‰ª•Ëé∑ÂèñËèúÂçïÁöÑÂÆûÈôÖÂ∞∫ÂØ∏
                    $menu.css({
                        display: 'block',
                        visibility: 'hidden'
                    });

                    const menuWidth = $menu.outerWidth();
                    const menuHeight = $menu.outerHeight();

                    // ËÆ°ÁÆóËèúÂçï‰ΩçÁΩÆÔºöÊ∞¥Âπ≥‰∏éÁõÆÂΩïÈ°πÂ∑¶ÂØπÈΩêÔºåÂûÇÁõ¥‰∏éÁõÆÂΩïÈ°πÈ°∂ÈÉ®ÂØπÈΩê
                    // ‰ΩøÁî®Áõ∏ÂØπ‰∫éËßÜÁ™óÁöÑ‰ΩçÁΩÆÔºàgetBoundingClientRectÔºâ
                    let left = itemRect.left;
                    let top = itemRect.top;

                    // Â¶ÇÊûúËèúÂçïÂú®Âè≥‰æß‰ºöË∂ÖÂá∫ËßÜÁ™óÔºåÂàôÊòæÁ§∫Âú®ÁõÆÂΩïÈ°πÂ∑¶‰æß
                    const windowWidth = $(window).width();
                    const windowHeight = $(window).height();

                    if (left + menuWidth > windowWidth) {
                        left = itemRect.left + itemWidth - menuWidth;
                        // Â¶ÇÊûú‰ªçÁÑ∂Ë∂ÖÂá∫ÔºåÊòæÁ§∫Âú®Â∑¶‰æß
                        if (left < 0) {
                            left = itemRect.left - menuWidth - 5;
                        }
                    }

                    // Â¶ÇÊûúËèúÂçïÂú®‰∏ãÊñπ‰ºöË∂ÖÂá∫ËßÜÁ™óÔºåÂêë‰∏äË∞ÉÊï¥
                    if (top + menuHeight > windowHeight) {
                        top = windowHeight - menuHeight - 10;
                    }

                    // Á°Æ‰øùËèúÂçï‰∏ç‰ºöË∂ÖÂá∫ËßÜÁ™óÂ∑¶ËæπÁïå
                    if (left < 10) {
                        left = 10;
                    }

                    // Á°Æ‰øùËèúÂçï‰∏ç‰ºöË∂ÖÂá∫ËßÜÁ™ó‰∏äËæπÁïå
                    if (top < 10) {
                        top = 10;
                    }

                    // ËÆæÁΩÆÊúÄÁªà‰ΩçÁΩÆÂπ∂ÊòæÁ§∫
                    $menu.css({
                        left: left + 'px',
                        top: top + 'px',
                        visibility: 'visible'
                    });

                    return false;
                });

                li.append(label);

                // ÈÄíÂΩíÊ∏≤ÊüìÂ≠êËäÇÁÇπÔºàÊîæÂú® label ÂêéÈù¢ÔºåËøôÊ†∑ÂèØ‰ª•ÈÄöËøáÁõ∏ÈÇªÂÖÑÂºüÈÄâÊã©Âô®ÊéßÂà∂ÊòæÁ§∫/ÈöêËóèÔºâ
                if (hasChildren) {
                    let child = render(n.children, nodeLevel + 1);
                    li.append(child);
                }

                ul.append(li);
            });
            return ul;
        }
        $('#contextTree').empty().append(render(data));
    }

    function loadTree() {
        $('#contextTree').html('<div style="text-align:center;padding:20px;color:white;">Âä†ËΩΩ‰∏≠...</div>');
        return $.ajax({
            url: api.tree,
            method: 'GET',
            dataType: 'json',
            success: function(res) {
                buildTree(res.data || []);
            },
            error: function(xhr, status, error) {
                // ‰∏çÂú®ËøôÈáåÂ§ÑÁêÜÈîôËØØÔºåËÆ©ÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜÂô®Â§ÑÁêÜ
                // Âè™ÊòØÊõ¥Êñ∞UIÊòæÁ§∫Âä†ËΩΩÂ§±Ë¥•ÔºàÂ¶ÇÊûúÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜÂô®Ê≤°ÊúâÂ§ÑÁêÜÔºâ
                console.log('[loadTree] AJAXËØ∑Ê±ÇÂ§±Ë¥•Ôºå‰∫§ÁªôÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜÂô®Â§ÑÁêÜ');
                // Âª∂Ëøü‰∏Ä‰∏ãÔºåÂ¶ÇÊûúÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜÂô®Â§ÑÁêÜ‰∫ÜÔºà‰ºöË∑≥ËΩ¨ÔºâÔºåËøôË°å‰ª£Á†Å‰∏ç‰ºöÊâßË°å
                setTimeout(function() {
                    // Â¶ÇÊûúÈ°µÈù¢ËøòÂú®ÔºàÊ≤°ÊúâË∑≥ËΩ¨ÔºâÔºåËØ¥ÊòéÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜÂô®Ê≤°ÊúâÂ§ÑÁêÜÔºåÊòæÁ§∫ÈîôËØØ
                    if ($('#contextTree').length > 0) {
                        $('#contextTree').html('<div style="color:#e74c3c;padding:10px;">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï</div>');
                    }
                }, 500);
            }
        });
    }

    // Â≠òÂÇ®ÂΩìÂâç‰∏ä‰∏ãÊñáÁöÑÊâÄÊúâÊ†áÈ¢òÂíåÊ®°Êùø‰ø°ÊÅØ
    let currentTitles = [];
    let currentContextId = null;
    let dictDataCache = {}; // ÁºìÂ≠òÊï∞ÊçÆÂ≠óÂÖ∏Êï∞ÊçÆ
    let pendingAjaxRequests = {}; // Ë∑üË∏™Ê≠£Âú®ËøõË°åÁöÑAJAXËØ∑Ê±ÇÔºåÁî®‰∫éÂèñÊ∂à
    let activeTabId = null; // ÂΩìÂâçÊ¥ªÂä®ÁöÑtab ID
    let globalEditModeEnabled = false; // ÂÖ®Â±ÄÁºñËæëÊ®°ÂºèÁä∂ÊÄÅÔºåÂàáÊç¢titleÂêé‰øùÊåÅÁºñËæëÁä∂ÊÄÅ

    function loadTitles(contextId) {
        console.log('[loadTitles] ÂáΩÊï∞Ë¢´Ë∞ÉÁî®ÔºåcontextId:', contextId, 'Á±ªÂûã:', typeof contextId);

        const $box = $('#titleList');
        if ($box.length === 0) {
            console.error('[loadTitles] Êâæ‰∏çÂà∞ÂÆπÂô® #titleList');
            return;
        }

        // ÂèñÊ∂àÊâÄÊúâÊ≠£Âú®ËøõË°åÁöÑAJAXËØ∑Ê±Ç
        Object.keys(pendingAjaxRequests).forEach(tabId => {
            if (pendingAjaxRequests[tabId]) {
                console.log('[loadTitles] ÂèñÊ∂àtabÁöÑAJAXËØ∑Ê±Ç:', tabId);
                pendingAjaxRequests[tabId].abort();
            }
        });
        pendingAjaxRequests = {};
        activeTabId = null; // ÈáçÁΩÆÊ¥ªÂä®tab ID
        globalEditModeEnabled = false; // ÂàáÊç¢contextÊó∂ÈáçÁΩÆÁºñËæëÊ®°ÂºèÁä∂ÊÄÅ

        $box.html('<div class="tab-loading">Âä†ËΩΩ‰∏≠...</div>');

        // Á°Æ‰øù contextId ÊòØÂ≠óÁ¨¶‰∏≤Á±ªÂûãÔºàÂêéÁ´ØÊúüÊúõ StringÔºâ
        const contextIdStr = contextId ? String(contextId) : null;
        currentContextId = contextIdStr;

        console.log('[loadTitles] ÂáÜÂ§áÂèëÈÄÅAJAXËØ∑Ê±Ç:', {
            url: api.titleByContextId,
            contextId: contextIdStr,
            apiDefined: typeof api !== 'undefined'
        });

        $.ajax({
            url: api.titleByContextId,
            method: 'GET',
            data: { contextId: contextIdStr },
            dataType: 'text', // ÂÖàËé∑ÂèñÊñáÊú¨ÔºåÁÑ∂ÂêéËá™ÂÆö‰πâËß£Êûê
            success: function(responseText) {
                console.log('[loadTitles] AJAXËØ∑Ê±ÇÊàêÂäüÔºåÂìçÂ∫îÈïøÂ∫¶:', responseText ? responseText.length : 0);

                // Ëá™ÂÆö‰πâ JSON Ëß£ÊûêÔºöÂ∞Ü templateId Â≠óÊÆµÁöÑÊâÄÊúâÊï∞Â≠óÂÄºËΩ¨Êç¢‰∏∫Â≠óÁ¨¶‰∏≤ÔºåÈÅøÂÖçÁ≤æÂ∫¶‰∏¢Â§±
                const fixedJson = responseText.replace(/"templateId"\s*:\s*(-?\d+)/g, '"templateId":"$1"');

                let res;
                try {
                    res = JSON.parse(fixedJson);
                    console.log('[loadTitles] JSONËß£ÊûêÊàêÂäüÔºåÂìçÂ∫îÁ†Å:', res.code, 'Êï∞ÊçÆÊï∞Èáè:', (res.data && res.data.length) || 0);
                } catch (e) {
                    console.error('[loadTitles] JSON Ëß£ÊûêÂ§±Ë¥•:', e);
                    try {
                        res = JSON.parse(responseText);
                        console.log('[loadTitles] ‰ΩøÁî®ÂéüÂßãJSONËß£ÊûêÊàêÂäü');
                    } catch (e2) {
                        console.error('[loadTitles] ÂéüÂßãJSON‰πüËß£ÊûêÂ§±Ë¥•:', e2);
                        $box.html('<div class="title-empty" style="color:#e74c3c;">Êï∞ÊçÆËß£ÊûêÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØï</div>');
                        return;
                    }
                }

                if (!res || res.code !== 2000) {
                    console.error('[loadTitles] ÂìçÂ∫îÁ†Å‰∏çÊ≠£Á°Æ:', res ? res.code : 'Êó†ÂìçÂ∫î');
                    $box.html(`<div class="title-empty" style="color:#e74c3c;">Âä†ËΩΩÂ§±Ë¥•: ${res && res.msg ? res.msg : 'Êú™Áü•ÈîôËØØ'}</div>`);
                    return;
                }

                const list = res.data || [];
                currentTitles = list;
                console.log('[loadTitles] Ê≠•È™§1: Ëé∑ÂèñÂà∞titlesÂàóË°®ÔºåÊï∞Èáè:', list.length);

                // ÊâìÂç∞ÊØè‰∏™titleÁöÑtemplateId‰ø°ÊÅØÔºå‰æø‰∫éË∞ÉËØï
                list.forEach((title, idx) => {
                    console.log('[loadTitles] Title[' + idx + ']:', {
                        id: title.id,
                        titleName: title.titleName,
                        titleKey: title.titleKey,
                        templateId: title.templateId,
                        templateIdType: typeof title.templateId
                    });
                });

                $box.empty();

                if (!list.length) {
                    console.log('[loadTitles] titlesÂàóË°®‰∏∫Á©∫');
                    $box.append('<div class="title-empty">ËØ•‰∏ä‰∏ãÊñáÊöÇÊó†Ê†áÈ¢ò</div>');
                    // ÂΩìÂàóË°®‰∏∫Á©∫Êó∂ÔºåÊòæÁ§∫Ê∑ªÂä†Ê†áÈ¢òÊåâÈíÆ
                    $('#welcomeSection').hide();
                    $('#titleSection').show();
                    $('#btnAddTitle').show();
                    $('#addTitleSection').hide();
                    return;
                }

                // ÂàõÂª∫ÈÄâÈ°πÂç°ÁªìÊûÑ
                const $tabsContainer = $('<div class="tabs-container"></div>');
                const $tabsHeader = $('<div class="tabs-header"></div>');
                const $tabsContent = $('<div class="tabs-content-wrapper"></div>');

                // Ê∑ªÂä†ÂÖ®Â±ÄÂä†ËΩΩÈÅÆÁΩ©
                const $loadingOverlay = $('<div class="global-loading-overlay"><div class="global-loading-spinner"></div><div class="global-loading-text">Ê≠£Âú®Âä†ËΩΩÊ®°ÊùøÔºåËØ∑Á®çÂÄô...</div></div>');
                $tabsContent.append($loadingOverlay);

                // Áî®‰∫éÊî∂ÈõÜÊâÄÊúâÈúÄË¶ÅÂä†ËΩΩÁöÑPromise
                const loadPromises = [];

                // ÂÖàÁ°ÆÂÆöÁ¨¨‰∏Ä‰∏™tabÁöÑIDÔºåÁ°Æ‰øùÂú®Âä†ËΩΩÂâçËÆæÁΩÆÂ•ΩactiveTabId
                let firstTabId = null;
                let firstTitle = null; // ‰øùÂ≠òÁ¨¨‰∏Ä‰∏™titleÔºåÁî®‰∫éÂêéÁª≠Âä†ËΩΩÊ®°Êùø

                console.log('[loadTitles] Ê≠•È™§2: ÂºÄÂßã‰∏∫ÊØè‰∏™titleÂàõÂª∫ÈÄâÈ°πÂç°Âπ∂ÂáÜÂ§áÂä†ËΩΩÊ®°Êùø');

                // ‰∏∫ÊØè‰∏™Ê†áÈ¢òÂàõÂª∫ÈÄâÈ°πÂç°
                list.forEach((title, index) => {
                    const tabId = `tab-${title.id || index}`;

                    // Â¶ÇÊûúÊòØÁ¨¨‰∏Ä‰∏™tabÔºåËÆ∞ÂΩïÂÖ∂IDÂíåtitle‰ø°ÊÅØ
                    if (index === 0) {
                        firstTabId = tabId;
                        firstTitle = title;
                        console.log('[loadTitles] ËÆ∞ÂΩïÁ¨¨‰∏Ä‰∏™tab‰ø°ÊÅØ:', {
                            tabId: tabId,
                            titleId: title.id,
                            titleName: title.titleName,
                            templateId: title.templateId
                        });
                    }

                    // Ë∞ÉËØï‰ø°ÊÅØÔºöÊâìÂç∞titleÂØπË±°ÂíåtemplateIdÔºàÈÅøÂÖçÊâìÂç∞Êï¥‰∏™ÂØπË±°ÔºåÂè™ÊâìÂç∞ÈúÄË¶ÅÁöÑÂ±ûÊÄßÔºâ
                    try {
                        console.log('[loadTitles] Â§ÑÁêÜtitle:', {
                            id: title.id,
                            titleName: title.titleName,
                            titleKey: title.titleKey,
                            templateId: title.templateId,
                            templateIdType: typeof title.templateId
                        });
                    } catch (e) {
                        console.log('[loadTitles] Â§ÑÁêÜtitle (ÈÉ®ÂàÜ‰ø°ÊÅØ):', {
                            id: title.id,
                            titleName: title.titleName,
                            templateId: title.templateId
                        });
                    }

                    // Ê†πÊçÆhasConfigÁä∂ÊÄÅÂÜ≥ÂÆöÊòæÁ§∫ÂÜÖÂÆπ
                    let tabText, tabTitle;
                    if (currentContext.hasConfig === true || currentContext.hasConfig === 1 || currentContext.hasConfig === '1') {
                        // Â∑≤ÈÖçÁΩÆÔºöÊòæÁ§∫keyÔºåÈº†Ê†áÊÇ¨ÊµÆÊòæÁ§∫ÂêçÁß∞
                        tabText = escapeHtml(title.titleKey || title.titleName || 'Êú™ÂëΩÂêç');
                        tabTitle = escapeHtml(title.titleName || '');
                    } else {
                        // Êú™ÈÖçÁΩÆÔºöÊòæÁ§∫ÂêçÁß∞
                        tabText = escapeHtml(title.titleName || 'Êú™ÂëΩÂêç');
                        tabTitle = '';
                    }

                    // ÂàõÂª∫ÈÄâÈ°πÂç°Â§¥ÈÉ®ÔºàÂåÖÂê´ÁºñËæëÂíåÂà†Èô§ÊåâÈíÆÔºâ
                    const $tabItemWrapper = $('<div class="tab-item-wrapper"></div>');
                    const $tabItem = $(`<button class="tab-item" data-tab-id="${tabId}"${tabTitle ? ` title="${tabTitle}"` : ''}>${tabText}</button>`);
                    if (index === 0) {
                        $tabItem.addClass('active');
                    }
                    $tabItem.on('click', function(e) {
                        // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÊåâÈíÆÊú¨Ë∫´ÔºåÂàáÊç¢ÈÄâÈ°πÂç°
                        if (e.target === this || $(e.target).closest('.tab-item').length) {
                            switchTab(tabId);
                        }
                    });

                    // ÂàõÂª∫Êìç‰ΩúÊåâÈíÆÔºàÂè™‰øùÁïôÂà†Èô§ÊåâÈíÆÔºâ
                    const $tabActions = $('<div class="tab-item-actions"></div>');
                    const $deleteBtn = $('<button class="tab-action-btn delete" title="Âà†Èô§" data-title-id="' + title.id + '">√ó</button>');

                    $deleteBtn.on('click', function(e) {
                        e.stopPropagation();
                        deleteTitle(title.id, title.titleName || title.titleKey);
                    });

                    $tabActions.append($deleteBtn);
                    $tabItemWrapper.append($tabItem).append($tabActions);
                    $tabsHeader.append($tabItemWrapper);

                    // ÂàõÂª∫ÈÄâÈ°πÂç°ÂÜÖÂÆπ
                    const $tabContent = $(`<div class="tab-content" id="${tabId}"></div>`);
                    if (index === 0) {
                        $tabContent.addClass('active').show();
                        activeTabId = tabId; // ËÆæÁΩÆÁ¨¨‰∏Ä‰∏™tab‰∏∫Ê¥ªÂä®tab
                        console.log('[loadTitles] ËÆæÁΩÆÁ¨¨‰∏Ä‰∏™tab‰∏∫active:', tabId);
                    } else {
                        $tabContent.hide(); // Á°Æ‰øùÈùûÊ¥ªÂä®tabÊòØÈöêËóèÁöÑ
                    }
                    $tabContent.html('<div class="tab-loading">Âä†ËΩΩ‰∏≠...</div>');
                    $tabsContent.append($tabContent);

                    // Ê£ÄÊü•templateIdÔºöÈúÄË¶ÅÊòéÁ°ÆÊ£ÄÊü•null„ÄÅundefinedÂíåÁ©∫Â≠óÁ¨¶‰∏≤Ôºå‰ª•ÂèäÊï∞Â≠ó0ÁöÑÊÉÖÂÜµ
                    const hasTemplateId = title.templateId !== null &&
                                         title.templateId !== undefined &&
                                         title.templateId !== '' &&
                                         String(title.templateId).trim() !== '';

                    // ÂØπ‰∫éÊâÄÊúâtabÔºåÂÖàËÆæÁΩÆÊòæÁ§∫Áä∂ÊÄÅÔºåÊ®°ÊùøÂä†ËΩΩÂ∞ÜÂú®ÂàõÂª∫ÂÆåÊâÄÊúâtabÂêéÁªü‰∏ÄËøõË°å
                    if (!hasTemplateId) {
                        console.warn('[loadTitles] titleÊ≤°ÊúâÊúâÊïàÁöÑtemplateIdÔºåË∑≥ËøáÊ®°ÊùøÂä†ËΩΩ:', {
                            titleId: title.id,
                            titleName: title.titleName,
                            templateId: title.templateId
                        });
                        $tabContent.html('<div class="empty-data">ËØ•Ê†áÈ¢òÊú™ÈÖçÁΩÆÊ®°ÊùøÔºàtemplateId‰∏∫Á©∫Ôºâ</div>');
                    }
                    // Ê≥®ÊÑèÔºöÊ®°ÊùøÂä†ËΩΩÂ∞ÜÂú®ÂàõÂª∫ÂÆåÊâÄÊúâtabÂêéÁªü‰∏ÄÂ§ÑÁêÜ
                });

                $tabsContainer.append($tabsHeader);
                $tabsContainer.append($tabsContent);
                $box.append($tabsContainer);

                // Á°Æ‰øùUIÁä∂ÊÄÅÊ≠£Á°ÆÔºöÊòæÁ§∫Ê†áÈ¢òÂå∫ÂüüÂíåÊ∑ªÂä†ÊåâÈíÆ
                $('#welcomeSection').hide();
                $('#titleSection').show();
                $('#btnAddTitle').show();
                $('#addTitleSection').hide();

                console.log('[loadTitles] Ê≠•È™§3: ÊâÄÊúâtabÂàõÂª∫ÂÆåÊàêÔºåÂºÄÂßã‰ΩøÁî®templateIdÊü•ËØ¢Ê®°ÊùøÊï∞ÊçÆ');

                // Ê≠•È™§3: ÂØπÁ¨¨‰∏Ä‰∏™titleÔºå‰ΩøÁî®ÂÖ∂templateIdÊü•ËØ¢Ê®°ÊùøÂπ∂Ê∏≤Êüì
                if (firstTitle && firstTabId) {
                    // Ê£ÄÊü•Á¨¨‰∏Ä‰∏™titleÊòØÂê¶ÊúâÊúâÊïàÁöÑtemplateId
                    const hasTemplateId = firstTitle.templateId !== null &&
                                         firstTitle.templateId !== undefined &&
                                         firstTitle.templateId !== '' &&
                                         String(firstTitle.templateId).trim() !== '';

                    if (hasTemplateId) {
                        const templateIdStr = typeof firstTitle.templateId === 'string'
                                            ? firstTitle.templateId.trim()
                                            : String(firstTitle.templateId);

                        console.log('[loadTitles] Ê≠•È™§3.1: ÂáÜÂ§á‰ΩøÁî®templateIdÊü•ËØ¢Ê®°Êùø:', {
                            tabId: firstTabId,
                            templateId: templateIdStr,
                            titleId: firstTitle.id,
                            titleName: firstTitle.titleName,
                            apiUrl: '/system/template/getInfoById'
                        });

                        // ‰ΩøÁî®templateIdË∞ÉÁî® /system/template/getInfoById Êé•Âè£Êü•ËØ¢Ê®°ÊùøÊï∞ÊçÆÂπ∂Ê∏≤Êüì
                        loadPromises.push(
                            loadTabContent(firstTabId, firstTitle, templateIdStr).then(function(result) {
                                console.log('[loadTitles] Ê≠•È™§3.2: Á¨¨‰∏Ä‰∏™titleÁöÑÊ®°ÊùøÂä†ËΩΩÊàêÂäü:', {
                                    tabId: firstTabId,
                                    templateId: templateIdStr,
                                    result: result
                                });
                                return result;
                            }).catch(function(error) {
                                console.error('[loadTitles] Ê≠•È™§3.2: Á¨¨‰∏Ä‰∏™titleÁöÑÊ®°ÊùøÂä†ËΩΩÂ§±Ë¥•:', {
                                    tabId: firstTabId,
                                    templateId: templateIdStr,
                                    error: error
                                });
                                // Âç≥‰ΩøÂ§±Ë¥•‰πüÁªßÁª≠ÔºåÂè™ÊòØËÆ∞ÂΩïÈîôËØØ
                                return { failed: true, tabId: firstTabId, error: error };
                            })
                        );
                    } else {
                        console.warn('[loadTitles] Á¨¨‰∏Ä‰∏™titleÊ≤°ÊúâÊúâÊïàÁöÑtemplateIdÔºåÊó†Ê≥ïÂä†ËΩΩÊ®°Êùø:', {
                            titleId: firstTitle.id,
                            titleName: firstTitle.titleName,
                            templateId: firstTitle.templateId
                        });
                        const $firstTabContent = $('#' + firstTabId);
                        if ($firstTabContent.length > 0) {
                            $firstTabContent.html('<div class="empty-data">ËØ•Ê†áÈ¢òÊú™ÈÖçÁΩÆÊ®°ÊùøÔºàtemplateId‰∏∫Á©∫Ôºâ</div>');
                        }
                    }
                } else {
                    console.warn('[loadTitles] Ê≤°ÊúâÁ¨¨‰∏Ä‰∏™titleÊàñfirstTabIdÔºåÊó†Ê≥ïÂä†ËΩΩÊ®°Êùø');
                }

                // Ê≠•È™§4: Á≠âÂæÖÊ®°ÊùøÂä†ËΩΩÂÆåÊàê
                if (loadPromises.length > 0) {
                    console.log('[loadTitles] Ê≠•È™§4: Á≠âÂæÖÊ®°ÊùøÂä†ËΩΩÂÆåÊàêÔºåÂÖ±', loadPromises.length, '‰∏™Ê®°Êùø');
                    Promise.all(loadPromises).then(function(results) {
                        console.log('[loadTitles] Ê≠•È™§4ÂÆåÊàê: ÊâÄÊúâÊ®°ÊùøÂä†ËΩΩÂÆåÊàê:', results);
                        // ÈöêËóèÂÖ®Â±ÄÂä†ËΩΩÈÅÆÁΩ©
                        $loadingOverlay.fadeOut(300, function() {
                            $(this).remove();
                        });
                    }).catch(function(error) {
                        console.error('[loadTitles] Ê≠•È™§4ÂºÇÂ∏∏: ÈÉ®ÂàÜÊ®°ÊùøÂä†ËΩΩÂ§±Ë¥•:', error);
                        // Âç≥‰ΩøÊúâÈîôËØØ‰πüÈöêËóèÂä†ËΩΩÈÅÆÁΩ©
                        $loadingOverlay.fadeOut(300, function() {
                            $(this).remove();
                        });
                    });
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâÈúÄË¶ÅÂä†ËΩΩÁöÑÊ®°ÊùøÔºåÁõ¥Êé•ÈöêËóèÂä†ËΩΩÈÅÆÁΩ©
                    console.log('[loadTitles] Ê≠•È™§4: Ê≤°ÊúâÈúÄË¶ÅÂä†ËΩΩÁöÑÊ®°ÊùøÔºåÁõ¥Êé•ÈöêËóèÂä†ËΩΩÈÅÆÁΩ©');
                    $loadingOverlay.fadeOut(300, function() {
                        $(this).remove();
                    });
                }
            },
            error: function(xhr, status, error) {
                console.error('[loadTitles] AJAXËØ∑Ê±ÇÂ§±Ë¥•:', {
                    status: status,
                    error: error,
                    statusCode: xhr.status,
                    responseText: xhr.responseText ? xhr.responseText.substring(0, 200) : 'Êó†ÂìçÂ∫îÂÜÖÂÆπ'
                });
                setTimeout(function() {
                    if ($box.length > 0) {
                        let errorMsg = 'Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï';
                        if (status === 'timeout') {
                            errorMsg = 'ËØ∑Ê±ÇË∂ÖÊó∂ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•';
                        } else if (xhr.status === 404) {
                            errorMsg = 'Êé•Âè£‰∏çÂ≠òÂú®Ôºà404Ôºâ';
                        } else if (xhr.status === 500) {
                            errorMsg = 'ÊúçÂä°Âô®ÈîôËØØÔºà500Ôºâ';
                        }
                        $box.html(`<div style="color:#e74c3c;padding:10px;">${errorMsg}</div>`);
                    }
                }, 500);
            }
        });
    }

    // Âè™Âà∑Êñ∞Ê†áÈ¢òÂàóË°®Â§¥ÈÉ®Ôºà‰∏çÂä†ËΩΩtabÂÜÖÂÆπÔºåÈÅøÂÖçË∞ÉÁî®getInfoByIdÔºâ
    function refreshTitlesList(contextId) {
        console.log('[refreshTitlesList] Âà∑Êñ∞Ê†áÈ¢òÂàóË°®Â§¥ÈÉ®ÔºåcontextId:', contextId);

        const $box = $('#titleList');
        if ($box.length === 0) {
            console.error('[refreshTitlesList] Êâæ‰∏çÂà∞ÂÆπÂô® #titleList');
            return;
        }

        // Á°Æ‰øù contextId ÊòØÂ≠óÁ¨¶‰∏≤Á±ªÂûã
        const contextIdStr = contextId ? String(contextId) : null;

        $.ajax({
            url: api.titleByContextId,
            method: 'GET',
            data: { contextId: contextIdStr },
            dataType: 'text',
            success: function(responseText) {
                // Ëá™ÂÆö‰πâ JSON Ëß£ÊûêÔºöÂ∞Ü templateId Â≠óÊÆµÁöÑÊâÄÊúâÊï∞Â≠óÂÄºËΩ¨Êç¢‰∏∫Â≠óÁ¨¶‰∏≤ÔºåÈÅøÂÖçÁ≤æÂ∫¶‰∏¢Â§±
                const fixedJson = responseText.replace(/"templateId"\s*:\s*(-?\d+)/g, '"templateId":"$1"');

                let res;
                try {
                    res = JSON.parse(fixedJson);
                } catch (e) {
                    try {
                        res = JSON.parse(responseText);
                    } catch (e2) {
                        console.error('[refreshTitlesList] JSONËß£ÊûêÂ§±Ë¥•:', e2);
                        return;
                    }
                }

                if (!res || res.code !== 2000) {
                    console.error('[refreshTitlesList] ÂìçÂ∫îÁ†Å‰∏çÊ≠£Á°Æ:', res ? res.code : 'Êó†ÂìçÂ∫î');
                    return;
                }

                const list = res.data || [];
                currentTitles = list;

                // Â¶ÇÊûúÂàóË°®‰∏∫Á©∫ÔºåÊòæÁ§∫Á©∫Áä∂ÊÄÅ
                if (!list.length) {
                    $box.empty();
                    $box.append('<div class="title-empty">ËØ•‰∏ä‰∏ãÊñáÊöÇÊó†Ê†áÈ¢ò</div>');
                    $('#welcomeSection').hide();
                    $('#titleSection').show();
                    $('#btnAddTitle').show();
                    $('#addTitleSection').hide();
                    activeTabId = null;
                    return;
                }

                // Âè™Êõ¥Êñ∞tabsÂ§¥ÈÉ®Ôºå‰øùÁïôÂ∑≤Âä†ËΩΩÁöÑtabÂÜÖÂÆπ
                const $tabsContainer = $box.find('.tabs-container');
                if ($tabsContainer.length === 0) {
                    // Â¶ÇÊûúÊ≤°ÊúâtabsÂÆπÂô®ÔºåËØ¥ÊòéËøôÊòØÁ¨¨‰∏ÄÊ¨°Âä†ËΩΩÔºåÁõ¥Êé•Ë∞ÉÁî®loadTitles
                    loadTitles(contextIdStr);
                    return;
                }

                const $tabsHeader = $tabsContainer.find('.tabs-header');
                const $tabsContent = $tabsContainer.find('.tabs-content-wrapper');

                // ‰øùÂ≠òÂΩìÂâçÊ¥ªÂä®ÁöÑtabÂÜÖÂÆπ
                const $currentActiveContent = $tabsContent.find('.tab-content.active');
                const currentActiveTabId = activeTabId;

                // Ê∏ÖÁ©∫Âπ∂ÈáçÊñ∞ÂàõÂª∫tabsÂ§¥ÈÉ®
                $tabsHeader.empty();

                // ‰∏∫ÊØè‰∏™Ê†áÈ¢òÂàõÂª∫ÈÄâÈ°πÂç°Â§¥ÈÉ®
                list.forEach((title, index) => {
                    const tabId = `tab-${title.id || index}`;

                    // Ê†πÊçÆhasConfigÁä∂ÊÄÅÂÜ≥ÂÆöÊòæÁ§∫ÂÜÖÂÆπ
                    let tabText, tabTitle;
                    if (currentContext.hasConfig === true || currentContext.hasConfig === 1 || currentContext.hasConfig === '1') {
                        tabText = escapeHtml(title.titleKey || title.titleName || 'Êú™ÂëΩÂêç');
                        tabTitle = escapeHtml(title.titleName || '');
                    } else {
                        tabText = escapeHtml(title.titleName || 'Êú™ÂëΩÂêç');
                        tabTitle = '';
                    }

                    // ÂàõÂª∫ÈÄâÈ°πÂç°Â§¥ÈÉ®
                    const $tabItemWrapper = $('<div class="tab-item-wrapper"></div>');
                    const $tabItem = $(`<button class="tab-item" data-tab-id="${tabId}"${tabTitle ? ` title="${tabTitle}"` : ''}>${tabText}</button>`);

                    // Â¶ÇÊûúËøô‰∏™tab‰πãÂâçÊòØÊ¥ªÂä®ÁöÑÔºå‰øùÊåÅÊ¥ªÂä®Áä∂ÊÄÅ
                    if (currentActiveTabId === tabId) {
                        $tabItem.addClass('active');
                    } else if (index === 0 && !currentActiveTabId) {
                        // Â¶ÇÊûúÊ≤°ÊúâÊ¥ªÂä®ÁöÑtabÔºåÊøÄÊ¥ªÁ¨¨‰∏Ä‰∏™
                        $tabItem.addClass('active');
                        activeTabId = tabId;
                    }

                    $tabItem.on('click', function(e) {
                        if (e.target === this || $(e.target).closest('.tab-item').length) {
                            switchTab(tabId);
                        }
                    });

                    // ÂàõÂª∫Êìç‰ΩúÊåâÈíÆÔºàÂè™‰øùÁïôÂà†Èô§ÊåâÈíÆÔºâ
                    const $tabActions = $('<div class="tab-item-actions"></div>');
                    const $deleteBtn = $('<button class="tab-action-btn delete" title="Âà†Èô§" data-title-id="' + title.id + '">√ó</button>');

                    $deleteBtn.on('click', function(e) {
                        e.stopPropagation();
                        deleteTitle(title.id, title.titleName || title.titleKey);
                    });

                    $tabActions.append($deleteBtn);
                    $tabItemWrapper.append($tabItem).append($tabActions);
                    $tabsHeader.append($tabItemWrapper);

                    // Â¶ÇÊûúËøô‰∏™tabÁöÑÂÜÖÂÆπËøò‰∏çÂ≠òÂú®ÔºåÂàõÂª∫‰∏Ä‰∏™Á©∫ÁöÑtabÂÜÖÂÆπÂÆπÂô®
                    let $tabContent = $tabsContent.find(`#${tabId}`);
                    if ($tabContent.length === 0) {
                        $tabContent = $(`<div class="tab-content" id="${tabId}"></div>`);
                        if (currentActiveTabId === tabId || (index === 0 && !currentActiveTabId)) {
                            $tabContent.addClass('active').show();
                        } else {
                            $tabContent.hide();
                        }
                        $tabContent.html('<div class="tab-loading">ÁÇπÂáªÂä†ËΩΩ...</div>');
                        $tabsContent.append($tabContent);
                    }
                });

                // ÁßªÈô§Â∑≤Âà†Èô§ÁöÑtabÂÜÖÂÆπÔºàÂ¶ÇÊûúÂàóË°®‰∏≠Ê≤°ÊúâÂØπÂ∫îÁöÑÊ†áÈ¢òÔºâ
                const existingTabIds = list.map(t => `tab-${t.id}`);
                $tabsContent.find('.tab-content').each(function() {
                    const tabId = $(this).attr('id');
                    if (tabId && !existingTabIds.includes(tabId)) {
                        $(this).remove();
                    }
                });

                // Â¶ÇÊûúÊ≤°ÊúâÊ¥ªÂä®ÁöÑtabÔºåÊøÄÊ¥ªÁ¨¨‰∏Ä‰∏™
                if (!activeTabId && list.length > 0) {
                    const firstTabId = `tab-${list[0].id || 0}`;
                    switchTab(firstTabId);
                }

                // Á°Æ‰øùUIÁä∂ÊÄÅÊ≠£Á°Æ
                $('#welcomeSection').hide();
                $('#titleSection').show();
                $('#btnAddTitle').show();
                $('#addTitleSection').hide();
            },
            error: function(xhr, status, error) {
                console.error('[refreshTitlesList] AJAXËØ∑Ê±ÇÂ§±Ë¥•:', status, error);
            }
        });
    }

    // ÂàáÊç¢ÈÄâÈ°πÂç°
    function switchTab(tabId) {
        // Â¶ÇÊûúÂàáÊç¢Âà∞Áõ∏ÂêåÁöÑtabÔºå‰∏çÂÅö‰ªª‰ΩïÊìç‰Ωú
        if (activeTabId === tabId) {
            console.log('[switchTab] ÂàáÊç¢Âà∞Áõ∏ÂêåÁöÑtabÔºåË∑≥Ëøá:', tabId);
            return;
        }

        // ÂèñÊ∂à‰πãÂâçtabÁöÑAJAXËØ∑Ê±ÇÔºàÂ¶ÇÊûúËøòÂú®ËøõË°å‰∏≠Ôºâ
        if (activeTabId && pendingAjaxRequests[activeTabId]) {
            console.log('[switchTab] ÂèñÊ∂à‰πãÂâçtabÁöÑAJAXËØ∑Ê±Ç:', activeTabId);
            pendingAjaxRequests[activeTabId].abort();
            delete pendingAjaxRequests[activeTabId];
        }

        // Êõ¥Êñ∞Ê¥ªÂä®tab ID
        activeTabId = tabId;

        // Êõ¥Êñ∞tabÊåâÈíÆÁä∂ÊÄÅ
        $('.tab-item').removeClass('active');
        $(`.tab-item[data-tab-id="${tabId}"]`).addClass('active');

        // ÈöêËóèÊâÄÊúâtabÂÜÖÂÆπÔºåÁ°Æ‰øùÂè™ÊúâÂΩìÂâçtabÂèØËßÅ
        $('.tab-content').removeClass('active').hide();
        const $tabContent = $(`#${tabId}`);
        $tabContent.addClass('active').show();

        // ÊØèÊ¨°ÂàáÊç¢tabÊó∂ÔºåÈÉΩÈáçÊñ∞Âä†ËΩΩËØ•titleÂØπÂ∫îÁöÑÊ®°ÊùøÂÜÖÂÆπ
        // Âõ†‰∏∫‰∏çÂêåÁöÑtitleÂèØËÉΩÂØπÂ∫î‰∏çÂêåÁöÑÊ®°ÊùøÔºåÈúÄË¶ÅÈáçÊñ∞Ê∏≤Êüì
        // ‰ªéÂ≠òÂÇ®ÁöÑ titles ‰∏≠ÊâæÂà∞ÂØπÂ∫îÁöÑ title
        const title = currentTitles.find(t => {
            const expectedTabId = `tab-${t.id || currentTitles.indexOf(t)}`;
            return expectedTabId === tabId;
        });

        if (title) {
            const hasTemplateId = title.templateId !== null &&
                                 title.templateId !== undefined &&
                                 title.templateId !== '' &&
                                 String(title.templateId).trim() !== '';

            if (hasTemplateId) {
                const templateIdStr = typeof title.templateId === 'string' ?
                                     title.templateId.trim() :
                                     String(title.templateId);

                console.log('[switchTab] ÂàáÊç¢tabÔºåÈáçÊñ∞Âä†ËΩΩÊ®°Êùø:', {
                    tabId: tabId,
                    titleId: title.id,
                    titleName: title.titleName,
                    templateId: templateIdStr
                });

                // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅÂπ∂ÈáçÊñ∞Âä†ËΩΩÊ®°ÊùøÂÜÖÂÆπ
                $tabContent.html('<div class="tab-loading">Ê≠£Âú®Âä†ËΩΩÊ®°Êùø...</div>');
                loadTabContent(tabId, title, templateIdStr);
            } else {
                $tabContent.html('<div class="empty-data">ËØ•Ê†áÈ¢òÊú™ÈÖçÁΩÆÊ®°ÊùøÔºàtemplateId‰∏∫Á©∫Ôºâ</div>');
            }
        } else {
            console.warn('[switchTab] Êâæ‰∏çÂà∞ÂØπÂ∫îÁöÑtitle:', tabId);
            $tabContent.html('<div class="empty-data">Êâæ‰∏çÂà∞ÂØπÂ∫îÁöÑÊ†áÈ¢ò‰ø°ÊÅØ</div>');
        }
    }

    // Âä†ËΩΩÈÄâÈ°πÂç°ÂÜÖÂÆπÔºàÊ®°Êùø‰ø°ÊÅØ + Êï∞ÊçÆË°®Ê†ºÔºâ
    // ÊµÅÁ®ãÔºö1. ÈÄöËøá templateId Ë∞ÉÁî®Ê®°Êùø controller Ëé∑ÂèñÊ®°Êùø‰ø°ÊÅØ
    //      2. Ëß£ÊûêÊ®°ÊùøÁöÑÂàóÂÆö‰πâÔºàcolumnDefinitionsÔºâ
    //      3. Ê∏≤ÊüìË°®Ê†ºÁªìÊûÑ
    //      4. ÈÄöËøá templateType Âä†ËΩΩÈÖçÁΩÆÊï∞ÊçÆÂπ∂Ê∏≤Êüì
    // ËøîÂõûPromiseÔºåÁî®‰∫éÁ≠âÂæÖÂä†ËΩΩÂÆåÊàê
    function loadTabContent(tabId, title, templateId) {
        return new Promise(function(resolve, reject) {
            const $tabContent = $(`#${tabId}`);

            // Á°Æ‰øùtabContentÂ≠òÂú®
            if ($tabContent.length === 0) {
                console.warn('[loadTabContent] tabContent‰∏çÂ≠òÂú®:', tabId);
                reject(new Error('Tab content not found: ' + tabId));
                return;
            }

            // È™åËØÅtemplateId
            if (!templateId || String(templateId).trim() === '') {
                console.error('[loadTabContent] templateIdÊó†Êïà:', {
                    tabId: tabId,
                    templateId: templateId,
                    titleId: title && title.id,
                    titleName: title && title.titleName
                });
                $tabContent.html('<div class="empty-data">Ê®°ÊùøIDÊó†ÊïàÔºåÊó†Ê≥ïÂä†ËΩΩÊ®°Êùø</div>');
                reject(new Error('Invalid templateId'));
                return;
            }

            // ÂÆâÂÖ®Âú∞ÊâìÂç∞Êó•ÂøóÔºåÈÅøÂÖçÊâìÂç∞Êï¥‰∏™titleÂØπË±°
            try {
                console.log('[loadTabContent] ÂºÄÂßãÂä†ËΩΩÊ®°Êùø:', {
                    tabId: tabId,
                    templateId: templateId,
                    templateIdType: typeof templateId,
                    titleId: title && title.id,
                    titleName: title && title.titleName
                });
            } catch (e) {
                console.log('[loadTabContent] ÂºÄÂßãÂä†ËΩΩÊ®°Êùø:', { tabId: tabId, templateId: templateId });
            }

            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            $tabContent.html('<div class="tab-loading">Ê≠£Âú®Âä†ËΩΩÊ®°Êùø‰ø°ÊÅØ...</div>');

            // ÊûÑÂª∫ËØ∑Ê±ÇÂèÇÊï∞
            const requestData = { id: String(templateId).trim() };
            console.log('[loadTabContent] ËØ∑Ê±ÇÊ®°Êùø‰ø°ÊÅØÔºåURL: /system/template/getInfoById, ÂèÇÊï∞:', requestData);

            // ÂèñÊ∂àËØ•tab‰πãÂâçÁöÑAJAXËØ∑Ê±ÇÔºàÂ¶ÇÊûúËøòÂú®ËøõË°å‰∏≠Ôºâ
            if (pendingAjaxRequests[tabId]) {
                console.log('[loadTabContent] ÂèñÊ∂àËØ•tab‰πãÂâçÁöÑAJAXËØ∑Ê±Ç:', tabId);
                pendingAjaxRequests[tabId].abort();
            }

            // Á¨¨‰∏ÄÊ≠•ÔºöË∞ÉÁî®Ê®°Êùø controller Ëé∑ÂèñÊ®°Êùø‰ø°ÊÅØ
            const xhr = $.ajax({
                url: '/system/template/getInfoById',
                method: 'GET',
                data: requestData,
                dataType: 'json',
                timeout: 30000, // 30ÁßíË∂ÖÊó∂
                success: function(res) {
                    console.log('[loadTabContent] Ê®°Êùø‰ø°ÊÅØÂìçÂ∫î:', {
                        tabId: tabId,
                        templateId: templateId,
                        responseCode: res && res.code,
                        hasData: !!(res && res.data)
                    });

                    // Ê∏ÖÁêÜpendingËØ∑Ê±ÇËÆ∞ÂΩï
                    if (pendingAjaxRequests[tabId] === xhr) {
                        delete pendingAjaxRequests[tabId];
                    }

                    // Ê£ÄÊü•tabÊòØÂê¶‰ªçÁÑ∂ÊòØÊ¥ªÂä®ÁöÑÔºàÈò≤Ê≠¢Âú®Âä†ËΩΩËøáÁ®ã‰∏≠ÂàáÊç¢‰∫ÜtabÔºâ
                    if (activeTabId !== tabId) {
                        console.warn('[loadTabContent] tabÂ∑≤ÂàáÊç¢ÔºåÂΩìÂâçactiveTabId:', activeTabId, 'ËØ∑Ê±ÇÁöÑtabId:', tabId, 'Ë∑≥ËøáÊï∞ÊçÆÂ§ÑÁêÜ');
                        resolve({ skipped: true, reason: 'tab_switched' });
                        return;
                    }

                    // ÂÜçÊ¨°Ê£ÄÊü•tabContentÊòØÂê¶Â≠òÂú®ÔºàÈò≤Ê≠¢Âú®Âä†ËΩΩËøáÁ®ã‰∏≠Ë¢´ÁßªÈô§Ôºâ
                    if ($tabContent.length === 0) {
                        console.warn('[loadTabContent] tabContentÂ∑≤Ë¢´ÁßªÈô§ÔºåË∑≥ËøáÊï∞ÊçÆÂ§ÑÁêÜ:', tabId);
                        resolve({ skipped: true, reason: 'tab_removed' });
                        return;
                    }

                    // Ê£ÄÊü•tabContentÊòØÂê¶‰ªçÁÑ∂ÊòØÊ¥ªÂä®ÁöÑ
                    if (!$tabContent.hasClass('active')) {
                        console.warn('[loadTabContent] tabContent‰∏çÂÜçÊòØÊ¥ªÂä®ÁöÑÔºåË∑≥ËøáÊï∞ÊçÆÂ§ÑÁêÜ:', tabId);
                        resolve({ skipped: true, reason: 'tab_inactive' });
                        return;
                    }

                    if (res && res.code === 2000 && res.data) {
                        const template = res.data;

                        // È™åËØÅÊ®°ÊùøÊï∞ÊçÆÂÆåÊï¥ÊÄß
                        if (!template.templateType) {
                            console.error('[loadTabContent] Ê®°ÊùøÁº∫Â∞ëtemplateType:', template);
                            $tabContent.html('<div class="empty-data">Ê®°ÊùøÊï∞ÊçÆ‰∏çÂÆåÊï¥ÔºöÁº∫Â∞ëtemplateType</div>');
                            reject(new Error('Template missing templateType'));
                            return;
                        }

                        if (!template.columnDefinitions) {
                            console.error('[loadTabContent] Ê®°ÊùøÁº∫Â∞ëcolumnDefinitions:', template);
                            $tabContent.html('<div class="empty-data">Ê®°ÊùøÊï∞ÊçÆ‰∏çÂÆåÊï¥ÔºöÁº∫Â∞ëÂàóÂÆö‰πâ(columnDefinitions)</div>');
                            reject(new Error('Template missing columnDefinitions'));
                            return;
                        }

                        console.log('[loadTabContent] Ê®°ÊùøÊï∞ÊçÆËé∑ÂèñÊàêÂäüÔºåÂºÄÂßãÊ∏≤ÊüìË°®Ê†º:', {
                            tabId: tabId,
                            templateId: templateId,
                            templateName: template.templateName,
                            templateType: template.templateType,
                            hasColumnDefinitions: !!template.columnDefinitions
                        });

                        // Á¨¨‰∫åÊ≠•ÔºöÊ∏≤ÊüìÊï∞ÊçÆË°®Ê†ºÔºàÂåÖÊã¨Ë°®Â§¥ÂíåÁªìÊûÑÔºâ
                        // Á¨¨‰∏âÊ≠•ÔºöÂú® renderDataTable ‰∏≠‰ºöË∞ÉÁî® loadConfigData Âä†ËΩΩÈÖçÁΩÆÊï∞ÊçÆ
                        renderDataTable($tabContent, title, template);
                        resolve({ success: true, tabId: tabId, templateId: templateId });
                    } else {
                        const errorMsg = res && res.msg ? res.msg : (res ? 'ÂìçÂ∫îÊï∞ÊçÆÊ†ºÂºèÈîôËØØ' : 'Êú™Áü•ÈîôËØØ');
                        console.error('[loadTabContent] Ê®°Êùø‰ø°ÊÅØÂä†ËΩΩÂ§±Ë¥•:', {
                            tabId: tabId,
                            templateId: templateId,
                            errorMsg: errorMsg,
                            responseCode: res && res.code
                        });
                        $tabContent.html(`<div class="empty-data">Ê®°Êùø‰ø°ÊÅØÂä†ËΩΩÂ§±Ë¥•: ${errorMsg}<br/>Ê®°ÊùøID: ${templateId}</div>`);
                        reject(new Error(errorMsg));
                    }
                },
                error: function(xhrRequest, status, error) {
                    // Ê∏ÖÁêÜpendingËØ∑Ê±ÇËÆ∞ÂΩï
                    if (pendingAjaxRequests[tabId] === xhr) {
                        delete pendingAjaxRequests[tabId];
                    }

                    // Â¶ÇÊûúÊòØ‰∏ªÂä®ÂèñÊ∂àÁöÑËØ∑Ê±ÇÔºå‰∏çÈúÄË¶ÅÊòæÁ§∫ÈîôËØØ
                    if (status === 'abort') {
                        console.log('[loadTabContent] AJAXËØ∑Ê±ÇË¢´ÂèñÊ∂à:', tabId);
                        resolve({ skipped: true, reason: 'aborted' });
                        return;
                    }

                    // Ê£ÄÊü•tabÊòØÂê¶‰ªçÁÑ∂ÊòØÊ¥ªÂä®ÁöÑ
                    if (activeTabId !== tabId) {
                        console.warn('[loadTabContent] tabÂ∑≤ÂàáÊç¢ÔºåË∑≥ËøáÈîôËØØÂ§ÑÁêÜ:', tabId);
                        resolve({ skipped: true, reason: 'tab_switched' });
                        return;
                    }

                    // ÂÜçÊ¨°Ê£ÄÊü•tabContentÊòØÂê¶Â≠òÂú®
                    if ($tabContent.length === 0) {
                        console.warn('[loadTabContent] tabContentÂ∑≤Ë¢´ÁßªÈô§ÔºåË∑≥ËøáÈîôËØØÂ§ÑÁêÜ:', tabId);
                        resolve({ skipped: true, reason: 'tab_removed' });
                        return;
                    }

                    // Ê£ÄÊü•tabContentÊòØÂê¶‰ªçÁÑ∂ÊòØÊ¥ªÂä®ÁöÑ
                    if (!$tabContent.hasClass('active')) {
                        console.warn('[loadTabContent] tabContent‰∏çÂÜçÊòØÊ¥ªÂä®ÁöÑÔºåË∑≥ËøáÈîôËØØÂ§ÑÁêÜ:', tabId);
                        resolve({ skipped: true, reason: 'tab_inactive' });
                        return;
                    }

                    console.error('[loadTabContent] AJAXËØ∑Ê±ÇÂ§±Ë¥•:', {
                        tabId: tabId,
                        templateId: templateId,
                        status: status,
                        error: error,
                        statusCode: xhrRequest.status
                    });

                    let errorMsg = 'Ê®°Êùø‰ø°ÊÅØÂä†ËΩΩÂ§±Ë¥•';
                    if (status === 'timeout') {
                        errorMsg = 'ËØ∑Ê±ÇË∂ÖÊó∂ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñÁ®çÂêéÈáçËØï';
                    } else if (status === 'error') {
                        errorMsg = 'ÁΩëÁªúÈîôËØØÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•';
                        if (xhrRequest.status === 404) {
                            errorMsg = 'Ê®°Êùø‰∏çÂ≠òÂú®Ôºà404Ôºâ';
                        } else if (xhrRequest.status === 500) {
                            errorMsg = 'ÊúçÂä°Âô®ÂÜÖÈÉ®ÈîôËØØÔºà500Ôºâ';
                        }
                        if (xhrRequest.responseText) {
                            try {
                                const errorRes = JSON.parse(xhrRequest.responseText);
                                if (errorRes.msg) {
                                    errorMsg = errorRes.msg;
                                }
                            } catch (e) {
                                // ÂøΩÁï•Ëß£ÊûêÈîôËØØ
                            }
                        }
                    }
                    $tabContent.html(`<div class="empty-data">${errorMsg}<br/>Ê®°ÊùøID: ${templateId}</div>`);
                    reject(new Error(errorMsg));
                }
            });

            // ‰øùÂ≠òAJAXËØ∑Ê±Ç‰ª•‰æøÂêéÁª≠ÂèØ‰ª•ÂèñÊ∂à
            pendingAjaxRequests[tabId] = xhr;
        });
    }

    // Ê∏≤ÊüìÊï∞ÊçÆË°®Ê†º
    function renderDataTable($container, title, template) {
        console.log('[renderDataTable] ÂºÄÂßãÊ∏≤ÊüìÊï∞ÊçÆË°®Ê†º:', {
            templateName: template.templateName,
            templateType: template.templateType,
            columnDefinitions: template.columnDefinitions,
            hasConfig: currentContext.hasConfig
        });

        // Á°Æ‰øùÂÆπÂô®Â≠òÂú®
        if ($container.length === 0) {
            console.error('[renderDataTable] ÂÆπÂô®‰∏çÂ≠òÂú®');
            return;
        }

        // Âà§Êñ≠ÊòØÂê¶‰∏∫Â∑≤ÈÖçÁΩÆÁöÑcontext
        const isConfiguredContext = currentContext.hasConfig === true || currentContext.hasConfig === 1 || currentContext.hasConfig === '1';

        // Ëß£ÊûêÂàóÂÆö‰πâ
        let columns = [];
        try {
            const columnDefsStr = template.columnDefinitions || '{}';
            console.log('[renderDataTable] ÂàóÂÆö‰πâÂ≠óÁ¨¶‰∏≤:', columnDefsStr);
            const columnDefs = JSON.parse(columnDefsStr);
            columns = columnDefs.columns || [];
            console.log('[renderDataTable] Ëß£ÊûêÂêéÁöÑÂàó:', columns);
        } catch (e) {
            console.error('[renderDataTable] Ëß£ÊûêÂàóÂÆö‰πâÂ§±Ë¥•:', e, 'ÂéüÂßãÊï∞ÊçÆ:', template.columnDefinitions);
            $container.html(`<div class="empty-data">Ê®°ÊùøÂàóÂÆö‰πâÊ†ºÂºèÈîôËØØ: ${e.message}</div>`);
            return;
        }

        // Ê£ÄÊü•ÂàóÂÆö‰πâ
        if (columns.length === 0) {
            console.warn('[renderDataTable] Ê®°ÊùøÊú™ÂÆö‰πâÂàó');
            $container.html('<div class="empty-data">Ê®°ÊùøÊú™ÂÆö‰πâÂàó</div>');
            return;
        }

        // ÂàõÂª∫Êï∞ÊçÆË°®Ê†ºÂÆπÂô®ÔºåÂπ∂Â≠òÂÇ®ÂøÖË¶ÅÁöÑ‰∏ä‰∏ãÊñá‰ø°ÊÅØ
        const $tableContainer = $('<div class="data-table-container"></div>');
        $tableContainer.attr('data-title-id', title.id);
        $tableContainer.attr('data-template-type', template.templateType);
        $tableContainer.attr('data-is-configured', isConfiguredContext ? '1' : '0');
        $tableContainer.attr('data-title-info', JSON.stringify(title));
        const $tableHeader = $('<div class="data-table-header"></div>');
        $tableHeader.append(`<h3>${escapeHtml(template.templateName || 'Êú™ÂëΩÂêçÊ®°Êùø')}</h3>`);

        // Ê∑ªÂä†"ÂºÄÂêØÁºñËæë"ÊåâÈíÆ
        const $enableEditBtn = $('<button class="btn-enable-edit">üîì ÂºÄÂêØÁºñËæë</button>');
        $enableEditBtn.on('click', function() {
            toggleEditMode($tableContainer, true);
        });
        $tableHeader.append($enableEditBtn);

        // Ê∑ªÂä†"ÂÖ≥Èó≠ÁºñËæë"ÊåâÈíÆÔºàÂàùÂßãÈöêËóèÔºâ
        const $disableEditBtn = $('<button class="btn-disable-edit editing-disabled">üîí ÂÖ≥Èó≠ÁºñËæë</button>');
        $disableEditBtn.on('click', function() {
            toggleEditMode($tableContainer, false);
        });
        $tableHeader.append($disableEditBtn);

        // Êó†ËÆ∫ÊòØÂê¶Â∑≤ÈÖçÁΩÆÔºåÈÉΩÊòæÁ§∫Ê∑ªÂä†ÊåâÈíÆÔºàÂÖÅËÆ∏Âú®Â∑≤ÈÖçÁΩÆÁöÑcontext‰∏≠Ê∑ªÂä†Êï∞ÊçÆÔºâÔºå‰ΩÜÈªòËÆ§ÈöêËóè
        const columnsJson = encodeURIComponent(JSON.stringify(columns));
        const $addBtn = $(`<button class="btn-add-row editing-disabled" data-title-id="${title.id}" data-template-type="${template.templateType}" data-columns='${columnsJson}'>+ Ê∑ªÂä†Êï∞ÊçÆË°å</button>`);
        $addBtn.on('click', function() {
            const titleId = $(this).attr('data-title-id');
            const templateType = $(this).attr('data-template-type');
            const colsJson = decodeURIComponent($(this).attr('data-columns'));
            addTableRow(titleId, templateType, colsJson);
        });
        $tableHeader.append($addBtn);
        $tableContainer.append($tableHeader);

        // ÂàõÂª∫Ë°®Ê†º - Áªü‰∏ÄÊòæÁ§∫ÊâÄÊúâÂàóÔºàÂ∑≤ÈÖçÁΩÆÂíåÊú™ÈÖçÁΩÆÁöÑcontextÈÉΩÊòæÁ§∫ÊâÄÊúâÂàóÔºâ
        const $table = $('<table class="data-table"></table>');
        const $thead = $('<thead></thead>');
        const $theadRow = $('<tr></tr>');

        // Ê∑ªÂä†ÂàóÂ§¥ - ÊòæÁ§∫keyÔºåÊÇ¨ÊµÆÊòæÁ§∫‰∏≠Êñá
        columns.forEach(col => {
            const colKey = escapeHtml(col.name);
            const colLabel = escapeHtml(col.label || col.name);
            const requiredMark = col.required === 'yes' ? ' <span style="color:red;">*</span>' : '';
            $theadRow.append(`<th title="${colLabel}">${colKey}${requiredMark}</th>`);
        });
        $theadRow.append('<th class="action-column">Êìç‰Ωú</th>');
        $thead.append($theadRow);
        $table.append($thead);

        const $tbody = $('<tbody></tbody>');
        $table.append($tbody);

        // ÂàõÂª∫Ë°®Ê†ºÂåÖË£ÖÂô®ÔºåÁî®‰∫éÊªöÂä®
        const $tableWrapper = $('<div class="data-table-wrapper"></div>');
        $tableWrapper.append($table);
        $tableContainer.append($tableWrapper);

        // Ê∑ªÂä†Èº†Ê†áÊªëËΩÆÊ®™ÂêëÊªöÂä®ÂäüËÉΩ
        // ÂΩìË°®Ê†ºÂÜÖÂÆπËøáÂÆΩÊó∂ÔºåÈº†Ê†áÊªëËΩÆÈªòËÆ§ËøõË°åÊ®™ÂêëÊªöÂä®Ôºå‰πüÂèØ‰ª•Êåâ‰ΩèShiftÈîÆÊ®™ÂêëÊªöÂä®
        $tableWrapper.on('wheel', function(e) {
            const element = this;
            const hasHorizontalScroll = element.scrollWidth > element.clientWidth;
            const hasVerticalScroll = element.scrollHeight > element.clientHeight;
            const deltaX = e.originalEvent.deltaX || 0;
            const deltaY = e.originalEvent.deltaY || 0;

            // Â¶ÇÊûúÂ∑≤ÁªèÊúâÊ®™ÂêëÊªöÂä®‰∫ã‰ª∂ÔºàÊüê‰∫õÈº†Ê†áÊîØÊåÅÊ®™ÂêëÊªöËΩÆÔºâÔºåËÆ©ÊµèËßàÂô®ÈªòËÆ§Â§ÑÁêÜ
            if (Math.abs(deltaX) > 0) {
                return;
            }

            // Â¶ÇÊûúÊúâÊ®™ÂêëÊªöÂä®Êù°
            if (hasHorizontalScroll) {
                // ÊñπÂºè1: Êåâ‰ΩèShiftÈîÆÊó∂ÔºåÂûÇÁõ¥ÊªöÂä®ËΩ¨‰∏∫Ê®™ÂêëÊªöÂä®
                if (e.originalEvent.shiftKey && Math.abs(deltaY) > 0) {
                    e.preventDefault();
                    element.scrollLeft += deltaY;
                    return;
                }

                // ÊñπÂºè2: Â¶ÇÊûúÂêåÊó∂ÊúâÂûÇÁõ¥ÊªöÂä®Êù°ÔºåÊ£ÄÊü•Èº†Ê†á‰ΩçÁΩÆ
                // Â¶ÇÊûúÈº†Ê†áÂú®Ê®™ÂêëÊªöÂä®Êù°ÈôÑËøëÔºàÂ∫ïÈÉ®Âå∫ÂüüÔºâÔºåÊªëËΩÆÁõ¥Êé•Ê®™ÂêëÊªöÂä®
                if (hasVerticalScroll) {
                    const rect = element.getBoundingClientRect();
                    const mouseY = e.originalEvent.clientY - rect.top;
                    const isNearBottom = mouseY > rect.height - 20; // Â∫ïÈÉ®20pxÂå∫Âüü

                    // Â¶ÇÊûúÈº†Ê†áÂú®Â∫ïÈÉ®Âå∫ÂüüÔºàÊé•ËøëÊ®™ÂêëÊªöÂä®Êù°ÔºâÔºåÊªëËΩÆÊ®™ÂêëÊªöÂä®
                    if (isNearBottom && Math.abs(deltaY) > 0) {
                        e.preventDefault();
                        element.scrollLeft += deltaY;
                        return;
                    }
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâÂûÇÁõ¥ÊªöÂä®Êù°ÔºåÂè™ÊúâÊ®™ÂêëÊªöÂä®Êù°ÔºåÊªëËΩÆÁõ¥Êé•Ê®™ÂêëÊªöÂä®
                    if (Math.abs(deltaY) > 0) {
                        e.preventDefault();
                        element.scrollLeft += deltaY;
                        return;
                    }
                }
            }
        });

        // ÂàõÂª∫ÂéÜÂè≤ÁâàÊú¨Êï∞ÊçÆÂ±ïÁ§∫Âå∫Âüü
        const $versionHistoryContainer = $('<div class="version-history-container"></div>');
        const $versionHistoryHeader = $('<div class="version-history-header"></div>');
        $versionHistoryHeader.append('<h4>üìú ÂéÜÂè≤ÁâàÊú¨ËÆ∞ÂΩï</h4>');
        const $versionHistoryContent = $('<div class="version-history-content"></div>');
        $versionHistoryContainer.append($versionHistoryHeader);
        $versionHistoryContainer.append($versionHistoryContent);
        
        // Ê∏ÖÁ©∫ÂÆπÂô®Âπ∂Ê∑ªÂä†Ë°®Ê†ºÂíåÂéÜÂè≤ÁâàÊú¨Âå∫Âüü
        $container.empty().append($tableContainer).append($versionHistoryContainer);
        console.log('[renderDataTable] Ë°®Ê†ºÁªìÊûÑÂ∑≤ÂàõÂª∫ÔºåÂºÄÂßãÂä†ËΩΩÈÖçÁΩÆÊï∞ÊçÆ', {
            templateType: template.templateType,
            titleId: title.id,
            columnCount: columns.length,
            isConfiguredContext: isConfiguredContext
        });

        // Á°Æ‰øùÂ¶ÇÊûúÂÆπÂô®ÊòØactiveÁöÑÔºåÂÆÉËÉΩÊ≠£Á°ÆÊòæÁ§∫
        if ($container.hasClass('active')) {
            $container.css('display', 'block');
        }

                    // Á¨¨ÂõõÊ≠•ÔºöÈ¢ÑÂä†ËΩΩÂ≠óÂÖ∏Êï∞ÊçÆÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
        // Êî∂ÈõÜÊâÄÊúâÈúÄË¶Å‰ΩøÁî®ÁöÑÂ≠óÂÖ∏Á±ªÂûãÔºåÈ¢ÑÂÖàÂä†ËΩΩÂà∞ÁºìÂ≠ò‰∏≠
        const dictTypes = [];
        columns.forEach(col => {
            if (col.useDict && col.dictType && dictTypes.indexOf(col.dictType) === -1) {
                dictTypes.push(col.dictType);
            }
        });

        // È¢ÑÂä†ËΩΩÂ≠óÂÖ∏Êï∞ÊçÆÔºàÂºÇÊ≠•Ôºå‰∏çÈòªÂ°ûÔºâ
        if (dictTypes.length > 0) {
            dictTypes.forEach(dictType => {
                if (!dictDataCache[dictType]) {
                    $.ajax({
                        url: '/system/dictData/listByDictType',
                        method: 'GET',
                        data: { dictType: dictType },
                        dataType: 'json',
                        success: function(res) {
                            if (res.code === 2000 && res.data) {
                                dictDataCache[dictType] = res.data;
                            }
                        }
                    });
                }
            });
        }

        // Á¨¨‰∫îÊ≠•ÔºöÂä†ËΩΩÈÖçÁΩÆÊï∞ÊçÆÂπ∂Ê∏≤ÊüìÂà∞Ë°®Ê†º
        // ÈÄöËøá titleId Êü•ËØ¢ÂØπÂ∫îÁöÑÈÖçÁΩÆÊï∞ÊçÆ
        loadConfigData($tbody, columns, title.id, isConfiguredContext, title);
        
        // Á¨¨ÂÖ≠Ê≠•ÔºöÂä†ËΩΩÂéÜÂè≤ÁâàÊú¨Êï∞ÊçÆ
        loadVersionHistory(title.id, $versionHistoryContent);
    }

    // Âä†ËΩΩÈÖçÁΩÆÊï∞ÊçÆ
    // ÈÄöËøá titleId Ë∞ÉÁî®ÈÖçÁΩÆÊï∞ÊçÆ controller Ëé∑ÂèñÊï∞ÊçÆÂπ∂Ê∏≤ÊüìÂà∞Ë°®Ê†º
    function loadConfigData($tbody, columns, titleId, isConfiguredContext, titleInfo) {
        // Áªü‰∏Ä‰ΩøÁî®ÊâÄÊúâÂàó + Êìç‰ΩúÂàó
        const colCount = columns.length + 1;

        // ÊòæÁ§∫Âä†ËΩΩ‰∏≠Áä∂ÊÄÅ
        $tbody.html('<tr><td colspan="' + colCount + '" style="text-align:center;padding:20px;">Ê≠£Âú®Âä†ËΩΩÈÖçÁΩÆÊï∞ÊçÆ...</td></tr>');

        // È™åËØÅ titleId
        if (!titleId || String(titleId).trim() === '') {
            console.error('[loadConfigData] titleIdÊó†Êïà:', { titleId });
            $tbody.html(`<tr><td colspan="${colCount}" style="text-align:center;color:#e74c3c;">Ê†áÈ¢òIDÊó†ÊïàÔºåÊó†Ê≥ïÂä†ËΩΩÊï∞ÊçÆ</td></tr>`);
            return;
        }

        console.log('[loadConfigData] ÂºÄÂßãÂä†ËΩΩÈÖçÁΩÆÊï∞ÊçÆ:', {
            titleId: titleId,
            columnCount: columns.length,
            isConfiguredContext: isConfiguredContext
        });

        // ÈÄöËøá titleId Âä†ËΩΩÊï∞ÊçÆ
        $.ajax({
            url: '/system/configData/getConfigDataByTitleId',
            method: 'GET',
            data: { titleId: String(titleId).trim() },
            dataType: 'json',
            timeout: 30000, // 30ÁßíË∂ÖÊó∂
            success: function(res) {
                // Á°Æ‰øùtbody‰ªçÁÑ∂Â≠òÂú®ÔºàÈò≤Ê≠¢Âú®Âä†ËΩΩËøáÁ®ã‰∏≠Ë¢´ÁßªÈô§Ôºâ
                if ($tbody.length === 0) {
                    console.warn('[loadConfigData] tbodyÂ∑≤Ë¢´ÁßªÈô§ÔºåË∑≥ËøáÊï∞ÊçÆÂ§ÑÁêÜ');
                    return;
                }

                console.log('[loadConfigData] ÈÖçÁΩÆÊï∞ÊçÆÂìçÂ∫î:', {
                    titleId: titleId,
                    responseCode: res && res.code,
                    dataCount: (res && res.data && res.data.length) || 0
                });

                if (res && res.code === 2000) {
                    const dataList = res.data || [];
                    console.log('[loadConfigData] Ëé∑ÂèñÂà∞ÈÖçÁΩÆÊï∞ÊçÆÔºåÂºÄÂßãÊ∏≤Êüì:', {
                        titleId: titleId,
                        dataCount: dataList.length
                    });

                    // ‰ªé $tableContainer Ëé∑Âèñ templateTypeÔºàÂ¶ÇÊûúÂ≠òÂú®ÔºâÔºåÁî®‰∫é renderDataRows
                    const $tableContainer = $tbody.closest('.data-table-container');
                    const templateType = $tableContainer.attr('data-template-type') || null;

                    // Ê∏≤ÊüìÊï∞ÊçÆË°åÂà∞Ë°®Ê†º
                    renderDataRows($tbody, dataList, columns, templateType, isConfiguredContext, titleInfo);

                    // Êï∞ÊçÆÂä†ËΩΩÂÆåÊàêÂêéÔºåÂ¶ÇÊûúÂÖ®Â±ÄÁºñËæëÊ®°ÂºèÂ∑≤ÂºÄÂêØÔºåËá™Âä®ÊÅ¢Â§çÁºñËæëÁä∂ÊÄÅ
                    if (globalEditModeEnabled) {
                        const $tableContainer = $tbody.closest('.data-table-container');
                        if ($tableContainer.length > 0) {
                            console.log('[loadConfigData] ÊÅ¢Â§çÁºñËæëÊ®°ÂºèÁä∂ÊÄÅ');
                            toggleEditMode($tableContainer, true);
                        }
                    }
                } else {
                    const errorMsg = res && res.msg ? res.msg : 'Êú™Áü•ÈîôËØØ';
                    console.error('[loadConfigData] ÈÖçÁΩÆÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:', {
                        titleId: titleId,
                        errorMsg: errorMsg,
                        responseCode: res && res.code
                    });
                    $tbody.html(`<tr><td colspan="${colCount}" style="text-align:center;color:#e74c3c;">Âä†ËΩΩÂ§±Ë¥•: ${errorMsg}</td></tr>`);
                }
            },
            error: function(xhr, status, error) {
                // Á°Æ‰øùtbody‰ªçÁÑ∂Â≠òÂú®
                if ($tbody.length === 0) {
                    console.warn('[loadConfigData] tbodyÂ∑≤Ë¢´ÁßªÈô§ÔºåË∑≥ËøáÈîôËØØÂ§ÑÁêÜ');
                    return;
                }

                console.error('[loadConfigData] AJAXËØ∑Ê±ÇÂ§±Ë¥•:', {
                    titleId: titleId,
                    status: status,
                    error: error,
                    statusCode: xhr.status
                });

                let errorMsg = 'Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï';
                if (status === 'timeout') {
                    errorMsg = 'ËØ∑Ê±ÇË∂ÖÊó∂ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñÁ®çÂêéÈáçËØï';
                } else if (status === 'error') {
                    errorMsg = 'ÁΩëÁªúÈîôËØØÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•';
                    if (xhr.status === 404) {
                        errorMsg = 'ÈÖçÁΩÆÊï∞ÊçÆÊé•Âè£‰∏çÂ≠òÂú®Ôºà404Ôºâ';
                    } else if (xhr.status === 500) {
                        errorMsg = 'ÊúçÂä°Âô®ÂÜÖÈÉ®ÈîôËØØÔºà500Ôºâ';
                    }
                    if (xhr.responseText) {
                        try {
                            const errorRes = JSON.parse(xhr.responseText);
                            if (errorRes.msg) {
                                errorMsg = errorRes.msg;
                            }
                        } catch (e) {
                            // ÂøΩÁï•Ëß£ÊûêÈîôËØØ
                        }
                    }
                }
                $tbody.html(`<tr><td colspan="${colCount}" style="text-align:center;color:#e74c3c;">${errorMsg}</td></tr>`);
            }
        });
    }

    // Ê∏≤ÊüìÊï∞ÊçÆË°åÔºàÁªü‰∏ÄÂ§ÑÁêÜÂ∑≤ÈÖçÁΩÆÂíåÊú™ÈÖçÁΩÆÁöÑcontextÔºâ
    // Â∞ÜÈÖçÁΩÆÊï∞ÊçÆÊ∏≤ÊüìÂà∞Ë°®Ê†ºÁöÑ tbody ‰∏≠
    function renderDataRows($tbody, dataList, columns, templateType, isConfiguredContext, titleInfo) {
        $tbody.empty();

        // Áªü‰∏ÄÂ§ÑÁêÜÔºöÂ∑≤ÈÖçÁΩÆÂíåÊú™ÈÖçÁΩÆÁöÑcontextÈÉΩÊ≠£Â∏∏Ê∏≤ÊüìÊï∞ÊçÆ
        if (dataList && dataList.length > 0) {
            console.log('[renderDataRows] ÂºÄÂßãÊ∏≤ÊüìÊï∞ÊçÆË°å:', {
                dataCount: dataList.length,
                columnCount: columns.length,
                templateType: templateType
            });

            // ÊúâÊï∞ÊçÆÔºöÊ∏≤ÊüìÊâÄÊúâÊï∞ÊçÆË°å
            dataList.forEach((dataItem, index) => {
                let rowData = {};
                try {
                    // Ëß£Êûê rowData JSON Â≠óÁ¨¶‰∏≤
                    rowData = JSON.parse(dataItem.rowData || '{}');
                } catch (e) {
                    console.error('[renderDataRows] Ëß£ÊûêË°åÊï∞ÊçÆÂ§±Ë¥•:', {
                        index: index,
                        dataItemId: dataItem.id,
                        error: e.message,
                        rowDataStr: dataItem.rowData
                    });
                    rowData = {}; // ‰ΩøÁî®Á©∫ÂØπË±°‰Ωú‰∏∫ÈªòËÆ§ÂÄº
                }

                const $tr = $('<tr></tr>');

                // ÊòæÁ§∫ÊâÄÊúâÂàóÔºöÊåâÁÖßÊ®°ÊùøÂÆö‰πâÁöÑÂàóÈ°∫Â∫èÊ∏≤Êüì
                columns.forEach(col => {
                    let value = rowData[col.name] || '';
                    let displayValue = String(value); // ÊòæÁ§∫key
                    let tooltipValue = ''; // ÊÇ¨ÊµÆÊòæÁ§∫ÁöÑ‰∏≠Êñá

                    // Â¶ÇÊûúÊòØÂ≠óÂÖ∏Á±ªÂûãÂ≠óÊÆµÔºåÊòæÁ§∫dictCodeÔºàkeyÔºâÔºåÊÇ¨ÊµÆÊòæÁ§∫dictValueÔºà‰∏≠ÊñáÔºâ
                    if (col.useDict && col.dictType && value) {
                        const dictType = col.dictType;
                        // ‰ªéÁºìÂ≠ò‰∏≠Êü•ÊâæÂØπÂ∫îÁöÑÂ≠óÂÖ∏È°π
                        if (dictDataCache[dictType]) {
                            const dictItem = dictDataCache[dictType].find(item =>
                                item.dictCode === value || item.dictValue === value
                            );
                            if (dictItem) {
                                displayValue = dictItem.dictCode || String(value); // ÊòæÁ§∫key
                                tooltipValue = dictItem.dictValue || dictItem.dictCode || ''; // ÊÇ¨ÊµÆÊòæÁ§∫‰∏≠Êñá
                            } else {
                                // Â¶ÇÊûúÊâæ‰∏çÂà∞ÔºåÊòæÁ§∫ÂéüÂßãÂÄºÔºåtooltip‰∏∫Á©∫
                                displayValue = String(value);
                                tooltipValue = '';
                            }
                        } else {
                            // ÁºìÂ≠òÊú™Âä†ËΩΩÔºåÊòæÁ§∫ÂéüÂßãÂÄº
                            displayValue = String(value);
                            tooltipValue = '';
                        }
                    } else {
                        // ÊôÆÈÄöÂ≠óÊÆµÔºöÊòæÁ§∫valueÔºåÊÇ¨ÊµÆÊòæÁ§∫ÂàóÁöÑ‰∏≠Êñálabel
                        displayValue = String(value);
                        tooltipValue = col.label || col.name || '';
                    }

                    // ‰ΩøÁî® escapeHtml Èò≤Ê≠¢ XSS ÊîªÂáªÔºåÊ∑ªÂä†titleÂ±ûÊÄßÁî®‰∫éÊÇ¨ÊµÆÊèêÁ§∫
                    const titleAttr = tooltipValue ? ` title="${escapeHtml(tooltipValue)}"` : '';
                    $tr.append(`<td${titleAttr}>${escapeHtml(displayValue)}</td>`);
                });

                // Êìç‰ΩúÊåâÈíÆÔºàÂ∑≤ÈÖçÁΩÆÂíåÊú™ÈÖçÁΩÆÁöÑcontextÈÉΩÊòæÁ§∫Êìç‰ΩúÊåâÈíÆÔºåÊ†πÊçÆÁºñËæëÊ®°ÂºèÁä∂ÊÄÅÊòæÁ§∫/ÈöêËóèÔºâ
                const $actionCell = $('<td class="action-buttons"></td>');
                // Ê£ÄÊü•ÂΩìÂâçË°®Ê†ºÂÆπÂô®ÊòØÂê¶Â§Ñ‰∫éÁºñËæëÊ®°ÂºèÔºà‰ºòÂÖà‰ΩøÁî®ÂÖ®Â±ÄÁä∂ÊÄÅÔºâ
                const $tableContainer = $tbody.closest('.data-table-container');
                const isEditMode = globalEditModeEnabled || ($tableContainer.length > 0 && !$tableContainer.find('.btn-disable-edit').hasClass('editing-disabled'));

                const columnsJson = encodeURIComponent(JSON.stringify(columns));
                const editBtnClass = isEditMode ? 'btn-action btn-edit' : 'btn-action btn-edit editing-disabled';
                const $editBtn = $(`<button class="${editBtnClass}">ÁºñËæë</button>`);
                $editBtn.on('click', function() {
                    editTableRow(this, dataItem.id, templateType, columnsJson);
                });
                const deleteBtnClass = isEditMode ? 'btn-action btn-delete' : 'btn-action btn-delete editing-disabled';
                const $deleteBtn = $(`<button class="${deleteBtnClass}">Âà†Èô§</button>`);
                $deleteBtn.on('click', function() {
                    deleteTableRow(dataItem.id, templateType);
                });
                $actionCell.append($editBtn);
                $actionCell.append($deleteBtn);

                $tr.append($actionCell);
                $tbody.append($tr);
            });

            console.log('[renderDataRows] Êï∞ÊçÆË°åÊ∏≤ÊüìÂÆåÊàê:', {
                renderedRows: dataList.length
            });
        } else {
            // Ê≤°ÊúâÊï∞ÊçÆÔºöÊòæÁ§∫Á©∫Áä∂ÊÄÅÊèêÁ§∫
            console.log('[renderDataRows] Ê≤°ÊúâÈÖçÁΩÆÊï∞ÊçÆÔºåÊòæÁ§∫Á©∫Áä∂ÊÄÅ');
            const colCount = columns.length + 1;
            $tbody.html(`<tr><td colspan="${colCount}" style="text-align:center;padding:20px;color:#999;">ÊöÇÊó†ÈÖçÁΩÆÊï∞ÊçÆ</td></tr>`);

            // Ê≤°ÊúâÊï∞ÊçÆÊó∂Ôºå‰πüË¶ÅÊÅ¢Â§çÁºñËæëÁä∂ÊÄÅÔºàÂ¶ÇÊûúÂÖ®Â±ÄÁºñËæëÊ®°ÂºèÂ∑≤ÂºÄÂêØÔºâ
            if (globalEditModeEnabled) {
                const $tableContainer = $tbody.closest('.data-table-container');
                if ($tableContainer.length > 0) {
                    console.log('[renderDataRows] ÊÅ¢Â§çÁºñËæëÊ®°ÂºèÁä∂ÊÄÅÔºàÊó†Êï∞ÊçÆÊÉÖÂÜµÔºâ');
                    toggleEditMode($tableContainer, true);
                }
            }
        }
    }

    // ÂàáÊç¢ÁºñËæëÊ®°Âºè
    function toggleEditMode($tableContainer, enable) {
        // Êü•ÊâæËØ•Ë°®Ê†ºÂÆπÂô®‰∏ãÁöÑÊâÄÊúâÊìç‰ΩúÊåâÈíÆ
        const $addBtn = $tableContainer.find('.btn-add-row');
        const $editBtns = $tableContainer.find('.btn-action.btn-edit');
        const $deleteBtns = $tableContainer.find('.btn-action.btn-delete');
        const $enableEditBtn = $tableContainer.find('.btn-enable-edit');
        const $disableEditBtn = $tableContainer.find('.btn-disable-edit');

        // Êõ¥Êñ∞ÂÖ®Â±ÄÁºñËæëÊ®°ÂºèÁä∂ÊÄÅ
        globalEditModeEnabled = enable;

        if (enable) {
            // ÂºÄÂêØÁºñËæëÊ®°ÂºèÔºöÊòæÁ§∫ÊâÄÊúâÊìç‰ΩúÊåâÈíÆ
            $addBtn.removeClass('editing-disabled');
            $editBtns.removeClass('editing-disabled');
            $deleteBtns.removeClass('editing-disabled');
            $enableEditBtn.addClass('editing-disabled');
            $disableEditBtn.removeClass('editing-disabled');
        } else {
            // ÂÖ≥Èó≠ÁºñËæëÊ®°ÂºèÂâçÔºåÊ£ÄÊü•ÊòØÂê¶ÊúâÊú™‰øùÂ≠òÁöÑÊñ∞Ë°å
            const $tbody = $tableContainer.find('tbody');
            const $unsavedRows = $tbody.find('tr.editing').has('.btn-save');

            if ($unsavedRows.length > 0) {
                // ‰∏çËøõË°å‰øùÂ≠òÔºåÁõ¥Êé•Âà†Èô§Êú™‰øùÂ≠òÁöÑÊñ∞Ë°å
                $unsavedRows.each(function() {
                    const $row = $(this);
                    $row.remove();
                });

                // Â¶ÇÊûúÂà†Èô§ÂêéÊ≤°ÊúâÊï∞ÊçÆ‰∫ÜÔºåÊòæÁ§∫Á©∫Áä∂ÊÄÅ
                if ($tbody.find('tr').length === 0) {
                    const columnsCount = $tableContainer.find('table thead th').length;
                    $tbody.html(`<tr><td colspan="${columnsCount}" style="text-align:center;padding:20px;color:#999;">ÊöÇÊó†ÈÖçÁΩÆÊï∞ÊçÆ</td></tr>`);
                }
            }

            // ÂÖ≥Èó≠ÁºñËæëÊ®°ÂºèÔºöÈöêËóèÊâÄÊúâÊìç‰ΩúÊåâÈíÆ
            $addBtn.addClass('editing-disabled');
            $editBtns.addClass('editing-disabled');
            $deleteBtns.addClass('editing-disabled');
            // ÈöêËóèÊâÄÊúâ‰øùÂ≠òÂíåÂèñÊ∂àÊåâÈíÆ
            $tableContainer.find('.btn-save, .btn-cancel').addClass('editing-disabled');
            $enableEditBtn.removeClass('editing-disabled');
            $disableEditBtn.addClass('editing-disabled');
        }
    }

    // Ê∑ªÂä†Êï∞ÊçÆË°å
    function addTableRow(titleId, templateType, columnsJson) {
        let columns;
        try {
            columns = typeof columnsJson === 'string' ? JSON.parse(decodeURIComponent(columnsJson)) : columnsJson;
        } catch (e) {
            console.error('Ëß£ÊûêÂàóÂÆö‰πâÂ§±Ë¥•:', e);
            alert('Êï∞ÊçÆÊ†ºÂºèÈîôËØØ');
            return;
        }

        const $tableContainer = $('.tab-content.active .data-table-container');
        const $tbody = $tableContainer.find('table.data-table tbody');
        if ($tbody.length === 0) return;

        // ÁßªÈô§Á©∫Ë°åÔºàÊ≤°ÊúâÊìç‰ΩúÊåâÈíÆÁöÑË°åÔºâ
        $tbody.find('tr').each(function() {
            const $tr = $(this);
            if ($tr.find('.action-buttons').length === 0 || $tr.find('.btn-action').length === 0) {
                $tr.remove();
            }
        });

        // ÂàõÂª∫Êñ∞Ë°å
        const $newRow = $('<tr class="editing"></tr>');
        columns.forEach(col => {
            const $cell = $('<td></td>');
            if (col.useDict && col.dictType) {
                // ‰ΩøÁî®‰∏ãÊãâÊ°ÜÔºàÊï∞ÊçÆÂ≠óÂÖ∏Ôºâ
                const $select = $('<select class="edit-input"></select>');
                $select.attr('data-column', col.name);
                if (col.required === 'yes') {
                    $select.prop('required', true);
                }
                $select.html('<option value="">ËØ∑ÈÄâÊã©...</option>');
                $cell.append($select);

                // Âä†ËΩΩÂ≠óÂÖ∏Êï∞ÊçÆ
                loadDictOptions($select, col.dictType);
            } else {
                // ‰ΩøÁî®ËæìÂÖ•Ê°Ü
                const $input = $('<input type="text" class="edit-input" />');
                $input.attr('data-column', col.name);
                if (col.required === 'yes') {
                    $input.prop('required', true);
                }
                $cell.append($input);
            }
            $newRow.append($cell);
        });

        // Êìç‰ΩúÊåâÈíÆ
        const $actionCell = $('<td class="action-buttons"></td>');
        const colsJson = encodeURIComponent(JSON.stringify(columns));
        const $saveBtn = $(`<button class="btn-action btn-save">‰øùÂ≠ò</button>`);
        $saveBtn.on('click', function() {
            saveNewRow(this, templateType, colsJson);
        });
        const $cancelBtn = $(`<button class="btn-action btn-cancel">ÂèñÊ∂à</button>`);
        $cancelBtn.on('click', function() {
            cancelEditRow(this, null, templateType, colsJson);
        });
        $actionCell.append($saveBtn);
        $actionCell.append($cancelBtn);
        $newRow.append($actionCell);

        // ËøΩÂä†Âà∞Áé∞ÊúâÊï∞ÊçÆ‰πãÂêéÂ±ïÁ§∫Ôºà‰ªÖËøΩÂä†Âà∞Êï∞ÊçÆË°®Ôºå‰∏çÂΩ±ÂìçÂéÜÂè≤ÁâàÊú¨Ë°®Ê†ºÔºâ
        $tbody.append($newRow);
    }

    // ÁºñËæëÊï∞ÊçÆË°å
    function editTableRow(btn, dataId, templateType, columnsJson) {
        let columns;
        try {
            columns = typeof columnsJson === 'string' ? JSON.parse(decodeURIComponent(columnsJson)) : columnsJson;
        } catch (e) {
            console.error('Ëß£ÊûêÂàóÂÆö‰πâÂ§±Ë¥•:', e);
            alert('Êï∞ÊçÆÊ†ºÂºèÈîôËØØ');
            return;
        }

        const $tr = $(btn).closest('tr');
        const $cells = $tr.find('td:not(.action-buttons)');

        $tr.addClass('editing');

        $cells.each(function(index) {
            if (index >= columns.length) return;
            const col = columns[index];
            const currentDisplayValue = $(this).text().trim();
            const $newCell = $('<td></td>');

            if (col.useDict && col.dictType) {
                // Â≠óÂÖ∏Á±ªÂûãÂ≠óÊÆµÔºöÁé∞Âú®ÂçïÂÖÉÊ†ºÊòæÁ§∫ÁöÑÊòØdictCodeÔºàkeyÔºâÔºåÊâÄ‰ª•Áõ¥Êé•‰ΩøÁî®ÂÆÉ
                let currentDictCode = currentDisplayValue; // ÂΩìÂâçÊòæÁ§∫ÁöÑÂ∞±ÊòØdictCode

                // Â¶ÇÊûúÁºìÂ≠ò‰∏≠ÊúâÊï∞ÊçÆÔºåÈ™åËØÅ‰∏Ä‰∏ãdictCodeÊòØÂê¶Â≠òÂú®
                if (dictDataCache[col.dictType]) {
                    const dictItem = dictDataCache[col.dictType].find(item =>
                        item.dictCode === currentDisplayValue || item.dictValue === currentDisplayValue
                    );
                    if (dictItem) {
                        currentDictCode = dictItem.dictCode; // Á°Æ‰øù‰ΩøÁî®dictCode‰Ωú‰∏∫ÂõûÂ°´ÂÄº
                    }
                }

                const $select = $('<select class="edit-input"></select>');
                $select.attr('data-column', col.name);
                if (col.required === 'yes') {
                    $select.prop('required', true);
                }
                $select.html('<option value="">ËØ∑ÈÄâÊã©...</option>');
                loadDictOptions($select, col.dictType, currentDictCode);
                $newCell.append($select);
            } else {
                // ÈùûÂ≠óÂÖ∏Á±ªÂûãÂ≠óÊÆµÔºöÁõ¥Êé•‰ΩøÁî®ÊòæÁ§∫ÂÄº
                const $input = $('<input type="text" class="edit-input" />');
                $input.attr('data-column', col.name);
                if (col.required === 'yes') {
                    $input.prop('required', true);
                }
                $input.val(currentDisplayValue);
                $newCell.append($input);
            }

            $(this).replaceWith($newCell);
        });

        // ÊõøÊç¢Êìç‰ΩúÊåâÈíÆ
        const $actionCell = $tr.find('.action-buttons');
        const colsJson = encodeURIComponent(JSON.stringify(columns));
        const $saveBtn = $(`<button class="btn-action btn-save">‰øùÂ≠ò</button>`);
        $saveBtn.on('click', function() {
            saveEditRow(this, dataId, templateType, colsJson);
        });
        const $cancelBtn = $(`<button class="btn-action btn-cancel">ÂèñÊ∂à</button>`);
        $cancelBtn.on('click', function() {
            cancelEditRow(this, dataId, templateType, colsJson);
        });
        $actionCell.empty().append($saveBtn).append($cancelBtn);
    }

    // ‰øùÂ≠òÊñ∞Ë°å
    function saveNewRow(btn, templateType, columnsJson) {
        let columns;
        try {
            columns = typeof columnsJson === 'string' ? JSON.parse(decodeURIComponent(columnsJson)) : columnsJson;
        } catch (e) {
            console.error('Ëß£ÊûêÂàóÂÆö‰πâÂ§±Ë¥•:', e);
            return;
        }

        const $tr = $(btn).closest('tr');
        const $tbody = $tr.closest('tbody');

        // Â¶ÇÊûúÂ≠òÂú®Â§öË°åÂ§Ñ‰∫éÊñ∞Â¢ûÁºñËæëÁä∂ÊÄÅÔºåÊâßË°åÊâπÈáè‰øùÂ≠òÔºåÈÅøÂÖçÊØèË°å‰øùÂ≠òÂêéÁ´ãÂç≥Âà∑Êñ∞ÂØºËá¥ÂÖ∂‰ªñË°åÊ∂àÂ§±
        const $unsavedRows = $tbody.find('tr.editing').has('.btn-save');
        if ($unsavedRows.length > 1) {
            let savedCount = 0;
            let totalCount = $unsavedRows.length;
            let allSuccess = true;

            $unsavedRows.each(function() {
                const $row = $(this);
                const $rowSaveBtn = $row.find('.btn-save').first();
                saveNewRowWithCallback($rowSaveBtn[0], templateType, columnsJson, function(success) {
                    if (!success) allSuccess = false;
                    savedCount++;
                    if (savedCount >= totalCount) {
                        if (allSuccess) {
                            const $tableContainer = $tbody.closest('.data-table-container');
                            const titleId = $tableContainer.attr('data-title-id');
                            const isConfigured = $tableContainer.attr('data-is-configured') === '1';
                            const titleInfoStr = $tableContainer.attr('data-title-info');
                            const titleInfo = titleInfoStr ? JSON.parse(titleInfoStr) : null;
                            loadConfigData($tbody, columns, titleId, isConfigured, titleInfo);
                            // ÊâπÈáè‰øùÂ≠òÂÆåÊàêÂêéÔºåÁÉ≠Êõ¥Êñ∞ÂéÜÂè≤ÁâàÊú¨Âå∫Âüü
                            const $versionContent = $tableContainer.siblings('.version-history-container').find('.version-history-content');
                            if ($versionContent && $versionContent.length) {
                                loadVersionHistory(titleId, $versionContent);
                            }
                            alert('ÂÖ®ÈÉ®‰øùÂ≠òÊàêÂäü');
                        } else {
                            alert('ÈÉ®ÂàÜÊï∞ÊçÆ‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êú™‰øùÂ≠òÁöÑË°åÂêéÈáçËØï');
                        }
                    }
                });
            });
            return; // ÊâπÈáè‰øùÂ≠òÊ®°Âºè‰∏ãÔºå‰∏çÂÜçÊâßË°åÂçïË°å‰øùÂ≠òÈÄªËæë
        }

        // ÂçïË°å‰øùÂ≠òÈÄªËæë
        const rowData = {};
        let hasError = false;

        $tr.find('.edit-input').each(function() {
            const colName = $(this).attr('data-column');
            const value = $(this).val() || '';

            if ($(this).prop('required') && !value) {
                alert(`ËØ∑Â°´ÂÜô ${columns.find(c => c.name === colName)?.label || colName}`);
                $(this).focus();
                hasError = true;
                return false;
            }

            rowData[colName] = value;
        });

        if (hasError) return;

        const $tableContainer = $tbody.closest('.data-table-container');
        const titleId = $tableContainer.attr('data-title-id');

        $.ajax({
            url: '/system/configData/insertData',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                titleId: titleId,
                templateType: templateType,
                rowData: JSON.stringify(rowData),
                displayOrder: 1,
                isActive: true
            }),
            success: function(res) {
                if (res.code === 2000) {
                    alert('‰øùÂ≠òÊàêÂäü');
                    const isConfigured = $tableContainer.attr('data-is-configured') === '1';
                    const titleInfoStr = $tableContainer.attr('data-title-info');
                    const titleInfo = titleInfoStr ? JSON.parse(titleInfoStr) : null;
                    loadConfigData($tbody, columns, titleId, isConfigured, titleInfo);
                    // ‰øùÂ≠òÊàêÂäüÂêéÔºåÁÉ≠Êõ¥Êñ∞ÂéÜÂè≤ÁâàÊú¨Âå∫Âüü
                    const $versionContent = $tableContainer.siblings('.version-history-container').find('.version-history-content');
                    if ($versionContent && $versionContent.length) {
                        loadVersionHistory(titleId, $versionContent);
                    }
                } else {
                    alert('‰øùÂ≠òÂ§±Ë¥•: ' + (res.msg || 'Êú™Áü•ÈîôËØØ'));
                }
            },
            error: function() {
                alert('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        });
    };

    // ‰øùÂ≠òÊñ∞Ë°åÔºàÂ∏¶ÂõûË∞ÉÁâàÊú¨ÔºåÁî®‰∫éÊâπÈáè‰øùÂ≠òÔºâ
    function saveNewRowWithCallback(btn, templateType, columnsJson, callback) {
        let columns;
        try {
            columns = typeof columnsJson === 'string' ? JSON.parse(decodeURIComponent(columnsJson)) : columnsJson;
        } catch (e) {
            console.error('Ëß£ÊûêÂàóÂÆö‰πâÂ§±Ë¥•:', e);
            if (callback) callback(false);
            return;
        }

        const $tr = $(btn).closest('tr');

        const rowData = {};
        let hasError = false;

        $tr.find('.edit-input').each(function() {
            const colName = $(this).attr('data-column');
            const value = $(this).val() || '';

            if ($(this).prop('required') && !value) {
                alert(`ËØ∑Â°´ÂÜô ${columns.find(c => c.name === colName)?.label || colName}`);
                $(this).focus();
                hasError = true;
                return false;
            }

            rowData[colName] = value;
        });

        if (hasError) {
            if (callback) callback(false);
            return;
        }

        // Ëé∑Âèñ titleId
        const $tbody = $tr.closest('tbody');
        const $tableContainer = $tbody.closest('.data-table-container');
        const titleId = $tableContainer.attr('data-title-id');

        // ‰øùÂ≠òÊï∞ÊçÆ
        $.ajax({
            url: '/system/configData/insertData',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                titleId: titleId,
                templateType: templateType,
                rowData: JSON.stringify(rowData),
                displayOrder: 1,
                isActive: true
            }),
            success: function(res) {
                if (res.code === 2000) {
                    // Â¶ÇÊûúÊèê‰æõ‰∫ÜÂõûË∞ÉÔºåË∞ÉÁî®ÂõûË∞ÉËÄå‰∏çÊòØÁ´ãÂç≥ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
                    if (callback) {
                        callback(true);
                    } else {
                        // Ê≤°ÊúâÂõûË∞ÉÊó∂Ôºå‰ΩøÁî®ÂéüÊù•ÁöÑË°å‰∏∫ÔºöÁ´ãÂç≥ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
                        alert('‰øùÂ≠òÊàêÂäü');
                        const $tbody = $tr.closest('tbody');
                        const $tableContainer = $tbody.closest('.data-table-container');
                        const titleId = $tableContainer.attr('data-title-id');
                        const isConfigured = $tableContainer.attr('data-is-configured') === '1';
                        const titleInfoStr = $tableContainer.attr('data-title-info');
                        const titleInfo = titleInfoStr ? JSON.parse(titleInfoStr) : null;
                        loadConfigData($tbody, columns, titleId, isConfigured, titleInfo);
                        // ‰øùÂ≠òÊàêÂäüÂêéÔºåÁÉ≠Êõ¥Êñ∞ÂéÜÂè≤ÁâàÊú¨Âå∫Âüü
                        const $versionContent = $tableContainer.siblings('.version-history-container').find('.version-history-content');
                        if ($versionContent && $versionContent.length) {
                            loadVersionHistory(titleId, $versionContent);
                        }
                    }
                } else {
                    alert('‰øùÂ≠òÂ§±Ë¥•: ' + (res.msg || 'Êú™Áü•ÈîôËØØ'));
                    if (callback) callback(false);
                }
            },
            error: function() {
                alert('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                if (callback) callback(false);
            }
        });
    }

    // ‰øùÂ≠òÁºñËæëË°å
    function saveEditRow(btn, dataId, templateType, columnsJson) {
        let columns;
        try {
            columns = typeof columnsJson === 'string' ? JSON.parse(decodeURIComponent(columnsJson)) : columnsJson;
        } catch (e) {
            console.error('Ëß£ÊûêÂàóÂÆö‰πâÂ§±Ë¥•:', e);
            return;
        }

        const $tr = $(btn).closest('tr');

        const rowData = {};

        $tr.find('.edit-input').each(function() {
            const colName = $(this).attr('data-column');
            const value = $(this).val() || '';
            rowData[colName] = value;
        });

        // Êõ¥Êñ∞Êï∞ÊçÆ
        $.ajax({
            url: '/system/configData/updateData',
            method: 'POST',
            data: {
                id: dataId,
                rowData: JSON.stringify(rowData),
                changeDescription: 'Êõ¥Êñ∞ÈÖçÁΩÆÊï∞ÊçÆ'
            },
            success: function(res) {
                if (res.code === 2000) {
                    alert('‰øùÂ≠òÊàêÂäü');
                    // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
                    const $tbody = $tr.closest('tbody');
                    const $tableContainer = $tbody.closest('.data-table-container');
                    const titleId = $tableContainer.attr('data-title-id');
                    const isConfigured = $tableContainer.attr('data-is-configured') === '1';
                    const titleInfoStr = $tableContainer.attr('data-title-info');
                    const titleInfo = titleInfoStr ? JSON.parse(titleInfoStr) : null;
                    loadConfigData($tbody, columns, titleId, isConfigured, titleInfo);
                    // ÁºñËæë‰øùÂ≠òÂêéÔºåÁÉ≠Êõ¥Êñ∞ÂéÜÂè≤ÁâàÊú¨Âå∫Âüü
                    const $versionContent = $tableContainer.siblings('.version-history-container').find('.version-history-content');
                    if ($versionContent && $versionContent.length) {
                        loadVersionHistory(titleId, $versionContent);
                    }
                } else {
                    alert('‰øùÂ≠òÂ§±Ë¥•: ' + (res.msg || 'Êú™Áü•ÈîôËØØ'));
                }
            },
            error: function() {
                alert('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        });
    }

    // ÂèñÊ∂àÁºñËæë
    function cancelEditRow(btn, dataId, templateType, columnsJson) {
        const $tr = $(btn).closest('tr');
        const $tbody = $tr.closest('tbody');

        if (dataId) {
            // ÁºñËæëÊ®°ÂºèÔºåÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
            let columns;
            try {
                columns = typeof columnsJson === 'string' ? JSON.parse(decodeURIComponent(columnsJson)) : columnsJson;
            } catch (e) {
                console.error('Ëß£ÊûêÂàóÂÆö‰πâÂ§±Ë¥•:', e);
                return;
            }
            const $tableContainer = $tbody.closest('.data-table-container');
            const titleId = $tableContainer.attr('data-title-id');
            const isConfigured = $tableContainer.attr('data-is-configured') === '1';
            const titleInfoStr = $tableContainer.attr('data-title-info');
            const titleInfo = titleInfoStr ? JSON.parse(titleInfoStr) : null;
            loadConfigData($tbody, columns, titleId, isConfigured, titleInfo);
        } else {
            // Êñ∞Â¢ûÊ®°ÂºèÔºåÁõ¥Êé•Âà†Èô§Ë°å
            $tr.remove();
            if ($tbody.find('tr').length === 0) {
                // Ê≤°ÊúâÊï∞ÊçÆÊó∂ÔºåÊ∏≤ÊüìÁ©∫Ë°å
                const columnsCount = $tbody.closest('table').find('th').length - 1;
                const $emptyRow = $('<tr></tr>');
                for (let i = 0; i < columnsCount; i++) {
                    $emptyRow.append('<td></td>');
                }
                $emptyRow.append('<td class="action-buttons"></td>');
                $tbody.append($emptyRow);
            }
        }
    }

    // Âà†Èô§Êï∞ÊçÆË°å
    function deleteTableRow(dataId, templateType) {
        if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Êï∞ÊçÆÂêóÔºü')) {
            return;
        }

        $.ajax({
            url: '/system/configData/deleteData',
            method: 'DELETE',
            contentType: 'application/json',
            data: JSON.stringify([dataId]),
            success: function(res) {
                if (res.code === 2000) {
                    alert('Âà†Èô§ÊàêÂäü');
                    // ÈáçÊñ∞Âä†ËΩΩÂΩìÂâçÊï∞ÊçÆË°®Ôºà‰ªÖ‰ΩúÁî®Êï∞ÊçÆË°®Ôºå‰∏çÂΩ±ÂìçÂéÜÂè≤ÁâàÊú¨Ë°®Ôºâ
                    const $tableContainer = $('.tab-content.active .data-table-container');
                    const $tbody = $tableContainer.find('table.data-table tbody');
                    const $addBtn = $tableContainer.find('.btn-add-row');
                    const columnsJson = $addBtn.attr('data-columns');
                    let columns;
                    try {
                        columns = JSON.parse(decodeURIComponent(columnsJson));
                    } catch (e) {
                        console.error('Ëß£ÊûêÂàóÂÆö‰πâÂ§±Ë¥•:', e);
                        return;
                    }

                    const titleId = $tableContainer.attr('data-title-id');
                    const isConfigured = $tableContainer.attr('data-is-configured') === '1';
                    const titleInfoStr = $tableContainer.attr('data-title-info');
                    const titleInfo = titleInfoStr ? JSON.parse(titleInfoStr) : null;
                    loadConfigData($tbody, columns, titleId, isConfigured, titleInfo);
                    // Âà†Èô§ÊàêÂäüÂêéÔºåÁÉ≠Êõ¥Êñ∞ÂéÜÂè≤ÁâàÊú¨Âå∫Âüü
                    const $versionContent = $tableContainer.siblings('.version-history-container').find('.version-history-content');
                    if ($versionContent && $versionContent.length) {
                        // Â∞ÜÂàöÂà†Èô§ÁöÑIDÂä†ÂÖ•È¢ùÂ§ñIDÈõÜÂêàÔºåÁ°Æ‰øùÂéÜÂè≤ÁâàÊú¨ËÉΩÊ£ÄÁ¥¢Âà∞
                        const extras = $versionContent.data('extraConfigDataIds') || [];
                        const delIdStr = String(dataId);
                        if (extras.indexOf(delIdStr) === -1) {
                            extras.push(delIdStr);
                        }
                        $versionContent.data('extraConfigDataIds', extras);
                        // Á´ãÂç≥ÁÉ≠Êõ¥Êñ∞‰∏ÄÊ¨°
                        loadVersionHistory(titleId, $versionContent);
                        // Á®çÂêéÂÜçÊõ¥Êñ∞‰∏ÄÊ¨°ÔºåÁ°Æ‰øùÂêéÁ´ØÂÜôÂÖ•ÂÆåÊàê
                        setTimeout(function() {
                            loadVersionHistory(titleId, $versionContent);
                        }, 500);
                    }
                } else {
                    alert('Âà†Èô§Â§±Ë¥•: ' + (res.msg || 'Êú™Áü•ÈîôËØØ'));
                }
            },
            error: function() {
                alert('Âà†Èô§Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        });
    }

    // Âä†ËΩΩÂ≠óÂÖ∏ÈÄâÈ°π
    // dictCode ‰Ωú‰∏∫ valueÔºàkeyÔºâÔºådictValue ‰Ωú‰∏∫ÊòæÁ§∫ÊñáÊú¨
    function loadDictOptions($select, dictType, selectedValue) {
        console.log('[loadDictOptions] ÂºÄÂßãÂä†ËΩΩÂ≠óÂÖ∏ÈÄâÈ°π:', {
            dictType: dictType,
            selectedValue: selectedValue,
            hasCache: !!dictDataCache[dictType]
        });

        if (dictDataCache[dictType]) {
            // ‰ΩøÁî®ÁºìÂ≠ò
            console.log('[loadDictOptions] ‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆ');
            dictDataCache[dictType].forEach(item => {
                // dictCode ‰Ωú‰∏∫ valueÔºàkeyÔºâÔºådictValue ‰Ωú‰∏∫ÊòæÁ§∫ÊñáÊú¨
                const optionValue = item.dictCode || '';
                const displayText = item.dictValue || item.dictCode || '';
                const $option = $(`<option value="${escapeHtml(optionValue)}">${escapeHtml(displayText)}</option>`);
                if (selectedValue && (item.dictCode === selectedValue || item.dictValue === selectedValue)) {
                    $option.prop('selected', true);
                }
                $select.append($option);
            });
            return;
        }

        $.ajax({
            url: '/system/dictData/listByDictType',
            method: 'GET',
            data: { dictType: dictType },
            dataType: 'json',
            success: function(res) {
                console.log('[loadDictOptions] Â≠óÂÖ∏Êï∞ÊçÆÂä†ËΩΩÊàêÂäü:', {
                    dictType: dictType,
                    dataCount: (res.data && res.data.length) || 0,
                    responseCode: res.code
                });

                if (res.code === 2000 && res.data) {
                    dictDataCache[dictType] = res.data;
                    res.data.forEach(item => {
                        // dictCode ‰Ωú‰∏∫ valueÔºàkeyÔºâÔºådictValue ‰Ωú‰∏∫ÊòæÁ§∫ÊñáÊú¨
                        const optionValue = item.dictCode || '';
                        const displayText = item.dictValue || item.dictCode || '';
                        const $option = $(`<option value="${escapeHtml(optionValue)}">${escapeHtml(displayText)}</option>`);
                        if (selectedValue && (item.dictCode === selectedValue || item.dictValue === selectedValue)) {
                            $option.prop('selected', true);
                        }
                        $select.append($option);
                    });
                } else {
                    console.warn('[loadDictOptions] Â≠óÂÖ∏Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•Êàñ‰∏∫Á©∫:', {
                        dictType: dictType,
                        responseCode: res ? res.code : 'unknown',
                        message: res ? res.msg : 'unknown error'
                    });
                }
            },
            error: function(xhr, status, error) {
                console.error('[loadDictOptions] Âä†ËΩΩÂ≠óÂÖ∏Êï∞ÊçÆÂ§±Ë¥•:', {
                    dictType: dictType,
                    status: status,
                    error: error,
                    statusCode: xhr.status
                });
            }
        });
    }

    // HTMLËΩ¨‰πâÂáΩÊï∞
    // Âä†ËΩΩÂéÜÂè≤ÁâàÊú¨Êï∞ÊçÆÔºàÊ†πÊçÆtitleIdÔºâ
    // ÂÖàËé∑ÂèñËØ•title‰∏ãÁöÑÊâÄÊúâÈÖçÁΩÆÊï∞ÊçÆIDÔºåÁÑ∂ÂêéÊü•ËØ¢Ëøô‰∫õÈÖçÁΩÆÊï∞ÊçÆÁöÑÂéÜÂè≤ÁâàÊú¨
    function loadVersionHistory(titleId, $container) {
        console.log('[loadVersionHistory] ÂºÄÂßãÂä†ËΩΩÂéÜÂè≤ÁâàÊú¨Êï∞ÊçÆÔºåtitleId:', titleId);
        
        // È™åËØÅtitleId
        if (!titleId || String(titleId).trim() === '') {
            console.error('[loadVersionHistory] titleIdÊó†Êïà:', { titleId });
            $container.html('<div class="version-history-empty">Ê†áÈ¢òIDÊó†ÊïàÔºåÊó†Ê≥ïÂä†ËΩΩÂéÜÂè≤ÁâàÊú¨</div>');
            return;
        }

        // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
        $container.html('<div class="version-history-loading">Ê≠£Âú®Âä†ËΩΩÂéÜÂè≤ÁâàÊú¨Êï∞ÊçÆ...</div>');

        // Á¨¨‰∏ÄÊ≠•ÔºöËé∑ÂèñËØ•title‰∏ãÁöÑÊâÄÊúâÈÖçÁΩÆÊï∞ÊçÆÔºåÊî∂ÈõÜconfigDataIds
        $.ajax({
            url: '/system/configData/getConfigDataByTitleId',
            method: 'GET',
            data: { titleId: String(titleId).trim() },
            dataType: 'json',
            timeout: 30000,
            success: function(res) {
                if (res && res.code === 2000 && res.data && res.data.length > 0) {
                    const configDataIds = res.data.map(item => item.id).filter(id => id);
                    console.log('[loadVersionHistory] Ëé∑ÂèñÂà∞ÈÖçÁΩÆÊï∞ÊçÆIDÂàóË°®:', {
                        titleId: titleId,
                        configDataIds: configDataIds,
                        count: configDataIds.length
                    });

                    // Â∞ÜÈ¢ùÂ§ñÁöÑÈÖçÁΩÆÊï∞ÊçÆIDÔºà‰æãÂ¶ÇÂàöÂà†Èô§ÁöÑÊï∞ÊçÆIDÔºâÂêàÂπ∂ËøõÊù•ÔºåÈÅøÂÖçÂà†Èô§ÂêéÊó†Ê≥ïÁúãÂà∞ÂéÜÂè≤ËÆ∞ÂΩï
                    const extraIds = $container.data('extraConfigDataIds') || [];
                    const mergedIds = Array.from(new Set([].concat(configDataIds || [], extraIds || [])));

                    if (mergedIds.length === 0) {
                        $container.html('<div class="version-history-empty">ËØ•Ê†áÈ¢ò‰∏ãÊöÇÊó†ÈÖçÁΩÆÊï∞ÊçÆÔºåÊó†ÂéÜÂè≤ÁâàÊú¨ËÆ∞ÂΩï</div>');
                        return;
                    }

                    // Á¨¨‰∫åÊ≠•ÔºöÊü•ËØ¢ÂéÜÂè≤ÁâàÊú¨Êï∞ÊçÆÔºàÁ¨¨‰∏ÄÈ°µÔºåÈªòËÆ§ÊØèÈ°µ10Êù°Ôºâ
                    // Áî±‰∫éÊé•Âè£Âè™ÊîØÊåÅÂçï‰∏™configDataIdÔºåÊàë‰ª¨ÊöÇÊó∂‰∏ç‰º†configDataIdÔºåËé∑ÂèñÊâÄÊúâÂéÜÂè≤ÁâàÊú¨ÔºåÁÑ∂ÂêéÂâçÁ´ØËøáÊª§
                    // ÊàñËÄÖÂèØ‰ª•‰∏∫ÊØè‰∏™configDataIdÊü•ËØ¢‰∏ÄÊ¨°ÔºåÁÑ∂ÂêéÂêàÂπ∂ÁªìÊûú
                    // ËøôÈáåÂÖàÂÆûÁé∞‰∏Ä‰∏™ÁÆÄÂåñÁâàÊú¨ÔºöÊü•ËØ¢ÊâÄÊúâÂéÜÂè≤ÁâàÊú¨Ôºà‰∏ç‰º†configDataIdÔºâÔºåÁÑ∂ÂêéÂâçÁ´ØËøáÊª§
                    loadVersionHistoryPage($container, titleId, mergedIds, 1, 10);
                } else {
                    console.log('[loadVersionHistory] ËØ•Ê†áÈ¢ò‰∏ãÊöÇÊó†ÈÖçÁΩÆÊï∞ÊçÆ');
                    $container.html('<div class="version-history-empty">ËØ•Ê†áÈ¢ò‰∏ãÊöÇÊó†ÈÖçÁΩÆÊï∞ÊçÆÔºåÊó†ÂéÜÂè≤ÁâàÊú¨ËÆ∞ÂΩï</div>');
                }
            },
            error: function(xhr, status, error) {
                console.error('[loadVersionHistory] Ëé∑ÂèñÈÖçÁΩÆÊï∞ÊçÆÂ§±Ë¥•:', {
                    titleId: titleId,
                    status: status,
                    error: error
                });
                $container.html('<div class="version-history-error">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï</div>');
            }
        });
    }

    // ÂàÜÈ°µÂä†ËΩΩÂéÜÂè≤ÁâàÊú¨Êï∞ÊçÆÔºà‰ΩøÁî®ÂêéÁ´ØÂàÜÈ°µÔºâ
    function loadVersionHistoryPage($container, titleId, configDataIds, pageNo, pageSize) {
        console.log('[loadVersionHistoryPage] ÂàÜÈ°µÂä†ËΩΩÂéÜÂè≤ÁâàÊú¨:', {
            titleId: titleId,
            pageNo: pageNo,
            pageSize: pageSize,
            configDataIdsCount: configDataIds.length
        });

        // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
        $container.html('<div class="version-history-loading">Ê≠£Âú®Âä†ËΩΩÂéÜÂè≤ÁâàÊú¨Êï∞ÊçÆ...</div>');

        // Â¶ÇÊûúÊ≤°ÊúâÈÖçÁΩÆÊï∞ÊçÆIDÔºåÊòæÁ§∫Á©∫Áä∂ÊÄÅ
        if (!configDataIds || configDataIds.length === 0) {
            $container.html('<div class="version-history-empty">ËØ•Ê†áÈ¢ò‰∏ãÊöÇÊó†ÈÖçÁΩÆÊï∞ÊçÆÔºåÊó†ÂéÜÂè≤ÁâàÊú¨ËÆ∞ÂΩï</div>');
            return;
        }

        // ÊûÑÂª∫ËØ∑Ê±ÇÂèÇÊï∞ÔºöÂ∞ÜconfigDataIdsÊï∞ÁªÑËΩ¨‰∏∫ÈÄóÂè∑ÂàÜÈöîÁöÑÂ≠óÁ¨¶‰∏≤
        const requestData = {
            pageNo: pageNo,
            pageSize: pageSize,
            configDataIds: configDataIds.join(',')
        };

        // Áõ¥Êé•Ë∞ÉÁî®ÂêéÁ´ØÂàÜÈ°µÊé•Âè£ÔºåÂêéÁ´Ø‰ºöÂ§ÑÁêÜINÊü•ËØ¢ÂíåÂàÜÈ°µ
        $.ajax({
            url: '/system/versionHistory/pageList',
            method: 'GET',
            data: requestData,
            dataType: 'json',
            timeout: 30000,
            success: function(res) {
                if (res && res.code === 2000 && res.data) {
                    const pageData = res.data;
                    const dataList = pageData.records || [];
                    const totalCount = pageData.total || 0;
                    const totalPages = pageData.pages || 0;
                    const currentPage = pageData.current || pageNo;

                    console.log('[loadVersionHistoryPage] ÂàÜÈ°µÂä†ËΩΩÊàêÂäü:', {
                        currentPage: currentPage,
                        pageSize: pageSize,
                        totalCount: totalCount,
                        totalPages: totalPages,
                        dataCount: dataList.length
                    });

                    // Ê∏≤ÊüìÂéÜÂè≤ÁâàÊú¨Êï∞ÊçÆ
                    renderVersionHistory($container, dataList, currentPage, pageSize, totalCount, totalPages, titleId, configDataIds);
                } else {
                    console.error('[loadVersionHistoryPage] Êé•Âè£ËøîÂõûÈîôËØØ:', res);
                    $container.html('<div class="version-history-error">Âä†ËΩΩÂ§±Ë¥•: ' + (res.msg || 'Êú™Áü•ÈîôËØØ') + '</div>');
                }
            },
            error: function(xhr, status, error) {
                console.error('[loadVersionHistoryPage] Âä†ËΩΩÂéÜÂè≤ÁâàÊú¨Â§±Ë¥•:', {
                    status: status,
                    error: error,
                    xhr: xhr
                });
                $container.html('<div class="version-history-error">Âä†ËΩΩÂéÜÂè≤ÁâàÊú¨Â§±Ë¥•ÔºåËØ∑ÈáçËØï</div>');
            }
        });
    }

    // Ê∏≤ÊüìÂéÜÂè≤ÁâàÊú¨Êï∞ÊçÆË°®Ê†ºÂíåÂàÜÈ°µ
    function renderVersionHistory($container, dataList, currentPage, pageSize, totalCount, totalPages, titleId, configDataIds) {
        console.log('[renderVersionHistory] Ê∏≤ÊüìÂéÜÂè≤ÁâàÊú¨Êï∞ÊçÆ:', {
            dataCount: dataList.length,
            currentPage: currentPage,
            totalCount: totalCount,
            totalPages: totalPages
        });

        $container.empty();

        if (dataList.length === 0) {
            $container.html('<div class="version-history-empty">ÊöÇÊó†ÂéÜÂè≤ÁâàÊú¨ËÆ∞ÂΩï</div>');
            return;
        }

        // ÂàõÂª∫Ë°®Ê†º
        const $table = $('<table class="version-history-table"></table>');
        const $thead = $('<thead></thead>');
        const $theadRow = $('<tr></tr>');
        $theadRow.append(
            '<th>ÂèòÊõ¥Á±ªÂûã</th>',
            '<th>ÂèòÊõ¥ÊèèËø∞</th>',
            '<th>ÂèòÊõ¥Êï∞ÊçÆ</th>',
            '<th>Êìç‰Ωú‰∫∫</th>',
            '<th>Êìç‰ΩúÊó∂Èó¥</th>'
        );
        $thead.append($theadRow);
        $table.append($thead);

        const $tbody = $('<tbody></tbody>');
        dataList.forEach(function(item) {
            const $tr = $('<tr></tr>');
            const changeTypeLabel = item.changeType === 'CREATE' ? 'ÂàõÂª∫' : 
                                  item.changeType === 'UPDATE' ? 'Êõ¥Êñ∞' : 
                                  item.changeType === 'DELETE' ? 'Âà†Èô§' : item.changeType || '-';
            const changeTypeClass = item.changeType === 'CREATE' ? 'change-type-create' : 
                                  item.changeType === 'UPDATE' ? 'change-type-update' : 
                                  item.changeType === 'DELETE' ? 'change-type-delete' : '';
            
            let changeDataDisplay = '-';
            if (item.changeData) {
                try {
                    const changeDataObj = JSON.parse(item.changeData);
                    changeDataDisplay = JSON.stringify(changeDataObj, null, 2);
                } catch (e) {
                    changeDataDisplay = item.changeData;
                }
            }
            
            const operatedTime = item.operatedTime ? new Date(item.operatedTime).toLocaleString('zh-CN') : '-';

            // ÂèòÊõ¥Êï∞ÊçÆÂçïÂÖÉÊ†ºÔºåÂåÖÂê´ÊñáÊú¨ÂíåÊü•ÁúãËØ¶ÊÉÖÊåâÈíÆ
            const $changeDataCell = $('<td class="change-data-cell"></td>');
            const $changeDataWrapper = $('<div></div>');
            const $changeDataText = $('<span title="' + escapeHtml(changeDataDisplay) + '">' + escapeHtml(changeDataDisplay.length > 50 ? changeDataDisplay.substring(0, 50) + '...' : changeDataDisplay) + '</span>');
            
            // ‰øùÂ≠òÂèòÊõ¥Êï∞ÊçÆÂíåÊèèËø∞Âà∞ÊåâÈíÆÁöÑdataÂ±ûÊÄß‰∏≠
            // Â¶ÇÊûúchangeDataÊòØÂ≠óÁ¨¶‰∏≤ÔºåÁõ¥Êé•‰øùÂ≠òÔºõÂ¶ÇÊûúÊòØÂØπË±°ÔºåÂÖàËΩ¨‰∏∫JSONÂ≠óÁ¨¶‰∏≤
            let changeDataStr = '';
            if (item.changeData) {
                if (typeof item.changeData === 'string') {
                    changeDataStr = item.changeData;
                } else {
                    changeDataStr = JSON.stringify(item.changeData);
                }
            }
            const changeDescriptionText = item.changeDescription || 'ÂèòÊõ¥Êï∞ÊçÆËØ¶ÊÉÖ';
            const $viewDetailBtn = $('<button class="btn-view-detail" data-change-data=\'' + escapeHtml(changeDataStr.replace(/'/g, "&#39;")) + '\' data-change-description=\'' + escapeHtml(changeDescriptionText.replace(/'/g, "&#39;")) + '\'>Êü•ÁúãËØ¶ÊÉÖ</button>');
            
            $viewDetailBtn.on('click', function() {
                const changeDataStr = $(this).data('change-data');
                const changeDescription = $(this).data('change-description') || 'ÂèòÊõ¥Êï∞ÊçÆËØ¶ÊÉÖ';
                
                // ‰º†ÈÄíÂéüÂßãÂ≠óÁ¨¶‰∏≤ÔºåËÆ©showChangeDataDetailÂáΩÊï∞ÂÜÖÈÉ®Ëß£Êûê
                showChangeDataDetail(changeDescription, changeDataStr);
            });
            
            $changeDataWrapper.append($changeDataText).append($viewDetailBtn);
            $changeDataCell.append($changeDataWrapper);
            
            $tr.append(
                `<td><span class="change-type-badge ${changeTypeClass}">${escapeHtml(changeTypeLabel)}</span></td>`,
                `<td title="${escapeHtml(item.changeDescription || '')}">${escapeHtml(item.changeDescription || '-')}</td>`
            );
            $tr.append($changeDataCell);
            $tr.append(
                `<td>${escapeHtml(item.operatedBy || '-')}</td>`,
                `<td>${escapeHtml(operatedTime)}</td>`
            );
            $tbody.append($tr);
        });
        $table.append($tbody);

        $container.append($table);

        // ÂàõÂª∫ÂàÜÈ°µÁªÑ‰ª∂ÔºàÂè™Ë¶ÅÊúâÊï∞ÊçÆÂ∞±ÊòæÁ§∫ÂàÜÈ°µ‰ø°ÊÅØÔºâ
        if (totalCount > 0) {
            const $pagination = $('<div class="version-history-pagination"></div>');
            
            // ÂàÜÈ°µ‰ø°ÊÅØ
            const $paginationInfo = $('<div class="pagination-info"></div>');
            if (totalCount > 0) {
                $paginationInfo.text(`ÂÖ± ${totalCount} Êù°ËÆ∞ÂΩïÔºåÁ¨¨ ${currentPage} / ${totalPages} È°µ`);
            } else {
                $paginationInfo.text('ÊöÇÊó†Êï∞ÊçÆ');
            }
            $pagination.append($paginationInfo);

            // ÊØèÈ°µÊù°Êï∞ÈÄâÊã©Âô®
            const $pageSizeSelector = $('<div class="pagination-page-size"></div>');
            $pageSizeSelector.append('<span>ÊØèÈ°µÊòæÁ§∫Ôºö</span>');
            const $pageSizeSelect = $('<select class="pagination-select"></select>');
            [10, 20, 50, 100].forEach(function(size) {
                const $option = $('<option value="' + size + '">' + size + '</option>');
                if (size === pageSize) {
                    $option.prop('selected', true);
                }
                $pageSizeSelect.append($option);
            });
            $pageSizeSelect.on('change', function() {
                const newPageSize = parseInt($(this).val());
                // ÂàáÊç¢Âà∞Á¨¨‰∏ÄÈ°µÔºå‰ΩøÁî®Êñ∞ÁöÑÊØèÈ°µÊù°Êï∞
                loadVersionHistoryPage($container, titleId, configDataIds, 1, newPageSize);
            });
            $pageSizeSelector.append($pageSizeSelect);
            $pagination.append($pageSizeSelector);

            // Â¶ÇÊûúÊúâÊï∞ÊçÆÔºåÊòæÁ§∫ÂàÜÈ°µÊåâÈíÆ
            if (totalPages > 0) {
                // ÂàÜÈ°µÊåâÈíÆ
                const $paginationButtons = $('<div class="pagination-buttons"></div>');

                // È¶ñÈ°µ
                const $firstBtn = $('<button class="pagination-btn" data-page="1">È¶ñÈ°µ</button>');
                if (currentPage === 1) {
                    $firstBtn.addClass('disabled');
                } else {
                    $firstBtn.on('click', function() {
                        loadVersionHistoryPage($container, titleId, configDataIds, 1, pageSize);
                    });
                }
                $paginationButtons.append($firstBtn);

                // ‰∏ä‰∏ÄÈ°µ
                const $prevBtn = $('<button class="pagination-btn" data-page="' + (currentPage - 1) + '">‰∏ä‰∏ÄÈ°µ</button>');
                if (currentPage === 1) {
                    $prevBtn.addClass('disabled');
                } else {
                    $prevBtn.on('click', function() {
                        loadVersionHistoryPage($container, titleId, configDataIds, currentPage - 1, pageSize);
                    });
                }
                $paginationButtons.append($prevBtn);

                // È°µÁ†ÅÊåâÈíÆÔºàÊòæÁ§∫ÂΩìÂâçÈ°µÂâçÂêéÂêÑ2È°µÔºâ
                const startPage = Math.max(1, currentPage - 2);
                const endPage = Math.min(totalPages, currentPage + 2);
                for (let i = startPage; i <= endPage; i++) {
                    const $pageBtn = $('<button class="pagination-btn" data-page="' + i + '">' + i + '</button>');
                    if (i === currentPage) {
                        $pageBtn.addClass('active');
                    } else {
                        $pageBtn.on('click', function() {
                            const page = parseInt($(this).attr('data-page'));
                            loadVersionHistoryPage($container, titleId, configDataIds, page, pageSize);
                        });
                    }
                    $paginationButtons.append($pageBtn);
                }

                // ‰∏ã‰∏ÄÈ°µ
                const $nextBtn = $('<button class="pagination-btn" data-page="' + (currentPage + 1) + '">‰∏ã‰∏ÄÈ°µ</button>');
                if (currentPage === totalPages) {
                    $nextBtn.addClass('disabled');
                } else {
                    $nextBtn.on('click', function() {
                        loadVersionHistoryPage($container, titleId, configDataIds, currentPage + 1, pageSize);
                    });
                }
                $paginationButtons.append($nextBtn);

                // Êú´È°µ
                const $lastBtn = $('<button class="pagination-btn" data-page="' + totalPages + '">Êú´È°µ</button>');
                if (currentPage === totalPages) {
                    $lastBtn.addClass('disabled');
                } else {
                    $lastBtn.on('click', function() {
                        loadVersionHistoryPage($container, titleId, configDataIds, totalPages, pageSize);
                    });
                }
                $paginationButtons.append($lastBtn);

                $pagination.append($paginationButtons);
            }

            $container.append($pagination);
        }
    }

    function escapeHtml(text) {
        // ÂÆâÂÖ®Â§ÑÁêÜÂêÑÁßçÁ±ªÂûãÁöÑËæìÂÖ•
        if (text === null || text === undefined) {
            return '';
        }

        // Â¶ÇÊûúÂ∑≤ÁªèÊòØÂ≠óÁ¨¶‰∏≤ÔºåÁõ¥Êé•‰ΩøÁî®ÔºõÂê¶ÂàôËΩ¨Êç¢‰∏∫Â≠óÁ¨¶‰∏≤
        // ‰ΩÜÈúÄË¶ÅÁ°Æ‰øù‰∏ç‰ºö‰º†ÂÖ•DOMËäÇÁÇπÊàñÂÖ∂‰ªñÂØπË±°
        let str;
        if (typeof text === 'string') {
            str = text;
        } else if (typeof text === 'number' || typeof text === 'boolean') {
            str = String(text);
        } else {
            // ÂØπ‰∫éÂØπË±°Á±ªÂûãÔºåÂ∞ùËØïÂÆâÂÖ®ËΩ¨Êç¢ÔºåÈÅøÂÖçÊâìÂç∞[object Object]
            try {
                str = String(text);
                // Â¶ÇÊûúÁªìÊûúÊòØ[object Object]ÔºåËøîÂõûÁ©∫Â≠óÁ¨¶‰∏≤ÊàñÁâπÂÆöÊ†áËØÜ
                if (str === '[object Object]') {
                    console.warn('[escapeHtml] Â∞ùËØïËΩ¨‰πâÈùûÂ≠óÁ¨¶‰∏≤Á±ªÂûã:', typeof text);
                    return '';
                }
            } catch (e) {
                console.error('[escapeHtml] ËΩ¨‰πâÂ§±Ë¥•:', e);
                return '';
            }
        }

        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return str.replace(/[&<>"']/g, m => map[m]);
    }

    // ÂÆâÂÖ®Âú∞Â∞ÜÂ≠óÁ¨¶‰∏≤IDËΩ¨Êç¢‰∏∫Êï∞Â≠óÔºàÈÅøÂÖçÁ≤æÂ∫¶‰∏¢Â§±Ôºâ
    function safeParseId(idStr) {
        if (!idStr) return null;

        // Â¶ÇÊûúÊòØÁ∫ØÊï∞Â≠óÂ≠óÁ¨¶‰∏≤
        if (/^\d+$/.test(idStr)) {
            // Ê£ÄÊü•ÊòØÂê¶Âú® JavaScript Number ÂÆâÂÖ®ËåÉÂõ¥ÂÜÖÔºà16‰Ωç‰ª•ÂÜÖÔºâ
            if (idStr.length <= 15) {
                return Number(idStr);
            }

            // Â¶ÇÊûúÈïøÂ∫¶Ë∂ÖËøá15‰Ωç‰ΩÜ‰∏çË∂ÖËøá19‰ΩçÔºàJava Long ÊúÄÂ§ßÂÄºÊòØ19‰ΩçÔºâ
            if (idStr.length <= 19) {
                try {
                    // ‰ΩøÁî® BigInt Ê£ÄÊü•ÊòØÂê¶Âú® Java Long ËåÉÂõ¥ÂÜÖ
                    const bigInt = BigInt(idStr);
                    const maxLong = BigInt('9223372036854775807'); // Java Long ÊúÄÂ§ßÂÄº

                    if (bigInt <= maxLong) {
                        // Ê£ÄÊü•ÊòØÂê¶Âú® JavaScript Number ÂÆâÂÖ®ËåÉÂõ¥ÂÜÖ
                        if (bigInt <= BigInt(Number.MAX_SAFE_INTEGER)) {
                            return Number(idStr);
                        } else {
                            // Ë∂ÖÂá∫ÂÆâÂÖ®ËåÉÂõ¥Ôºå‰ΩÜ‰ªçÂú® Long ËåÉÂõ¥ÂÜÖ
                            // ‰ΩøÁî® Number() ËΩ¨Êç¢ÂèØËÉΩ‰ºö‰∏¢Â§±Á≤æÂ∫¶Ôºå‰ΩÜÂêéÁ´Ø‰ºöÊé•Âèó
                            console.warn('Ê®°ÊùøIDË∂ÖÂá∫JavaScriptÂÆâÂÖ®ËåÉÂõ¥ÔºåÂèØËÉΩÂ≠òÂú®Á≤æÂ∫¶‰∏¢Â§±:', idStr);
                            return Number(idStr);
                        }
                    } else {
                        console.error('Ê®°ÊùøIDË∂ÖÂá∫Java LongËåÉÂõ¥:', idStr);
                        return null;
                    }
                } catch (e) {
                    console.error('Ê®°ÊùøIDËΩ¨Êç¢Â§±Ë¥•:', e);
                    return null;
                }
            }

            console.error('Ê®°ÊùøIDËøáÈïø:', idStr);
            return null;
        }

        // Â¶ÇÊûú‰∏çÊòØÁ∫ØÊï∞Â≠óÂ≠óÁ¨¶‰∏≤ÔºåÂ∞ùËØïËΩ¨Êç¢ÔºàÂèØËÉΩÊòØÂÖ∂‰ªñÊ†ºÂºèÔºâ
        const num = Number(idStr);
        if (isNaN(num)) {
            console.error('Ê®°ÊùøID‰∏çÊòØÊúâÊïàÊï∞Â≠ó:', idStr);
            return null;
        }
        return num;
    }

    // Âä†ËΩΩÊ®°ÊùøÂàóË°®Âà∞‰∏ãÊãâÊ°Ü
    function loadTemplates() {
        const $select = $('#templateId');
        $select.prop('disabled', true).html('<option value="">Âä†ËΩΩ‰∏≠...</option>');

        $.ajax({
            url: api.templateList,
            method: 'GET',
            dataType: 'json',
            success: function(res) {
                const templates = res.data || [];
                $select.html('<option value="">ËØ∑ÈÄâÊã©Ê®°Êùø...</option>');

                templates.forEach(t => {
                    // Â≠òÂÇ®ÂéüÂßãIDÂÄºÔºåÈÅøÂÖçÁ≤æÂ∫¶‰∏¢Â§±
                    const $option = $('<option></option>')
                        .attr('value', t.id)
                        .text(`${t.templateName} (${t.templateType})`);
                    $select.append($option);
                });
                $select.prop('disabled', false);
            },
            error: function(xhr) {
                // ‰∏çÂú®ËøôÈáåÂ§ÑÁêÜÈîôËØØÔºåËÆ©ÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜÂô®Â§ÑÁêÜ
                console.log('[loadTemplates] AJAXËØ∑Ê±ÇÂ§±Ë¥•Ôºå‰∫§ÁªôÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜÂô®Â§ÑÁêÜ');
                // Âª∂Ëøü‰∏Ä‰∏ãÔºåÂ¶ÇÊûúÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜÂô®Â§ÑÁêÜ‰∫ÜÔºà‰ºöË∑≥ËΩ¨ÔºâÔºåËøôË°å‰ª£Á†Å‰∏ç‰ºöÊâßË°å
                setTimeout(function() {
                    // Â¶ÇÊûúÈ°µÈù¢ËøòÂú®ÔºàÊ≤°ÊúâË∑≥ËΩ¨ÔºâÔºåËØ¥ÊòéÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜÂô®Ê≤°ÊúâÂ§ÑÁêÜÔºåÊòæÁ§∫ÈîôËØØ
                    if ($select.length > 0) {
                        $select.html('<option value="">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØï</option>');
                        alert('Âä†ËΩΩÊ®°ÊùøÂàóË°®Â§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                    }
                }, 500);
            }
        });
    }

    // ÈáçÁΩÆÊ†áÈ¢òË°®Âçï
    function resetTitleForm() {
        $('#titleId').val('');
        $('#titleName').val('');
        $('#titleKey').val('');
        $('#templateId').val('');
        $('#displayOrder').val('1');
        $('#titleFormTitle').text('Ê∑ªÂä†Ê†áÈ¢ò');
        $('#submitTitleBtn').text('Ê∑ªÂä†Ê†áÈ¢ò');
        $('#cancelEditTitleBtn').hide();
    }

    // ÂèñÊ∂àÁºñËæë
    function cancelEditTitle() {
        resetTitleForm();
        if (currentContext.id && currentContext.hasConfig) {
            $('#welcomeSection').hide();
            $('#addTitleSection').hide();
            $('#titleSection').show();
            $('#btnAddTitle').show();
        }
    }

    // ÁºñËæëÊ†áÈ¢ò
    function editTitle(titleId) {
        if (!titleId) {
            alert('Ê†áÈ¢òID‰∏çËÉΩ‰∏∫Á©∫');
            return;
        }

        // Âä†ËΩΩÊ†áÈ¢ò‰ø°ÊÅØ
        $.ajax({
            url: api.titleGetInfo,
            method: 'GET',
            data: { id: String(titleId) },
            success: function(res) {
                if (res.code === 2000 && res.data) {
                    const title = res.data;

                    // Â°´ÂÖÖË°®Âçï
                    $('#titleId').val(title.id || '');
                    $('#titleName').val(title.titleName || '');
                    $('#titleKey').val(title.titleKey || '');
                    $('#displayOrder').val(title.displayOrder || 1);

                    // Âä†ËΩΩÊ®°ÊùøÂàóË°®Âπ∂ËÆæÁΩÆÈÄâ‰∏≠ÂÄº
                    loadTemplates().done(function() {
                        if (title.templateId) {
                            $('#templateId').val(String(title.templateId));
                        }
                    });

                    // Êõ¥Êñ∞Ë°®ÂçïÊ†áÈ¢òÂíåÊåâÈíÆ
                    $('#titleFormTitle').text('ÁºñËæëÊ†áÈ¢ò');
                    $('#submitTitleBtn').text('‰øùÂ≠ò‰øÆÊîπ');
                    $('#cancelEditTitleBtn').show();

                    // ÊòæÁ§∫Ë°®ÂçïÔºåÈöêËóèÂàóË°®
                    $('#welcomeSection').hide();
                    $('#titleSection').hide();
                    $('#addTitleSection').show();
                } else {
                    alert('Âä†ËΩΩÊ†áÈ¢ò‰ø°ÊÅØÂ§±Ë¥•Ôºö' + (res.message || 'Êú™Áü•ÈîôËØØ'));
                }
            },
            error: function(xhr) {
                const msg = xhr.responseJSON?.message || 'Âä†ËΩΩÊ†áÈ¢ò‰ø°ÊÅØÂ§±Ë¥•ÔºåËØ∑ÈáçËØï';
                alert(msg);
            }
        });
    }

    // Âà†Èô§Ê†áÈ¢ò
    function deleteTitle(titleId, titleName) {
        if (!titleId) {
            alert('Ê†áÈ¢òID‰∏çËÉΩ‰∏∫Á©∫');
            return;
        }

        const confirmMsg = `Á°ÆÂÆöË¶ÅÂà†Èô§Ê†áÈ¢ò"${titleName || titleId}"ÂêóÔºü\nÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`;
        if (!confirm(confirmMsg)) {
            return;
        }

        $.ajax({
            url: api.titleDelete,
            method: 'DELETE',
            contentType: 'application/json',
            data: JSON.stringify([String(titleId)]),
            success: function(res) {
                if (res.code === 2000 && res.data) {
                    // ‰øùÂ≠òÂΩìÂâç‰∏ä‰∏ãÊñáIDÔºåÁî®‰∫éÈáçÊñ∞Âä†ËΩΩ
                    const savedContextId = currentContext.id;

                    // Á´ãÂç≥‰ªéDOM‰∏≠ÁßªÈô§Â∑≤Âà†Èô§ÁöÑÊ†áÈ¢òtab
                    const tabId = `tab-${titleId}`;
                    const $tabItem = $(`.tab-item[data-tab-id="${tabId}"]`);
                    if ($tabItem.length) {
                        // ÁßªÈô§Êï¥‰∏™ tab-item-wrapperÔºàÂåÖÂê´tabÊåâÈíÆÂíåÊìç‰ΩúÊåâÈíÆÔºâ
                        $tabItem.closest('.tab-item-wrapper').remove();
                    }

                    // Âà†Èô§ÂØπÂ∫îÁöÑtabÂÜÖÂÆπ
                    $(`#${tabId}`).remove();

                    // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÊøÄÊ¥ªÁöÑtabÔºåÊ∏ÖÁ©∫Ê¥ªÂä®tab ID
                    if (activeTabId === tabId) {
                        activeTabId = null;
                    }

                    // Âè™Âà∑Êñ∞Ê†áÈ¢òÂàóË°®Â§¥ÈÉ®Ôºà‰∏çÂä†ËΩΩtabÂÜÖÂÆπÔºåÈÅøÂÖçË∞ÉÁî®getInfoByIdÔºâ
                    if (savedContextId) {
                        refreshTitlesList(savedContextId);
                    } else {
                        // Â¶ÇÊûúÂàóË°®‰∏∫Á©∫ÔºåÊòæÁ§∫Á©∫Áä∂ÊÄÅ
                        const $remainingTabs = $('.tab-item[data-tab-id]');
                        if ($remainingTabs.length === 0) {
                            $('#titleList').empty().append('<div class="title-empty">ËØ•‰∏ä‰∏ãÊñáÊöÇÊó†Ê†áÈ¢ò</div>');
                            $('#welcomeSection').hide();
                            $('#titleSection').show();
                            $('#btnAddTitle').show();
                            $('#addTitleSection').hide();
                        }
                    }

                    // ÂêéÂè∞Êõ¥Êñ∞Ê†ë‰ª•Êõ¥Êñ∞hasConfigÁä∂ÊÄÅÔºà‰∏çÈòªÂ°ûUIÔºâ
                    loadTree();

                    alert('Ê†áÈ¢òÂà†Èô§ÊàêÂäüÔºÅ');
                } else {
                    alert('Âà†Èô§Â§±Ë¥•Ôºö' + (res.message || res.msg || 'Êú™Áü•ÈîôËØØ'));
                }
            },
            error: function(xhr) {
                const msg = xhr.responseJSON?.message || 'Âà†Èô§Â§±Ë¥•ÔºåËØ∑ÈáçËØï';
                alert(msg);
            }
        });
    }

    // Ê∑ªÂä†Ê†áÈ¢òË°®ÂçïÊèê‰∫§ÔºàÊîØÊåÅÊ∑ªÂä†ÂíåÁºñËæëÔºâ
    $('#addTitleForm').on('submit', function(e) {
        e.preventDefault();

        if (!currentContext.id) {
            alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ÈÖçÁΩÆË∑ØÂæÑÁõÆÂΩï');
            return;
        }

        const templateIdValue = $('#templateId').val();
        if (!templateIdValue) {
            alert('ËØ∑ÈÄâÊã©Ê®°Êùø');
            return;
        }

        // È™åËØÅÊ®°ÊùøIDÊ†ºÂºè
        if (!/^\d+$/.test(templateIdValue)) {
            alert('Ê®°ÊùøIDÊ†ºÂºèÈîôËØØÔºåËØ∑ÈáçÊñ∞ÈÄâÊã©Ê®°Êùø');
            return;
        }

        // Ê£ÄÊü•ÊòØÂê¶Âú® Java Long ËåÉÂõ¥ÂÜÖ
        try {
            const bigInt = BigInt(templateIdValue);
            const maxLong = BigInt('9223372036854775807');
            if (bigInt > maxLong) {
                alert('Ê®°ÊùøIDË∂ÖÂá∫ÊúâÊïàËåÉÂõ¥ÔºåËØ∑ÈáçÊñ∞ÈÄâÊã©Ê®°Êùø');
                return;
            }
        } catch (e) {
            alert('Ê®°ÊùøIDÊ†ºÂºèÈîôËØØÔºåËØ∑ÈáçÊñ∞ÈÄâÊã©Ê®°Êùø');
            return;
        }

        // ÊûÑÂª∫Ë°®ÂçïÊï∞ÊçÆ
        const titleId = $('#titleId').val();
        const contextId = currentContext.id ? String(currentContext.id) : null;
        const titleName = $('#titleName').val().trim();
        const titleKey = $('#titleKey').val().trim();
        const displayOrder = parseInt($('#displayOrder').val()) || 1;

        if (!titleName || !titleKey) {
            alert('ËØ∑Â°´ÂÜôÊâÄÊúâÂøÖÂ°´È°π');
            return;
        }

        const $btn = $('#submitTitleBtn');
        const isEdit = !!titleId;
        $btn.prop('disabled', true).text(isEdit ? '‰øùÂ≠ò‰∏≠...' : 'Ê∑ªÂä†‰∏≠...');

        let apiUrl, formData;

        if (isEdit) {
            // ÁºñËæëÊ®°Âºè
            apiUrl = api.titleUpdate;
            formData = {
                id: String(titleId),  // ID‰ΩøÁî®StringÁ±ªÂûãÔºåÈÅøÂÖçÁ≤æÂ∫¶ÈóÆÈ¢ò
                contextId: String(contextId),  // ID‰ΩøÁî®StringÁ±ªÂûã
                titleName: titleName,
                titleKey: titleKey,
                templateId: String(templateIdValue),  // ID‰ΩøÁî®StringÁ±ªÂûãÔºåÈÅøÂÖçÁ≤æÂ∫¶ÈóÆÈ¢ò
                displayOrder: displayOrder
            };
        } else {
            // Ê∑ªÂä†Ê®°Âºè
            apiUrl = api.titleInsert;
            formData = {
                contextId: String(contextId),  // ID‰ΩøÁî®StringÁ±ªÂûã
                titleName: titleName,
                titleKey: titleKey,
                templateId: String(templateIdValue),  // ID‰ΩøÁî®StringÁ±ªÂûãÔºåÈÅøÂÖçÁ≤æÂ∫¶ÈóÆÈ¢ò
                displayOrder: displayOrder
            };
        }

        const jsonData = JSON.stringify(formData);

        $.ajax({
            url: apiUrl,
            type: 'POST',
            contentType: 'application/json',
            data: jsonData,
            success: function(res) {
                if (res.code === 2000 && res.data) {
                    alert(isEdit ? 'Ê†áÈ¢ò‰øÆÊîπÊàêÂäüÔºÅ' : 'Ê†áÈ¢òÊ∑ªÂä†ÊàêÂäüÔºÅ');
                    resetTitleForm();

                    // ‰øùÂ≠òÂΩìÂâç‰∏ä‰∏ãÊñáIDÔºåÁî®‰∫éÈáçÊñ∞Âä†ËΩΩ
                    const savedContextId = currentContext.id;

                    // ÈöêËóèÊ∑ªÂä†Ë°®ÂçïÔºåÊòæÁ§∫Ê†áÈ¢òÂàóË°®Âå∫Âüü
                    $('#welcomeSection').hide();
                    $('#addTitleSection').hide();
                    $('#titleSection').show();
                    $('#btnAddTitle').show();

                    // ÈáçÊñ∞Âä†ËΩΩÊ†áÈ¢òÂàóË°®Ôºà‰ºöÂõûÂà∞ÂàóË°®È°µÈù¢ÔºåÂπ∂Âä†ËΩΩÁ¨¨‰∏Ä‰∏™tabÁöÑÂÜÖÂÆπÔºâ
                    if (savedContextId) {
                        loadTitles(savedContextId);
                    }

                    // ÂêéÂè∞Êõ¥Êñ∞Ê†ë‰ª•Êõ¥Êñ∞hasConfigÁä∂ÊÄÅÔºà‰∏çÈòªÂ°ûUIÔºâ
                    loadTree();
                } else {
                    alert((isEdit ? '‰øÆÊîπ' : 'Ê∑ªÂä†') + 'Â§±Ë¥•Ôºö' + (res.message || 'Êú™Áü•ÈîôËØØ'));
                }
            },
            error: function(xhr) {
                const msg = xhr.responseJSON?.message || (isEdit ? '‰øÆÊîπ' : 'Ê∑ªÂä†') + 'Â§±Ë¥•ÔºåËØ∑ÈáçËØï';
                alert(msg);
            },
            complete: function() {
                $btn.prop('disabled', false).text(isEdit ? '‰øùÂ≠ò‰øÆÊîπ' : 'Ê∑ªÂä†Ê†áÈ¢ò');
            }
        });
    });

    // Ê∑ªÂä†Ê†áÈ¢òÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
    $('#btnAddTitle').on('click', function() {
        resetTitleForm();
        loadTemplates();
        $('#welcomeSection').hide();
        $('#titleSection').hide();
        $('#addTitleSection').show();
    });


    // ÊêúÁ¥¢ËøáÊª§ÂäüËÉΩ
    $('#filter').on('input', function() {
        const query = $(this).val().toLowerCase();
        if (!query) {
            $('#contextTree .context-item').show();
            return;
        }

        $('#contextTree .context-item').each(function() {
            const text = $(this).text().toLowerCase();
            $(this).toggle(text.includes(query));
        });
    });

    $('#reloadTree').on('click', loadTree);

    // Á°Æ‰øùÁôªÂá∫ÊåâÈíÆÂèØËßÅ
    function ensureLogoutButtonVisible() {
        var $logoutBtn = $('#logoutBtn');
        if ($logoutBtn.length > 0) {
            $logoutBtn.css({
                'display': 'inline-flex',
                'visibility': 'visible',
                'opacity': '1'
            });
            console.log('ÁôªÂá∫ÊåâÈíÆÂ∑≤Á°Æ‰øùÂèØËßÅ');
        } else {
            console.warn('Êú™ÊâæÂà∞ÁôªÂá∫ÊåâÈíÆÂÖÉÁ¥†');
        }
    }

    // ËÆæÁΩÆÂØºËà™ËèúÂçïÊøÄÊ¥ªÁä∂ÊÄÅ
    function setActiveNavItem() {
        const currentPath = window.location.pathname;
        $('.nav-item').removeClass('active');

        if (currentPath.includes('/blbb/dict')) {
            $('#navDict').addClass('active');
        } else {
            $('#navEditor').addClass('active');
        }
    }

    // Â≠òÂÇ®ÊâÄÊúâ‰∏ä‰∏ãÊñáÊï∞ÊçÆÔºåÁî®‰∫éÂ°´ÂÖÖÁà∂Á∫ß‰∏ä‰∏ãÊñá‰∏ãÊãâÊ°Ü
    let allContextsForSelect = [];

    // Â°´ÂÖÖÁà∂Á∫ß‰∏ä‰∏ãÊñá‰∏ãÊãâÊ°Ü
    function populateParentContextSelect() {
        const $select = $('#contextParentId');
        $select.html('<option value="">ËØ∑ÈÄâÊã©Áà∂Á∫ß‰∏ä‰∏ãÊñá</option>');

        // Êèê‰æõÊ†πÁõÆÂΩïÈÄâÈ°πÔºåÁî®‰∫éÂàõÂª∫È°∂Á∫ßË∑ØÂæÑ
        const $rootOption = $('<option></option>')
            .attr('value', 'ROOT')
            .text('Ê†πÁõÆÂΩï')
            .data('contextPath', '/')
            .data('nodeLevel', 0);
        $select.append($rootOption);

        function addOptions(contexts, prefix = '') {
            contexts.forEach(ctx => {
                const displayText = prefix + (ctx.nodeName || ctx.contextPath) + (ctx.description ? ' - ' + ctx.description : '');
                // Á°Æ‰øù id ËΩ¨Êç¢‰∏∫Â≠óÁ¨¶‰∏≤ÔºåÈÅøÂÖçÂ§ßÊï¥Êï∞Á≤æÂ∫¶‰∏¢Â§±
                const idStr = String(ctx.id || '');
                const $option = $('<option></option>')
                    .attr('value', idStr)
                    .text(displayText)
                    .data('contextPath', ctx.contextPath || '')
                    .data('nodeLevel', ctx.nodeLevel || 0);
                $select.append($option);

                if (ctx.children && ctx.children.length > 0) {
                    addOptions(ctx.children, prefix + '  ');
                }
            });
        }

        if (allContextsForSelect.length > 0) {
            addOptions(allContextsForSelect);
        }
    }

    // Êõ¥Êñ∞Ë∑ØÂæÑÈ¢ÑËßàÂíåËá™Âä®ËÆ°ÁÆóË∑ØÂæÑ„ÄÅÂ±ÇÁ∫ß
    function updatePathPreview() {
        const parentId = $('#contextParentId').val();
        const nodeName = $('#nodeName').val().trim();

        if (!parentId) {
            $('#pathPreview').text('ËØ∑ÈÄâÊã©Áà∂Á∫ß‰∏ä‰∏ãÊñáÂπ∂ËæìÂÖ•ËäÇÁÇπÂêçÁß∞');
            $('#contextPath').val('');
            $('#nodeLevel').val('');
            return;
        }

        if (!nodeName) {
            $('#pathPreview').text('ËØ∑ËæìÂÖ•ËäÇÁÇπÂêçÁß∞');
            $('#contextPath').val('');
            $('#nodeLevel').val('');
            return;
        }

        // È™åËØÅËäÇÁÇπÂêçÁß∞Âè™ËÉΩÂåÖÂê´Ëã±Êñá„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫ø
        if (!/^[A-Za-z0-9_]+$/.test(nodeName)) {
            $('#pathPreview').html('<span style="color: red;">ËäÇÁÇπÂêçÁß∞Âè™ËÉΩÂåÖÂê´Ëã±ÊñáÂ≠óÊØç„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫ø</span>');
            $('#contextPath').val('');
            $('#nodeLevel').val('');
            return;
        }

        // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÁà∂Á∫ß‰∏ä‰∏ãÊñáÈÄâÈ°π
        const $selectedOption = $('#contextParentId option:selected');
        const parentPath = $selectedOption.data('contextPath') || '';
        const parentLevel = $selectedOption.data('nodeLevel') || 0;

        // ÊãºÊé•Ë∑ØÂæÑ
        let contextPath;
        if (!parentPath || parentPath === '/' || parentPath.trim() === '') {
            // Ê†πËäÇÁÇπÁöÑÊÉÖÂÜµÔºåÁõ¥Êé•ÊãºÊé•
            contextPath = '/' + nodeName;
        } else {
            // Á°Æ‰øùÁà∂Ë∑ØÂæÑ‰ª•/ÂºÄÂ§¥ÔºåÁÑ∂ÂêéÊãºÊé•ËäÇÁÇπÂêçÁß∞
            const normalizedParentPath = parentPath.startsWith('/') ? parentPath : '/' + parentPath;
            contextPath = normalizedParentPath + '/' + nodeName;
        }

        // ËÆ°ÁÆóÂ±ÇÁ∫ß
        const nodeLevel = (parentLevel || 0) + 1;

        // Êõ¥Êñ∞È¢ÑËßàÂíåÈöêËóèÂ≠óÊÆµ
        $('#pathPreview').text(contextPath + ' (Â±ÇÁ∫ß: ' + nodeLevel + ')');
        $('#contextPath').val(contextPath);
        $('#nodeLevel').val(nodeLevel);
    }

    // ÊâìÂºÄÊ∑ªÂä†‰∏ä‰∏ãÊñáÊ®°ÊÄÅÊ°Ü
    function openAddContextModal() {
        // ÈáçÊñ∞Âä†ËΩΩ‰∏ä‰∏ãÊñáÊ†ë‰ª•Ëé∑ÂèñÊúÄÊñ∞Êï∞ÊçÆ
        $.ajax({
            url: api.tree,
            method: 'GET',
            dataType: 'json',
            success: function(res) {
                allContextsForSelect = res.data || [];
                populateParentContextSelect();
                $('#addContextForm')[0].reset();
                $('#pathPreview').text('ËØ∑ÈÄâÊã©Áà∂Á∫ß‰∏ä‰∏ãÊñáÂπ∂ËæìÂÖ•ËäÇÁÇπÂêçÁß∞');
                $('#contextPath').val('');
                $('#nodeLevel').val('');

                // Â¶ÇÊûúÂΩìÂâçÈÄâÊã©‰∫Ü‰∏ä‰∏ãÊñáÔºåËÆæ‰∏∫Áà∂Á∫ß
                if (currentContext.id) {
                    // Á°Æ‰øù id ËΩ¨Êç¢‰∏∫Â≠óÁ¨¶‰∏≤ÔºåÈÅøÂÖçÂ§ßÊï¥Êï∞Á≤æÂ∫¶‰∏¢Â§±
                    $('#contextParentId').val(String(currentContext.id));
                    updatePathPreview();
                }

                $('#addContextModal').addClass('show');
            },
            error: function() {
                alert('Âä†ËΩΩ‰∏ä‰∏ãÊñáÂàóË°®Â§±Ë¥•');
            }
        });
    }

    // ÂÖ≥Èó≠Ê∑ªÂä†‰∏ä‰∏ãÊñáÊ®°ÊÄÅÊ°Ü
    function closeAddContextModal() {
        $('#addContextModal').removeClass('show');
    }

    // Êèê‰∫§Ê∑ªÂä†‰∏ä‰∏ãÊñá
    function submitAddContext() {
        const form = $('#addContextForm')[0];
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const parentId = $('#contextParentId').val();
        const contextPath = $('#contextPath').val().trim();
        const nodeName = $('#nodeName').val().trim();
        const nodeLevel = parseInt($('#nodeLevel').val()) || 0;
        const description = $('#description').val().trim();

        // È™åËØÅÁà∂Á∫ß‰∏ä‰∏ãÊñáÂøÖÈ°ªÈÄâÊã©
        if (!parentId) {
            alert('ËØ∑ÈÄâÊã©Áà∂Á∫ß‰∏ä‰∏ãÊñá');
            return;
        }

        // È™åËØÅËäÇÁÇπÂêçÁß∞Ê†ºÂºè
        if (!nodeName) {
            alert('ËØ∑ËæìÂÖ•ËäÇÁÇπÂêçÁß∞');
            return;
        }

        if (!/^[A-Za-z0-9_]+$/.test(nodeName)) {
            alert('ËäÇÁÇπÂêçÁß∞Âè™ËÉΩÂåÖÂê´Ëã±ÊñáÂ≠óÊØç„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫ø');
            return;
        }

        // È™åËØÅË∑ØÂæÑÂíåÂ±ÇÁ∫ßÊòØÂê¶Â∑≤Ëá™Âä®ËÆ°ÁÆó
        if (!contextPath || !contextPath.startsWith('/')) {
            alert('Ë∑ØÂæÑËÆ°ÁÆóÈîôËØØÔºåËØ∑ÈáçÊñ∞ÈÄâÊã©Áà∂Á∫ß‰∏ä‰∏ãÊñáÂíåËæìÂÖ•ËäÇÁÇπÂêçÁß∞');
            updatePathPreview();
            return;
        }

        // È™åËØÅ parentId Ê†ºÂºèÔºåÊîØÊåÅÈÄâÊã©‚ÄúÊ†πÁõÆÂΩï‚ÄùÂàõÂª∫È°∂Á∫ßË∑ØÂæÑ
        let parentIdStr = null;
        if (parentId) {
            const trimmedId = String(parentId).trim();
            if (trimmedId === 'ROOT') {
                // È°∂Á∫ßË∑ØÂæÑÔºåÁà∂Á∫ß‰∏∫Á©∫
                parentIdStr = null;
            } else {
                // È™åËØÅÊòØÂê¶‰∏∫Á∫ØÊï∞Â≠ó
                if (!/^\d+$/.test(trimmedId)) {
                    alert('Áà∂Á∫ßIDÊ†ºÂºèÈîôËØØ');
                    return;
                }
                // Ê£ÄÊü•ÊòØÂê¶Âú® Java Long ËåÉÂõ¥ÂÜÖ
                try {
                    const bigInt = BigInt(trimmedId);
                    const maxLong = BigInt('9223372036854775807');
                    if (bigInt > maxLong) {
                        alert('Áà∂Á∫ßIDË∂ÖÂá∫ÊúâÊïàËåÉÂõ¥');
                        return;
                    }
                    parentIdStr = trimmedId; // ‰øùÊåÅ‰∏∫Â≠óÁ¨¶‰∏≤ÔºåÈÅøÂÖçÁ≤æÂ∫¶‰∏¢Â§±
                } catch (e) {
                    alert('Áà∂Á∫ßIDÊ†ºÂºèÈîôËØØ');
                    return;
                }
            }
        }

        const data = {
            parentId: parentIdStr,
            contextPath: contextPath,
            nodeName: nodeName,
            nodeLevel: nodeLevel,
            description: description || null,
            hasConfig: false
        };

        $.ajax({
            url: api.contextInsert,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            dataType: 'json',
            success: function(res) {
                if (res.code === 2000) {
                    closeAddContextModal();
                    loadTree();
                    alert('Ê∑ªÂä†ÊàêÂäü');
                } else {
                    alert(res.message || 'Ê∑ªÂä†Â§±Ë¥•');
                }
            },
            error: function(xhr) {
                let errorMsg = 'Ê∑ªÂä†Â§±Ë¥•';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg = xhr.responseJSON.message;
                } else if (xhr.responseText) {
                    try {
                        const res = JSON.parse(xhr.responseText);
                        errorMsg = res.message || errorMsg;
                    } catch (e) {
                        // ÂøΩÁï•Ëß£ÊûêÈîôËØØ
                    }
                }
                alert(errorMsg);
            }
        });
    }

    // ÂÖ®Â±ÄÂèòÈáèÔºöÂ≠òÂÇ®ÊâÄÊúâ‰∏ä‰∏ãÊñáÂàóË°®ÔºåÁî®‰∫éÊü•ÊâæÁà∂Á∫ßË∑ØÂæÑ
    let allContextsMap = {};

    // ÊâìÂºÄÁºñËæë‰∏ä‰∏ãÊñáÊ®°ÊÄÅÊ°Ü
    function openEditContextModal(contextId) {
        // È¶ñÂÖàËé∑Âèñ‰∏ä‰∏ãÊñá‰ø°ÊÅØ
        $.ajax({
            url: api.contextGetInfo,
            method: 'GET',
            data: { id: String(contextId) },
            dataType: 'json',
            success: function(res) {
                if (res.code === 2000 && res.data) {
                    const contextData = res.data;

                    // Â°´ÂÖÖË°®ÂçïÊï∞ÊçÆ
                    $('#editContextId').val(contextData.id);
                    $('#editNodeName').val(contextData.nodeName || '');
                    $('#editParentId').val(contextData.parentId ? String(contextData.parentId) : '');
                    $('#editContextPath').val(contextData.contextPath || '');
                    $('#editNodeLevel').val(contextData.nodeLevel || 0);
                    $('#editDescription').val(contextData.description || '');
                    $('#editHasConfig').val(contextData.hasConfig ? 'true' : 'false');

                    // Âä†ËΩΩÊâÄÊúâ‰∏ä‰∏ãÊñá‰ª•Ëé∑ÂèñÁà∂Á∫ßË∑ØÂæÑ
                    $.ajax({
                        url: api.tree,
                        method: 'GET',
                        dataType: 'json',
                        success: function(treeRes) {
                            if (treeRes.code === 2000 && treeRes.data) {
                                // ÊûÑÂª∫‰∏ä‰∏ãÊñáÊò†Â∞ÑË°®ÔºåÊñπ‰æøÊü•Êâæ
                                allContextsMap = {};
                                function buildContextMap(nodes) {
                                    if (nodes && nodes.length > 0) {
                                        nodes.forEach(function(node) {
                                            allContextsMap[String(node.id)] = node;
                                            if (node.children && node.children.length > 0) {
                                                buildContextMap(node.children);
                                            }
                                        });
                                    }
                                }
                                buildContextMap(treeRes.data);

                                // Êõ¥Êñ∞Ë∑ØÂæÑÈ¢ÑËßà
                                updateEditPathPreview();

                                // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
                                $('#editContextModal').addClass('show');
                            } else {
                                alert('Âä†ËΩΩ‰∏ä‰∏ãÊñáÊ†ëÂ§±Ë¥•');
                            }
                        },
                        error: function() {
                            alert('Âä†ËΩΩ‰∏ä‰∏ãÊñáÊ†ëÂ§±Ë¥•');
                        }
                    });
                } else {
                    alert('Ëé∑Âèñ‰∏ä‰∏ãÊñá‰ø°ÊÅØÂ§±Ë¥•: ' + (res.msg || 'Êú™Áü•ÈîôËØØ'));
                }
            },
            error: function() {
                alert('Ëé∑Âèñ‰∏ä‰∏ãÊñá‰ø°ÊÅØÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        });
    }

    // ÂÖ≥Èó≠ÁºñËæë‰∏ä‰∏ãÊñáÊ®°ÊÄÅÊ°Ü
    function closeEditContextModal() {
        $('#editContextModal').removeClass('show');
        $('#editContextForm')[0].reset();
    }

    // ÊòæÁ§∫ÂèòÊõ¥Êï∞ÊçÆËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
    function showChangeDataDetail(title, changeData) {
        $('#changeDataDetailModalTitle').text(title || 'ÂèòÊõ¥Êï∞ÊçÆËØ¶ÊÉÖ');
        const $content = $('#changeDataDetailContent');
        
        // Ê∏ÖÁ©∫ÂÜÖÂÆπ
        $content.empty();
        
        // Â¶ÇÊûúÊ≤°ÊúâÂèòÊõ¥Êï∞ÊçÆÔºåÊòæÁ§∫ÊèêÁ§∫
        if (!changeData || changeData === '' || changeData === '-') {
            $content.html('<div style="padding: 20px; text-align: center; color: var(--text-secondary);">ÊöÇÊó†ÂèòÊõ¥Êï∞ÊçÆ</div>');
        } else {
            // Â¶ÇÊûúchangeDataÂ∑≤ÁªèÊòØÂØπË±°ÔºåÁõ¥Êé•‰ΩøÁî®ÔºõÂ¶ÇÊûúÊòØÂ≠óÁ¨¶‰∏≤ÔºåÂ∞ùËØïËß£Êûê‰∏∫JSON
            let changeDataObj = changeData;
            if (typeof changeData === 'string') {
                try {
                    // Â∞ùËØïËß£Êûê‰∏∫JSON
                    changeDataObj = JSON.parse(changeData);
                } catch (e) {
                    // Ëß£ÊûêÂ§±Ë¥•Ôºå‰Ωú‰∏∫ÊôÆÈÄöÊñáÊú¨Â§ÑÁêÜ
                    changeDataObj = changeData;
                }
            }
            
            // ‰ΩøÁî®Ê®°ÊùøÊ∏≤ÊüìÂ±ïÁ§∫Êï∞ÊçÆ
            renderChangeDataWithTemplate($content, changeDataObj);
        }
        
        // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
        $('#changeDataDetailModal').addClass('show');
    }

    // ‰ΩøÁî®Ê®°ÊùøÊ∏≤ÊüìÂèòÊõ¥Êï∞ÊçÆ
    function renderChangeDataWithTemplate($container, changeDataObj) {
        // Â¶ÇÊûúÊòØÂØπË±°ÊàñÊï∞ÁªÑÔºåÊ†ºÂºèÂåñ‰∏∫JSONÂ±ïÁ§∫
        if (typeof changeDataObj === 'object' && changeDataObj !== null) {
            // ÂàõÂª∫Ê†ºÂºèÂåñJSONÂ±ïÁ§∫Âå∫Âüü
            const $jsonViewer = $('<div class="json-viewer"></div>');
            
            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´Ê®°Êùø‰ø°ÊÅØÔºåÂ¶ÇÊûúÊúâÂàôÂ∞ùËØï‰ΩøÁî®Ê®°ÊùøÊ∏≤Êüì
            if (changeDataObj.templateId || changeDataObj.template) {
                // Â¶ÇÊûúÊúâÊ®°Êùø‰ø°ÊÅØÔºåÂèØ‰ª•Ë∞ÉÁî®Ê®°ÊùøÊ∏≤ÊüìÈÄªËæë
                // ËøôÈáåÂÖàÂ±ïÁ§∫JSONÔºåÂêéÁª≠ÂèØ‰ª•Ê†πÊçÆÈúÄË¶ÅÊâ©Â±ïÊ®°ÊùøÊ∏≤Êüì
                const formattedJson = JSON.stringify(changeDataObj, null, 2);
                $jsonViewer.html('<pre style="background: #f5f5f5; padding: 16px; border-radius: 8px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; font-family: \'Courier New\', monospace; font-size: 13px; line-height: 1.6;">' + escapeHtml(formattedJson) + '</pre>');
            } else {
                // ÊôÆÈÄöJSONÊ†ºÂºèÂåñÂ±ïÁ§∫
                const formattedJson = JSON.stringify(changeDataObj, null, 2);
                $jsonViewer.html('<pre style="background: #f5f5f5; padding: 16px; border-radius: 8px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; font-family: \'Courier New\', monospace; font-size: 13px; line-height: 1.6;">' + escapeHtml(formattedJson) + '</pre>');
            }
            
            $container.append($jsonViewer);
        } else {
            // ÈùûÂØπË±°Á±ªÂûãÔºåÁõ¥Êé•ÊòæÁ§∫
            $container.html('<pre style="background: #f5f5f5; padding: 16px; border-radius: 8px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;">' + escapeHtml(String(changeDataObj)) + '</pre>');
        }
    }

    // ÂÖ≥Èó≠ÂèòÊõ¥Êï∞ÊçÆËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
    function closeChangeDataDetailModal() {
        $('#changeDataDetailModal').removeClass('show');
        $('#changeDataDetailContent').empty();
    }

    // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
    $(document).on('click', '#changeDataDetailModal', function(e) {
        if ($(e.target).hasClass('modal-overlay')) {
            closeChangeDataDetailModal();
        }
    });

    // Êõ¥Êñ∞ÁºñËæëË∑ØÂæÑÈ¢ÑËßà
    function updateEditPathPreview() {
        const parentId = $('#editParentId').val();
        const nodeName = $('#editNodeName').val().trim();

        if (!nodeName) {
            $('#editPathPreview').text('ËØ∑ËæìÂÖ•ËäÇÁÇπÂêçÁß∞');
            $('#editContextPath').val('');
            return;
        }

        // È™åËØÅËäÇÁÇπÂêçÁß∞Âè™ËÉΩÂåÖÂê´Ëã±Êñá„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫ø
        if (!/^[A-Za-z0-9_]+$/.test(nodeName)) {
            $('#editPathPreview').html('<span style="color: red;">ËäÇÁÇπÂêçÁß∞Âè™ËÉΩÂåÖÂê´Ëã±ÊñáÂ≠óÊØç„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫ø</span>');
            $('#editContextPath').val('');
            return;
        }

        // Ëé∑ÂèñÁà∂Á∫ßË∑ØÂæÑ
        let parentPath = '';
        let parentLevel = 0;

        if (parentId) {
            const parentContext = allContextsMap[String(parentId)];
            if (parentContext) {
                parentPath = parentContext.contextPath || '';
                parentLevel = parentContext.nodeLevel || 0;
            }
        }

        // ÊãºÊé•Ë∑ØÂæÑ
        let contextPath;
        if (!parentPath || parentPath === '/' || parentPath.trim() === '') {
            // Ê†πËäÇÁÇπÁöÑÊÉÖÂÜµÔºåÁõ¥Êé•ÊãºÊé•
            contextPath = '/' + nodeName;
        } else {
            // Á°Æ‰øùÁà∂Ë∑ØÂæÑ‰ª•/ÂºÄÂ§¥ÔºåÁÑ∂ÂêéÊãºÊé•ËäÇÁÇπÂêçÁß∞
            const normalizedParentPath = parentPath.startsWith('/') ? parentPath : '/' + parentPath;
            contextPath = normalizedParentPath + '/' + nodeName;
        }

        // ËÆ°ÁÆóÂ±ÇÁ∫ß
        const nodeLevel = parentLevel + 1;

        // Êõ¥Êñ∞È¢ÑËßàÂíåÈöêËóèÂ≠óÊÆµ
        $('#editPathPreview').text(contextPath + ' (Â±ÇÁ∫ß: ' + nodeLevel + ')');
        $('#editContextPath').val(contextPath);
        $('#editNodeLevel').val(nodeLevel);
    }

    // Êèê‰∫§ÁºñËæë‰∏ä‰∏ãÊñá
    function submitEditContext() {
        const form = $('#editContextForm')[0];
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const contextId = $('#editContextId').val();
        const contextPath = $('#editContextPath').val().trim();
        const nodeName = $('#editNodeName').val().trim();
        const nodeLevel = parseInt($('#editNodeLevel').val()) || 0;
        const parentId = $('#editParentId').val();
        const description = $('#editDescription').val().trim();
        const hasConfig = $('#editHasConfig').val() === 'true';

        // È™åËØÅËäÇÁÇπÂêçÁß∞Ê†ºÂºè
        if (!nodeName) {
            alert('ËØ∑ËæìÂÖ•ËäÇÁÇπÂêçÁß∞');
            return;
        }

        if (!/^[A-Za-z0-9_]+$/.test(nodeName)) {
            alert('ËäÇÁÇπÂêçÁß∞Âè™ËÉΩÂåÖÂê´Ëã±ÊñáÂ≠óÊØç„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫ø');
            return;
        }

        // È™åËØÅË∑ØÂæÑÊòØÂê¶Â∑≤Ëá™Âä®ËÆ°ÁÆó
        if (!contextPath || !contextPath.startsWith('/')) {
            alert('Ë∑ØÂæÑËÆ°ÁÆóÈîôËØØÔºåËØ∑ÈáçÊñ∞ËæìÂÖ•ËäÇÁÇπÂêçÁß∞');
            updateEditPathPreview();
            return;
        }

        // È™åËØÅ parentId Ê†ºÂºè
        let parentIdStr = null;
        if (parentId && String(parentId).trim() !== '') {
            const trimmedId = String(parentId).trim();
            // È™åËØÅÊòØÂê¶‰∏∫Á∫ØÊï∞Â≠ó
            if (!/^\d+$/.test(trimmedId)) {
                alert('Áà∂Á∫ßIDÊ†ºÂºèÈîôËØØ');
                return;
            }
            // Ê£ÄÊü•ÊòØÂê¶Âú® Java Long ËåÉÂõ¥ÂÜÖ
            try {
                const bigInt = BigInt(trimmedId);
                const maxLong = BigInt('9223372036854775807');
                if (bigInt > maxLong) {
                    alert('Áà∂Á∫ßIDË∂ÖÂá∫ÊúâÊïàËåÉÂõ¥');
                    return;
                }
                parentIdStr = trimmedId; // ‰øùÊåÅ‰∏∫Â≠óÁ¨¶‰∏≤ÔºåÈÅøÂÖçÁ≤æÂ∫¶‰∏¢Â§±
            } catch (e) {
                alert('Áà∂Á∫ßIDÊ†ºÂºèÈîôËØØ');
                return;
            }
        }

        const data = {
            id: String(contextId),
            parentId: parentIdStr,
            contextPath: contextPath,
            nodeName: nodeName,
            nodeLevel: nodeLevel,
            description: description || null,
            hasConfig: hasConfig
        };

        $.ajax({
            url: api.contextUpdate,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            dataType: 'json',
            success: function(res) {
                if (res.code === 2000) {
                    closeEditContextModal();
                    // ‰øùÂ≠òÂΩìÂâç‰∏ä‰∏ãÊñáIDÔºåÁî®‰∫éÈáçÊñ∞ÈÄâÊã©
                    const savedContextId = currentContext.id;
                    loadTree().done(function() {
                        if (savedContextId) {
                            // Âª∂Ëøü‰∏Ä‰∏ãÁ°Æ‰øùÊ†ëÂ∑≤Ê∏≤ÊüìÂÆåÊàê
                            setTimeout(() => {
                                // Êü•ÊâæÂπ∂Ëß¶ÂèëÁÇπÂáª‰∫ã‰ª∂ÔºåËøô‰ºöËá™Âä®Ê†πÊçÆÊñ∞ÁöÑhasConfigÁä∂ÊÄÅÊòæÁ§∫Ê†áÈ¢òÂàóË°®
                                $('#contextTree').find(`[data-ctx-id="${savedContextId}"]`).each(function() {
                                    if ($(this).data('ctxId') === savedContextId) {
                                        $(this).click();
                                        return false; // Âè™Ëß¶ÂèëÁ¨¨‰∏Ä‰∏™ÂåπÈÖçÁöÑÂÖÉÁ¥†
                                    }
                                });
                            }, 300);
                        }
                    });
                    alert('‰øÆÊîπÊàêÂäü');
                } else {
                    alert(res.message || res.msg || '‰øÆÊîπÂ§±Ë¥•');
                }
            },
            error: function(xhr) {
                let errorMsg = '‰øÆÊîπÂ§±Ë¥•';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg = xhr.responseJSON.message;
                } else if (xhr.responseText) {
                    try {
                        const res = JSON.parse(xhr.responseText);
                        errorMsg = res.message || res.msg || errorMsg;
                    } catch (e) {
                        // ÂøΩÁï•Ëß£ÊûêÈîôËØØ
                    }
                }
                alert(errorMsg);
            }
        });
    }

    // Ê£ÄÊü•‰∏ä‰∏ãÊñáÂèäÂÖ∂Â≠ê‰∏ä‰∏ãÊñáÊòØÂê¶ÊúâÈÖçÁΩÆ
    function checkContextHasConfig(contextId) {
        return new Promise(function(resolve, reject) {
            // ÂÖàËé∑ÂèñÂΩìÂâç‰∏ä‰∏ãÊñáÂèäÂÖ∂ÊâÄÊúâÂ≠ê‰∏ä‰∏ãÊñáÁöÑ‰ø°ÊÅØ
            $.ajax({
                url: api.tree,
                method: 'GET',
                dataType: 'json',
                success: function(res) {
                    const allContexts = res.data || [];

                    // ÈÄíÂΩíÊü•ÊâæÊåáÂÆöIDÁöÑ‰∏ä‰∏ãÊñáÂèäÂÖ∂ÊâÄÊúâÂ≠êËäÇÁÇπ
                    function findContextAndChildren(contexts, targetId) {
                        const result = [];

                        function traverse(nodes, targetId) {
                            for (let node of nodes) {
                                if (node.id === targetId || String(node.id) === String(targetId)) {
                                    // ÊâæÂà∞ÁõÆÊ†áËäÇÁÇπÔºåÊî∂ÈõÜÂÆÉÂèäÂÖ∂ÊâÄÊúâÂ≠êËäÇÁÇπ
                                    result.push(node);
                                    if (node.children && node.children.length > 0) {
                                        collectChildren(node.children);
                                    }
                                    return true;
                                }
                                if (node.children && node.children.length > 0) {
                                    if (traverse(node.children, targetId)) {
                                        return true;
                                    }
                                }
                            }
                            return false;
                        }

                        function collectChildren(children) {
                            for (let child of children) {
                                result.push(child);
                                if (child.children && child.children.length > 0) {
                                    collectChildren(child.children);
                                }
                            }
                        }

                        traverse(contexts, targetId);
                        return result;
                    }

                    const contextsToCheck = findContextAndChildren(allContexts, contextId);
                    const contextsWithConfig = [];

                    // Ê£ÄÊü•ÊØè‰∏™‰∏ä‰∏ãÊñáÊòØÂê¶ÊúâÈÖçÁΩÆ
                    for (let ctx of contextsToCheck) {
                        const hasConfig = ctx.hasConfig === true || ctx.hasConfig === 1 || ctx.hasConfig === '1';
                        if (hasConfig) {
                            contextsWithConfig.push(ctx.nodeName || ctx.contextPath);
                        }
                    }

                    if (contextsWithConfig.length > 0) {
                        reject({
                            hasConfig: true,
                            contexts: contextsWithConfig,
                            message: '‰ª•‰∏ã‰∏ä‰∏ãÊñáÊàñÂÖ∂Â≠ê‰∏ä‰∏ãÊñáÂ≠òÂú®ÈÖçÁΩÆÔºåÊó†Ê≥ïÂà†Èô§: ' + contextsWithConfig.join(', ')
                        });
                    } else {
                        // Ëøõ‰∏ÄÊ≠•Ê£ÄÊü•ÊòØÂê¶ÊúâtitleÊï∞ÊçÆÔºàÂç≥‰ΩøhasConfig‰∏∫falseÔºå‰πüÂèØËÉΩÊúâtitleÊï∞ÊçÆÔºâ
                        // Áî±‰∫éÂâçÁ´ØÊó†Ê≥ïÁõ¥Êé•Êü•ËØ¢titleÔºåËøô‰∏™Ê£ÄÊü•Áî±ÂêéÁ´ØÂÆåÊàê
                        resolve({ hasConfig: false });
                    }
                },
                error: function() {
                    reject({ hasConfig: false, message: 'Ê£ÄÊü•ÈÖçÁΩÆÁä∂ÊÄÅÂ§±Ë¥•ÔºåËØ∑ÈáçËØï' });
                }
            });
        });
    }

    // Âà†Èô§‰∏ä‰∏ãÊñá
    function deleteContext(contextId, contextName) {
        if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§‰∏ä‰∏ãÊñá "${contextName}" ÂêóÔºü\nÊ≥®ÊÑèÔºöÂ¶ÇÊûúËØ•‰∏ä‰∏ãÊñáÊàñÂÖ∂Â≠ê‰∏ä‰∏ãÊñáÂ≠òÂú®ÈÖçÁΩÆÔºåÂ∞ÜÊó†Ê≥ïÂà†Èô§„ÄÇ`)) {
            return;
        }

        // Á°Æ‰øùcontextIdÊòØStringÁ±ªÂûãÔºåÈÅøÂÖçÁ≤æÂ∫¶ÈóÆÈ¢ò
        const contextIdStr = String(contextId);

        // ÂâçÁ´ØÂÖàÊ£ÄÊü•ÔºàÂü∫‰∫éÊ†ëÊï∞ÊçÆ‰∏≠ÁöÑhasConfigÂ≠óÊÆµÔºâ
        checkContextHasConfig(contextIdStr)
            .then(function() {
                // ÂâçÁ´ØÊ£ÄÊü•ÈÄöËøáÔºåË∞ÉÁî®ÂêéÁ´ØÂà†Èô§ÔºàÂêéÁ´Ø‰ºöÂÜçÊ¨°Ê£ÄÊü•Ôºâ
                $.ajax({
                    url: api.contextDelete,
                    method: 'DELETE',
                    contentType: 'application/json',
                    data: JSON.stringify([contextIdStr]),  // ID‰ΩøÁî®StringÁ±ªÂûãÔºåÈÅøÂÖçÁ≤æÂ∫¶ÈóÆÈ¢ò
                    dataType: 'json',
                    success: function(res) {
                        if (res.code === 2000) {
                            loadTree();
                            alert('Âà†Èô§ÊàêÂäü');
                            // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÈÄâÊã©ÁöÑ‰∏ä‰∏ãÊñáÔºåÊ∏ÖÁ©∫ÈÄâÊã©
                            if (String(currentContext.id) === contextIdStr) {
                                currentContext.id = null;
                                currentContext.hasConfig = false;
                                $('#titleSection').hide();
                                $('#addTitleSection').hide();
                                $('#welcomeSection').show();
                            }
                        } else {
                            alert(res.message || 'Âà†Èô§Â§±Ë¥•');
                        }
                    },
                    error: function(xhr) {
                        let errorMsg = 'Âà†Èô§Â§±Ë¥•';
                        if (xhr.responseJSON) {
                            // ÂêéÁ´ØËøîÂõûÊ†ºÂºè: { code: xxx, msg: "ÈîôËØØ‰ø°ÊÅØ", data: null }
                            errorMsg = xhr.responseJSON.msg || xhr.responseJSON.message || errorMsg;
                        } else if (xhr.responseText) {
                            try {
                                const res = JSON.parse(xhr.responseText);
                                errorMsg = res.msg || res.message || errorMsg;
                            } catch (e) {
                                // Â∞ùËØï‰ªéÂìçÂ∫îÊñáÊú¨‰∏≠ÊèêÂèñÈîôËØØ‰ø°ÊÅØ
                                if (xhr.responseText.includes('Â≠òÂú®ÈÖçÁΩÆ')) {
                                    errorMsg = xhr.responseText.match(/Â≠òÂú®ÈÖçÁΩÆ[^<]*/)?.[0] || errorMsg;
                                }
                            }
                        }
                        alert(errorMsg);
                    }
                });
            })
            .catch(function(error) {
                // ÂâçÁ´ØÊ£ÄÊü•ÂèëÁé∞Â≠òÂú®ÈÖçÁΩÆ
                if (error.hasConfig) {
                    alert(error.message || 'ËØ•‰∏ä‰∏ãÊñáÊàñÂÖ∂Â≠ê‰∏ä‰∏ãÊñáÂ≠òÂú®ÈÖçÁΩÆÔºåÊó†Ê≥ïÂà†Èô§');
                } else {
                            // Ê£ÄÊü•Â§±Ë¥•Ôºå‰ªçÁÑ∂Â∞ùËØïÂà†Èô§ÔºàËÆ©ÂêéÁ´ØÊúÄÁªàÂà§Êñ≠Ôºâ
                    $.ajax({
                        url: api.contextDelete,
                        method: 'DELETE',
                        contentType: 'application/json',
                        data: JSON.stringify([contextIdStr]),  // ID‰ΩøÁî®StringÁ±ªÂûãÔºåÈÅøÂÖçÁ≤æÂ∫¶ÈóÆÈ¢ò
                        dataType: 'json',
                        success: function(res) {
                            if (res.code === 2000) {
                                loadTree();
                                alert('Âà†Èô§ÊàêÂäü');
                                if (currentContext.id === contextId || String(currentContext.id) === String(contextId)) {
                                    currentContext.id = null;
                                    currentContext.hasConfig = false;
                                    $('#titleSection').hide();
                                    $('#addTitleSection').hide();
                                    $('#welcomeSection').show();
                                }
                            } else {
                                alert(res.message || 'Âà†Èô§Â§±Ë¥•');
                            }
                        },
                        error: function(xhr) {
                            let errorMsg = error.message || 'Âà†Èô§Â§±Ë¥•';
                            if (xhr.responseJSON) {
                                // ÂêéÁ´ØËøîÂõûÊ†ºÂºè: { code: xxx, msg: "ÈîôËØØ‰ø°ÊÅØ", data: null }
                                errorMsg = xhr.responseJSON.msg || xhr.responseJSON.message || errorMsg;
                            } else if (xhr.responseText) {
                                try {
                                    const res = JSON.parse(xhr.responseText);
                                    errorMsg = res.msg || res.message || errorMsg;
                                } catch (e) {
                                    if (xhr.responseText.includes('Â≠òÂú®ÈÖçÁΩÆ')) {
                                        errorMsg = xhr.responseText.match(/Â≠òÂú®ÈÖçÁΩÆ[^<]*/)?.[0] || errorMsg;
                                    }
                                }
                            }
                            alert(errorMsg);
                        }
                    });
                }
            });
    }

    // ÁªëÂÆöÊåâÈíÆ‰∫ã‰ª∂
    $(document).ready(function() {
        $('#btnAddContext').on('click', openAddContextModal);

        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
        $('#addContextModal').on('click', function(e) {
            if ($(e.target).hasClass('modal-overlay')) {
                closeAddContextModal();
            }
        });

        // ÁÇπÂáªÁºñËæëÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
        $('#editContextModal').on('click', function(e) {
            if ($(e.target).hasClass('modal-overlay')) {
                closeEditContextModal();
            }
        });

        // Âè≥ÈîÆËèúÂçï‰∫ã‰ª∂Â§ÑÁêÜ
        // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÊó∂ÈöêËóèÂè≥ÈîÆËèúÂçï
        $(document).on('click', function(e) {
            if (!$(e.target).closest('#contextMenu').length && !$(e.target).closest('.context-item').length) {
                $('#contextMenu').hide();
            }
        });

        // Âè≥ÈîÆËèúÂçïÁºñËæëÈÄâÈ°π
        $('#contextMenuEdit').on('click', function(e) {
            e.stopPropagation();
            $('#contextMenu').hide();
            if (currentContext.id) {
                openEditContextModal(currentContext.id);
            } else {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™‰∏ä‰∏ãÊñáËäÇÁÇπ');
            }
        });

        // Âè≥ÈîÆËèúÂçïÂà†Èô§ÈÄâÈ°π
        $('#contextMenuDelete').on('click', function(e) {
            e.stopPropagation();
            $('#contextMenu').hide();
            if (currentContext.id) {
                const $selected = $('#contextTree .context-item.active');
                // Ëé∑ÂèñËäÇÁÇπÂêçÁß∞Ôºö‰ºòÂÖà‰ªédataÂ±ûÊÄßËé∑ÂèñÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ªéspanÊñáÊú¨Ëé∑Âèñ
                const contextName = $selected.data('nodeName') ||
                                    $selected.find('span').not('.context-toggle').first().text().trim() ||
                                    $selected.text().replace(/‚ñ∂|üìã/g, '').trim();
                deleteContext(currentContext.id, contextName || '‰∏ä‰∏ãÊñá');
            }
        });

        // ÈÄâÊã©Áà∂Á∫ß‰∏ä‰∏ãÊñáÊó∂Ëá™Âä®Êõ¥Êñ∞Ë∑ØÂæÑÈ¢ÑËßà
        $('#contextParentId').on('change', function() {
            updatePathPreview();
        });

        // ËæìÂÖ•ËäÇÁÇπÂêçÁß∞Êó∂Ëá™Âä®Êõ¥Êñ∞Ë∑ØÂæÑÈ¢ÑËßà
        $('#nodeName').on('input', function() {
            // Âè™ÂÖÅËÆ∏ËæìÂÖ•Ëã±Êñá„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫ø
            const value = $(this).val();
            const cleaned = value.replace(/[^A-Za-z0-9_]/g, '');
            if (value !== cleaned) {
                $(this).val(cleaned);
            }
            updatePathPreview();
        });

        // ÁºñËæëÊ®°ÊÄÅÊ°ÜÔºöËæìÂÖ•ËäÇÁÇπÂêçÁß∞Êó∂Ëá™Âä®Êõ¥Êñ∞Ë∑ØÂæÑÈ¢ÑËßà
        $('#editNodeName').on('input', function() {
            // Âè™ÂÖÅËÆ∏ËæìÂÖ•Ëã±Êñá„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫ø
            const value = $(this).val();
            const cleaned = value.replace(/[^A-Za-z0-9_]/g, '');
            if (value !== cleaned) {
                $(this).val(cleaned);
            }
            updateEditPathPreview();
        });
    });

    // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÁ°Æ‰øùÊåâÈíÆÂèØËßÅ
    $(document).ready(function() {
        ensureLogoutButtonVisible();
        setActiveNavItem();

        // Âª∂ËøüÂÜçÊ¨°Ê£ÄÊü•ÔºåÁ°Æ‰øùÊ∏≤ÊüìÂÆåÊàê
        setTimeout(ensureLogoutButtonVisible, 100);
        setTimeout(ensureLogoutButtonVisible, 500);
    });

    // ÁôªÂá∫ÂäüËÉΩ
    $('#logoutBtn').on('click', function() {
        if (confirm('Á°ÆÂÆöË¶ÅÁôªÂá∫ÂêóÔºü')) {
            $.ajax({
                url: '/api/blbb/auth/logout',
                type: 'POST',
                success: function() {
                    window.location.href = '/blbb/login';
                },
                error: function() {
                    alert('ÁôªÂá∫Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
                }
            });
        }
    });

    // ÂàùÂßãÂä†ËΩΩ - Á°Æ‰øùÂú®DOMÂíåÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜÂô®ÂàùÂßãÂåñ‰πãÂêéÊâßË°å
    $(document).ready(function() {
        // Á≠âÂæÖÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜÂô®ÂàùÂßãÂåñÂÆåÊàê
        function waitForGlobalErrorHandler(maxAttempts) {
            maxAttempts = maxAttempts || 20; // ÊúÄÂ§öÂ∞ùËØï20Ê¨°ÔºåÊØèÊ¨°50msÔºåÊÄªÂÖ±ÊúÄÂ§ö1Áßí
            var attempts = 0;

            function check() {
                attempts++;
                // Ê£ÄÊü•ÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜÂô®ÊòØÂê¶Â∑≤ÂàùÂßãÂåñ
                if (window.__GlobalErrorHandlerInitialized) {
                    // ÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜÂô®Â∑≤ÂàùÂßãÂåñÔºåÂèØ‰ª•ÂÆâÂÖ®Ë∞ÉÁî® loadTree
                    console.log('[blbb-editor] ÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜÂô®Â∑≤Â∞±Áª™ÔºåÂºÄÂßãÂä†ËΩΩÊ†ë');
                    loadTree();
                } else if (attempts < maxAttempts) {
                    // Â¶ÇÊûúÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜÂô®ËøòÊ≤°ÂàùÂßãÂåñÔºåÂÜçÁ≠â‰∏ÄÊÆµÊó∂Èó¥
                    console.log('[blbb-editor] Á≠âÂæÖÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜÂô®ÂàùÂßãÂåñ... (' + attempts + '/' + maxAttempts + ')');
                    setTimeout(check, 50);
                } else {
                    // Ë∂ÖÊó∂Ôºå‰ªçÁÑ∂Â∞ùËØïÂä†ËΩΩÔºàÂèØËÉΩËÑöÊú¨Âä†ËΩΩÂ§±Ë¥•Ôºâ
                    console.warn('[blbb-editor] Á≠âÂæÖÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜÂô®Ë∂ÖÊó∂ÔºåÁªßÁª≠Âä†ËΩΩÊ†ë');
                    loadTree();
                }
            }

            check();
        }

        // Âª∂Ëøü‰∏Ä‰∏ãÔºåÁ°Æ‰øùËÑöÊú¨Â∑≤Âä†ËΩΩ
        setTimeout(function() {
            waitForGlobalErrorHandler();
        }, 100);
    });
</script>
</body>
</html>
