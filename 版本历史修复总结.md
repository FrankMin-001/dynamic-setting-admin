# ç‰ˆæœ¬å†å²è®°å½•åŠŸèƒ½ä¿®å¤æ€»ç»“

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

æ£€æŸ¥ `blbb_config_data` è¡¨çš„æ¯æ¬¡æ”¹åŠ¨æ˜¯å¦éƒ½åœ¨ `blbb_version_history` è¡¨ä¸­æ­£ç¡®è®°å½•ã€‚

## ğŸ” å‘ç°çš„é—®é¢˜

### é—®é¢˜1: `toggleActive` æ–¹æ³•ç¼ºå°‘ç‰ˆæœ¬å†å²è®°å½• âŒ
**ä½ç½®**: `BlbbConfigDataServiceImpl.toggleActive()`

**é—®é¢˜æè¿°**:
- æ¿€æ´»/ç¦ç”¨é…ç½®æ•°æ®æ—¶ï¼Œä¿®æ”¹äº† `isActive` å­—æ®µ
- ä½†æ²¡æœ‰è®°å½•åˆ°ç‰ˆæœ¬å†å²è¡¨ä¸­
- å¯¼è‡´éƒ¨åˆ†æ•°æ®å˜æ›´æ— æ³•è¿½æº¯

### é—®é¢˜2: `updateData` æ–¹æ³•ä¿å­˜çš„æ•°æ®å¿«ç…§ä¸æ­£ç¡® âš ï¸
**ä½ç½®**: `BlbbConfigDataServiceImpl.updateData()`

**é—®é¢˜æè¿°**:
- åœ¨è®°å½•ç‰ˆæœ¬å†å²æ—¶ï¼Œ`changeData` å­—æ®µä¿å­˜çš„æ˜¯æ–°æ•°æ®ï¼ˆ`rowData`ï¼‰
- æ ¹æ®å­—æ®µæ³¨é‡Š "å˜æ›´æ•°æ®å¿«ç…§(è®°å½•æ‰€æœ‰çš„å†…å®¹)"ï¼Œåº”è¯¥ä¿å­˜å˜æ›´å‰çš„å®Œæ•´æ•°æ®å¿«ç…§
- è¿™æ ·æ‰èƒ½åœ¨å†å²è®°å½•ä¸­çœ‹åˆ°å˜æ›´å‰çš„å®Œæ•´çŠ¶æ€

### é—®é¢˜3: `insertData` æ–¹æ³•æ•°æ®å¿«ç…§ä¸å®Œæ•´ âš ï¸
**ä½ç½®**: `BlbbConfigDataServiceImpl.insertData()`

**é—®é¢˜æè¿°**:
- åªä¿å­˜äº† `rowData` å­—æ®µï¼Œæ²¡æœ‰ä¿å­˜å®Œæ•´çš„æ•°æ®å¿«ç…§
- ä¸ºäº†ä¿æŒä¸€è‡´æ€§ï¼Œåº”è¯¥ä¿å­˜å®Œæ•´çš„æ•°æ®å¿«ç…§

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: ä¸º `toggleActive` æ·»åŠ ç‰ˆæœ¬å†å²è®°å½•

**ä¿®å¤å†…å®¹**:
```java
// ä¿®å¤å‰ï¼šåªæœ‰ç®€å•çš„æ›´æ–°æ“ä½œ
configDataDO.setIsActive(isActive);
blbbConfigDataMapper.updateById(configDataDO);

// ä¿®å¤åï¼šæ·»åŠ ç‰ˆæœ¬å†å²è®°å½•
// ä¿å­˜å˜æ›´å‰çš„å®Œæ•´æ•°æ®å¿«ç…§
String oldDataSnapshot = JSONUtil.toJsonStr(configDataDO);

// è®°å½•ç‰ˆæœ¬å†å²
blbbVersionHistoryService.record(
    configDataIdLong,
    String.valueOf(configDataDO.getVersion()),
    String.valueOf(configDataDO.getVersion() + 1),
    "UPDATE",
    isActive ? "æ¿€æ´»é…ç½®æ•°æ®" : "ç¦ç”¨é…ç½®æ•°æ®",
    oldDataSnapshot,
    operatedBy
);

// æ›´æ–°æ•°æ®ï¼ˆåŒ…æ‹¬ç‰ˆæœ¬å·é€’å¢ï¼‰
configDataDO.setIsActive(isActive);
configDataDO.setVersion(configDataDO.getVersion() + 1);
blbbConfigDataMapper.updateById(configDataDO);
```

### ä¿®å¤2: ä¿®å¤ `updateData` æ–¹æ³•çš„æ•°æ®å¿«ç…§

**ä¿®å¤å†…å®¹**:
```java
// ä¿®å¤å‰ï¼šä¿å­˜çš„æ˜¯æ–°æ•°æ®
blbbVersionHistoryService.record(
    ...
    rowData,  // âŒ è¿™æ˜¯æ–°æ•°æ®
    ...
);

// ä¿®å¤åï¼šä¿å­˜å˜æ›´å‰çš„å®Œæ•´æ•°æ®å¿«ç…§
String oldDataSnapshot = JSONUtil.toJsonStr(configDataDO);
blbbVersionHistoryService.record(
    ...
    oldDataSnapshot,  // âœ… è¿™æ˜¯å˜æ›´å‰çš„å®Œæ•´æ•°æ®
    ...
);
```

### ä¿®å¤3: ä¼˜åŒ– `insertData` æ–¹æ³•çš„æ•°æ®å¿«ç…§

**ä¿®å¤å†…å®¹**:
```java
// ä¿®å¤å‰ï¼šåªä¿å­˜ rowData
blbbVersionHistoryService.record(
    ...
    configDataDO.getRowData(),  // âŒ åªä¿å­˜äº† rowData
    ...
);

// ä¿®å¤åï¼šä¿å­˜å®Œæ•´çš„æ•°æ®å¿«ç…§
String dataSnapshot = JSONUtil.toJsonStr(configDataDO);
blbbVersionHistoryService.record(
    ...
    dataSnapshot,  // âœ… ä¿å­˜å®Œæ•´çš„æ•°æ®å¿«ç…§
    ...
);
```

## ğŸ“Š ä¿®å¤åçš„æ“ä½œè¦†ç›–æƒ…å†µ

| æ“ä½œç±»å‹ | æ–¹æ³•å | ç‰ˆæœ¬å†å²è®°å½• | çŠ¶æ€ |
|---------|--------|------------|------|
| åˆ›å»ºæ•°æ® | `insertData()` | âœ… CREATE | å·²ä¼˜åŒ– |
| æ›´æ–°æ•°æ® | `updateData()` | âœ… UPDATE | å·²ä¿®å¤ |
| åˆ é™¤æ•°æ® | `deleteData()` | âœ… DELETE | å·²æ­£å¸¸ |
| æ¿€æ´»/ç¦ç”¨ | `toggleActive()` | âœ… UPDATE | å·²ä¿®å¤ |

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### ä½¿ç”¨çš„å·¥å…·ç±»
- `cn.hutool.json.JSONUtil`: ç”¨äºå°†å¯¹è±¡åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²
- `com.smalldragon.yml.context.UserContext`: è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
- `BlbbVersionHistoryService.record()`: è®°å½•ç‰ˆæœ¬å†å²çš„æ ‡å‡†æ–¹æ³•

### ç‰ˆæœ¬å·ç®¡ç†
- CREATE: æ–°åˆ›å»ºçš„æ•°æ®ç‰ˆæœ¬å·ä¸º 1
- UPDATE: æ¯æ¬¡æ›´æ–°ç‰ˆæœ¬å· +1
- DELETE: è®°å½•åˆ é™¤å‰çš„ç‰ˆæœ¬å·ï¼Œæ–°ç‰ˆæœ¬å·ä¸º null
- toggleActive: ä¹Ÿä½œä¸º UPDATE æ“ä½œï¼Œç‰ˆæœ¬å· +1

### æ•°æ®å¿«ç…§æ ¼å¼
æ‰€æœ‰å˜æ›´è®°å½•éƒ½ä¿å­˜å®Œæ•´çš„ JSON æ•°æ®å¿«ç…§ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š
- `id`: ä¸»é”®ID
- `titleId`: å…³è”çš„æ ‡é¢˜ID
- `templateType`: æ¨¡æ¿ç±»å‹
- `rowData`: è¡Œæ•°æ®
- `displayOrder`: æ˜¾ç¤ºé¡ºåº
- `isActive`: æ˜¯å¦æ¿€æ´»
- `version`: ç‰ˆæœ¬å·
- `createdBy`: åˆ›å»ºäºº

## âœ… éªŒè¯æ£€æŸ¥æ¸…å•

- [x] `insertData` æ–¹æ³•æ­£ç¡®è®°å½• CREATE å†å²
- [x] `updateData` æ–¹æ³•æ­£ç¡®è®°å½• UPDATE å†å²ï¼ˆä¿å­˜å˜æ›´å‰æ•°æ®ï¼‰
- [x] `deleteData` æ–¹æ³•æ­£ç¡®è®°å½• DELETE å†å²
- [x] `toggleActive` æ–¹æ³•æ­£ç¡®è®°å½• UPDATE å†å²
- [x] æ‰€æœ‰æ“ä½œéƒ½åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
- [x] ç‰ˆæœ¬å·æ­£ç¡®é€’å¢
- [x] æ“ä½œäººä¿¡æ¯æ­£ç¡®è®°å½•
- [x] å˜æ›´æè¿°æ¸…æ™°æ˜ç¡®

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **äº‹åŠ¡ä¿è¯**: æ‰€æœ‰æ•°æ®ä¿®æ”¹æ“ä½œéƒ½ä½¿ç”¨ `@Transactional` æ³¨è§£ï¼Œç¡®ä¿ç‰ˆæœ¬å†å²è®°å½•å’Œæ•°æ®ä¿®æ”¹åœ¨åŒä¸€äº‹åŠ¡ä¸­å®Œæˆ
2. **ç‰ˆæœ¬å·ç®¡ç†**: æ¯æ¬¡ UPDATE æ“ä½œï¼ˆåŒ…æ‹¬ toggleActiveï¼‰éƒ½ä¼šé€’å¢ç‰ˆæœ¬å·ï¼Œä¿æŒç‰ˆæœ¬å·çš„è¿ç»­æ€§
3. **æ•°æ®å®Œæ•´æ€§**: æ‰€æœ‰å˜æ›´è®°å½•éƒ½ä¿å­˜å®Œæ•´çš„æ•°æ®å¿«ç…§ï¼Œæ–¹ä¾¿åç»­è¿½æº¯å’Œæ¢å¤
4. **å‘åå…¼å®¹**: ä¿®å¤ä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼Œåªæ˜¯å¢å¼ºäº†ç‰ˆæœ¬å†å²è®°å½•çš„å®Œæ•´æ€§

## ğŸ¯ ä¿®å¤æ•ˆæœ

ä¿®å¤åï¼Œ`blbb_config_data` è¡¨çš„**æ¯æ¬¡æ”¹åŠ¨**ï¼ˆåŒ…æ‹¬æ¿€æ´»/ç¦ç”¨ï¼‰éƒ½ä¼šåœ¨ `blbb_version_history` è¡¨ä¸­**å®Œæ•´è®°å½•**ï¼ŒåŒ…æ‹¬ï¼š
- å˜æ›´ç±»å‹ï¼ˆCREATE/UPDATE/DELETEï¼‰
- ç‰ˆæœ¬å·å˜åŒ–ï¼ˆoldVersion -> newVersionï¼‰
- å˜æ›´æè¿°
- å®Œæ•´çš„æ•°æ®å¿«ç…§
- æ“ä½œäººå’Œæ“ä½œæ—¶é—´

---

**ä¿®å¤æ—¥æœŸ**: 2025-11-03
**ä¿®å¤äººå‘˜**: Auto (AI Assistant)
**æ–‡ä»¶ä¿®æ”¹**: 
- `yml-system/yml-system-biz/src/main/java/com/smalldragon/yml/system/service/configdata/Impl/BlbbConfigDataServiceImpl.java`

